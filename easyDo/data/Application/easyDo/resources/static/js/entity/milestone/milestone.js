function initMstLine(mstData){if(mstData||(mstData=$("#mstData").val()),mstData){mstData=eval("("+mstData+")");var isTemplete=mstData.isTemplete,isShowPhase=mstData.isShowPhase,data=mstData.data,mileId=mstData.id,version=mstData.version,isPublish=mstData.isPublish;$("#mileId").val(mileId);var html="";if(data&&data.length){$(".mile-box, .mile-table-box").show(),$(".noData").hide(),packageMileLine(data,version,!0);var $mileTableBox=$(".mile-table-box"),hasEditPerm=$("#btn_EDIT").val(),hasDelPerm=$("#btn_DEL").val();hasEditPerm=!(!hasEditPerm||"Y"!=hasEditPerm),hasDelPerm=!(!hasDelPerm||"Y"!=hasDelPerm);var isView=$("#isView").val();if(isView&&"Y"==isView&&(hasEditPerm=!1,hasDelPerm=!1),$mileTableBox&&$mileTableBox.length){if(html="<table>",html+='<tr class="head">',html+='\t<td class="col1">序号</td>',isShowPhase&&"Y"==isShowPhase&&(html+='\t<td class="col2">阶段</td>'),html+='\t<td class="col3">里程碑</td>',html+='\t<td class="col4">计划完成日期</td>',isTemplete&&"Y"==isTemplete?html+='\t<td class="col6">备注</td>':(html+='\t<td class="col4">实际完成日期</td>',html+='\t<td class="col5">偏差天数</td>',html+='\t<td class="col5">偏差率</td>',html+='\t<td class="col5">完成率</td>'),(hasEditPerm||hasDelPerm)&&(html+='\t<td class="col5 operate-col">操作</td>'),html+="</tr>",$mileTableBox&&$mileTableBox.length)for(var i=0;i<data.length;i++)trData=data[i],html+='<tr class="body" id="'+trData.id+'" phaseId="'+trData.phaseId+'">',html+='\t<td class="col1">'+(i+1)+"</td>",isShowPhase&&"Y"==isShowPhase&&trData.rowspan&&(html+='\t<td class="col2" rowspan="'+trData.rowspan+'">'+trData.phaseName+"</td>"),html+='\t<td class="col3 mileName cp help-'+i+'" attrcalss="help-'+i+'" attrtip="">'+trData.name+"</td>",html+='\t<td class="col4">'+trData.planEndDate+"</td>",isTemplete&&"Y"==isTemplete?html+='\t<td class="col6">'+trData.remark+"</td>":(html+='\t<td class="col4">'+trData.realEndDate+"</td>",html+='\t<td class="col5">'+trData.devDays+"</td>",html+='\t<td class="col5">'+trData.devRate+"</td>",html+='\t<td class="col5">'+trData.copRate+"</td>"),(hasEditPerm||hasDelPerm)&&(html+='\t<td class="col5 operate-col">',hasEditPerm&&(html+='\t\t<span class="link-btn" onclick="editMile(\''+trData.id+"', $(this))\">编辑</span>"),hasDelPerm&&(html+='\t\t<span class="link-btn ml5" onclick="delMile(\''+trData.id+"', $(this))\">删除</span>"),html+="\t</td>"),html+="</tr>";$mileTableBox.html(html)}isPublish&&"Y"==isPublish?($("#addMile, #publishMile, .operate-col").addClass("hide"),$("#stopMile, #changeMile").removeClass("hide")):($("#addMile, #publishMile, .operate-col").removeClass("hide"),$("#stopMile, #changeMile").addClass("hide"))}else $(".noData").show(),$(".mile-box, .mile-table-box").hide()}$(".mile-table-box .body").click((function(){$(".mile-table-box .body").removeClass("selected"),$(this).addClass("selected")}));var tipIndex=0;$(".mileName").hover((function(){var that=$(this),tipContent=that.attr("attrTip");tipContent?tipIndex=layer.tips(tipContent,"."+that.attr("attrCalss"),{tips:[2,"rgb(242, 242, 242)","#666"]}):$.ajax({url:"/task/getTasksByMilestoneId",type:"post",data:{milestoneId:that.closest("tr").attr("id")},success:function(data){if(data&&(data=eval("("+data+")"),data.length)){tipContent='<div class="tip-box">',tipContent+='\t\t<div class="header"><div class="col1">任务名称</div><div class="col2">计划完成日期</div><div class="col2">实际完成日期</div><div class="col3">完成率</div></div>',tipContent+='\t\t<div class="body">';for(var i=0;i<data.length;i++)tipContent+='\t\t<div class="tr"><div class="col1">'+data[i].name+'</div><div class="col2">'+data[i].planEndDate+'</div><div class="col2">'+data[i].realEndDate+'</div><div class="col3">'+data[i].copRate+"</div></div>";tipContent+="\t\t</div>",tipContent+="</div>",that.attr("attrTip",tipContent),tipIndex=layer.tips(tipContent,"."+that.attr("attrCalss"),{tips:[2,"rgb(242, 242, 242)","#666"]})}}})}),(function(){tipIndex&&layer.close(tipIndex)}))}function packageMileLine(t,a,e){var l="",i="",s=$(".mile-box");if(s&&s.length){if(l+='<div class="time-line-box">',l+='\t<div class="time-line">',l+='\t\t<div class="line"></div>',l+='\t\t<div class="end-arrow"></div>',l+='\t\t<div class="start-circle"></div>',l+="\t</div>",l+='\t<ul class="mile-line">',t)for(var d=0;d<t.length;d++)l+='<li class="item" style="width:'+(i=t[d]).width+'">',l+='\t<div class="cop-line"></div>',l+='\t<div class="curDate"><i class="fa fa-caret-up"></i></div>',l+='\t<div class="mile">',l+='\t\t<div class="name" title="'+i.name+'">'+i.name+"</div>",l+='\t\t<div class="icon-box">',l+='\t\t\t<div class="icons">',l+='\t\t\t\t<div class="icon"></div>',l+="\t\t\t</div>",l+="\t\t</div>",l+='\t\t<div class="info">',l+='\t\t\t<div class="status">'+i.statusName+"</div>",l+='\t\t\t<div class="date">'+i.planEndDate+"</div>",l+="\t\t</div>",l+="\t</div>",l+="</li>";l+="\t</ul>",l+='\t<div class="mile-version" onclick="milestoneHisVersion()">'+(a||"")+"</div>",l+="</div>",e?s.html(l):s.append(l)}}function addMiles(){var t=$(".mile-table-box .body.selected");top.layer.open({type:2,title:"新建里程碑",maxmin:!0,shadeClose:!1,area:["830px","600px"],content:"/type/addOrEditMile/null?objectId="+$("#objectId").val()+"&objectType="+$("#objectType").val()+"&preId="+t.attr("id")+"&phaseId="+t.attr("phaseId")+"&mileId="+$("#mileId").val()+"&parentname="+window.name,end:function(t,a){t&&reLoadMilestone(t)}})}function editMile(t,a){top.layer.open({type:2,title:"编辑里程碑",maxmin:!0,shadeClose:!1,area:["830px","600px"],content:"/type/addOrEditMile/"+t+"?objectId="+$("#objectId").val()+"&objectType="+$("#objectType").val()+"&preId=&phaseId=&parentname="+window.name,end:function(t,a){t&&reLoadMilestone(t)}})}function delMile(t,a){var e=top.layer.confirm("确定删除该里程碑？",{btn:["确定","取消"]},(function(){$.ajax({url:"/type/deleteMstNode",type:"post",data:{id:t},success:function(t){0==t.code?(reLoadMilestone(),top.layer.close(e),parent.layer.msg(t.msg)):(top.layer.close(e),parent.layer.msg(t.msg,1))}})}))}function reLoadMilestone(){$.ajax({cache:!0,type:"POST",url:"/type/mstData",data:{objectId:$("#objectId").val(),objectType:$("#objectType").val(),isTemplete:$("#isTemplete").val()},async:!1,success:function(t){initMstLine(t)}})}