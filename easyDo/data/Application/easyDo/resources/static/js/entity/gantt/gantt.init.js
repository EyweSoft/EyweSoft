import{Toolbar,Toast,DateHelper,CSSHelper,Column,ColumnStore,TaskModel,Gantt}from"/js/entity/gantt/gantt.main.js";class GanttToolbar extends Toolbar{static get type(){return"gantttoolbar"}static get $name(){return"GanttToolbar"}static get configurable(){return{items:[{type:"buttonGroup",items:[{color:"b-green",ref:"addTaskButton",icon:"b-fa b-fa-plus",text:"新建",tooltip:"创建新任务",onAction:"up.onAddTaskClick"}]},{ref:"undoRedo",type:"undoredo",items:{transactionsCombo:null}},{type:"datefield",ref:"startDateField",label:"项目开始",flex:"0 0 18em",listeners:{change:"up.onStartDateChange"}}]}}updateParent(t,e){super.updateParent(t,e),this.gantt=t;t.project.on({load:"updateStartDateField",refresh:"updateStartDateField",thisObj:this}),globalThis.isInitLoad=!0,this.styleNode=document.createElement("style"),document.head.appendChild(this.styleNode)}setAnimationDuration(t){const e=this,a=`.b-animating .b-gantt-task-wrap { transition-duration: ${t/1e3}s !important; }`;e.gantt.transitionDuration=t,e.transitionRule?e.transitionRule.cssText=a:e.transitionRule=CSSHelper.insertRule(a)}updateStartDateField(){const{startDateField:t}=this.widgetMap;t.value=this.gantt.project.startDate,t.required=!1}async onAddTaskClick(){var t=new Date,e=new Date;t.setHours(0),t.setMinutes(0),t.setSeconds(0),e.setHours(0),e.setMinutes(0),e.setSeconds(0);const{gantt:a}=this,n=a.taskStore.rootNode.appendChild({name:"新建任务",startDate:t,endDate:e});await a.project.commitAsync(),await a.scrollRowIntoView(n),a.features.cellEdit.startEditing({record:n,field:"name"})}onEditTaskClick(){const{gantt:t}=this;t.selectedRecord?t.editTask(t.selectedRecord):Toast.show(this.L("首先选择要编辑的任务"))}onExpandAllClick(){this.gantt.expandAll()}onCollapseAllClick(){this.gantt.collapseAll()}onZoomInClick(){this.gantt.zoomIn()}onZoomOutClick(){this.gantt.zoomOut()}onZoomToFitClick(){this.gantt.zoomToFit({leftMargin:50,rightMargin:50})}onShiftPreviousClick(){this.gantt.shiftPrevious()}onShiftNextClick(){this.gantt.shiftNext()}onStartDateChange({value:t,oldValue:e}){t&&(this.gantt.scrollToDate(DateHelper.add(t,-1,"week"),{block:"start"}),this.gantt.project.setStartDate(t))}onProjectSelected({record:t}){this.gantt.project.load(t.url)}onFilterChange({value:t}){""===t?this.gantt.taskStore.clearFilters():(t=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),this.gantt.taskStore.filter({filters:e=>e.name&&e.name.match(new RegExp(t,"i")),replace:!0}))}onFeaturesClick({source:t}){const{gantt:e}=this;if(t.feature){const a=e.features[t.feature];a.disabled=!a.disabled}else if(t.subGrid){const a=e.subGrids[t.subGrid];a.collapsed=!a.collapsed}else t.toggleConfig&&(e[t.toggleConfig]=t.checked)}onFeaturesShow({source:t}){const{gantt:e}=this;t.items.map((t=>{const{feature:a}=t;a?e.features[a]?t.checked=!e.features[a].disabled:t.hide():t.subGrid&&(t.checked=e.subGrids[t.subGrid].collapsed)}))}onSettingsShow({source:t}){const{gantt:e}=this,{rowHeight:a,barMargin:n,duration:s,radius:o}=t.widgetMap;a.value=e.rowHeight,n.value=e.barMargin,n.max=e.rowHeight/2-5,s.value=e.transitionDuration,o.value=e.features.dependencies.radius??0}onRowHeightChange({value:t,source:e}){this.gantt.rowHeight=t,e.owner.widgetMap.barMargin.max=t/2-5}onBarMarginChange({value:t}){this.gantt.barMargin=t}onAnimationDurationChange({value:t}){this.gantt.transitionDuration=t,this.styleNode.innerHTML=`.b-animating .b-gantt-task-wrap { transition-duration: ${t/1e3}s !important; }`}onDependencyRadiusChange({value:t}){this.gantt.features.dependencies.radius=t}onCriticalPathsClick({source:t}){this.gantt.features.criticalPaths.disabled=!t.pressed}}GanttToolbar.initClass();class StatusColumn extends Column{static get $name(){return"StatusColumn"}static get type(){return"status"}static get isGanttColumn(){return!0}static get defaults(){return{field:"status",text:"状态",editor:!1,cellCls:"b-status-column-cell",htmlEncode:!1,filterable:{filterField:{type:"combo",items:["未发布","未启动","进行中","已完成"]}}}}renderer({record:t}){const e=t.status;return e?[{tag:"i",className:`${e}`},e]:""}}ColumnStore.registerColumnType(StatusColumn);class Task extends TaskModel{static $name="Task";static get fields(){return[{name:"status",type:"string"}]}get isLate(){return!this.isCompleted&&this.deadlineDate&&Date.now()>this.deadlineDate}get status(){let t=this.statusId,e="未发布";return t&&("07698511-fa9f-47e2-9f4c-5fbstatus002"==t?e="未启动":"07698511-fa9f-47e2-9f4c-5fbstatus003"==t?e="进行中":"07698511-fa9f-47e2-9f4c-5fbstatus004"==t?e="待审核":"07698511-fa9f-47e2-9f4c-5fbstatus005"==t?e="未通过":"07698511-fa9f-47e2-9f4c-5fbstatus006"==t?e="通过":"07698511-fa9f-47e2-9f4c-5fbstatus007"==t?e="关闭":"07698511-fa9f-47e2-9f4c-5fbstatus008"==t?e="暂停":"07698511-fa9f-47e2-9f4c-5fbstatus009"==t&&(e="强制终止")),e}get duration(){let t=this.getEndDate(),e=this.getStartDate(),a=!1;this.originalData.hasOwnProperty("isMilestone")&&(a=this.originalData.isMilestone);let n=0;return t&&e&&!a?(t.setHours(23,59,59,0),n=Math.ceil((t-e)/864e5),globalThis.isResizing):a&&e&&t&&(e.getTime(),t.getTime()),n}set duration(t){}}var ganttView=$("#ganttView").val();ganttView&&(ganttView=eval("("+ganttView+")"));const gantt=new Gantt({appendTo:"container",dependencyIdField:"wbsCode",zoomOnMouseWheel:!1,zoomOnTimeAxisDoubleClick:!1,selectionMode:{cell:!0,dragSelect:!0,rowNumber:!0},project:{taskModelClass:Task,transport:{load:{url:"/plan/getPlanTaskList?planId="+$("#planId").val()}},autoLoad:!0,taskStore:{wbsMode:"auto"},stm:{autoRecord:!0},resetUndoRedoQueuesAfterLoad:!0},startDate:"",endDate:"",resourceImageFolderPath:"",scrollTaskIntoViewOnCellClick:!0,rowHeight:45,barMargin:12,columns:ganttView,subGridConfigs:{locked:{flex:3},normal:{flex:4}},columnLines:!1,features:{baselines:{disabled:!0},criticalPaths:{disabled:!0},dependencyEdit:!0,filter:!1,sort:!1,labels:{left:{field:"name",editor:{type:"textfield"}}},parentArea:{disabled:!0},progressLine:{disabled:!0,statusDate:new Date(2019,0,25)},rollups:{disabled:!0},rowReorder:{showGrip:!0},projectLines:{disabled:!0},timeRanges:{showCurrentTimeLine:!0},fillHandle:!0,cellCopyPaste:!0,taskCopyPaste:{allowNativeClipboard:!0}},tbar:{type:"gantttoolbar"}});gantt.project.on("load",(function(t){loadPlan($("#planId").val())}));const taskStore=gantt.taskStore;taskStore.on("change",(({source:t,action:e,records:a,changes:n})=>{if("update"===e){const e=a[0].isProjectModel;a[0].isPhantom;isNewTask||t.isRemoving||e||n.hasOwnProperty("wbsValue")||n.hasOwnProperty("segments")||n.hasOwnProperty("percentDone")||n.hasOwnProperty("totalSlack")||a.forEach((t=>{const e=getNewTaskId(t.id);let a="";if(globalThis.isRowSorting&&n.parentIndex){if(a=n.parentIndex.value<n.parentIndex.oldValue?"PREV":"NEXT",t.nextOrderedSibling){var s=getNewTaskId(t.nextOrderedSibling.id);n.nextTaskId=s}if(t.previousOrderedSibling){var o=getNewTaskId(t.previousOrderedSibling.id);n.preTaskId=o}}let i={id:e,sortType:a,planId:$("#planId").val(),...n};const r=JSON.stringify(i,(function(t,e){if("string"==typeof e)return e;if(e&&e.hasOwnProperty("value")){if(!e.value)return"";if("string"==typeof e.value||"number"==typeof e.value)return e.value;if(e.value instanceof Date)return e.value.toLocaleString();if(e.value.hasOwnProperty("id"))return e.value.id}return e}));fetch("/plan/saveTasks",{method:"POST",headers:{"Content-Type":"application/json"},body:r}).then((t=>{})).catch((t=>{}))}))}else"add"===e&&(isNewTask=!1)}));var isNewTask=!1;function reloadTaskList(t){globalThis.ganttInit.project.load("/plan/getPlanTaskList?planId="+t)}function isAllowEdit(t){var e=$("#btn_EDITTSK").val();return!(!e||"Y"!=e)&&("07698511-fa9f-47e2-9f4c-5fbstatus004"!=t&&"07698511-fa9f-47e2-9f4c-5fbstatus005"!=t&&"07698511-fa9f-47e2-9f4c-5fbstatus006"!=t&&"07698511-fa9f-47e2-9f4c-5fbstatus007"!=t&&"07698511-fa9f-47e2-9f4c-5fbstatus008"!=t&&"07698511-fa9f-47e2-9f4c-5fbstatus009"!=t)}function saveHeaderColumnInfo(){var t=[],e=null;gantt.columns.records.forEach((a=>{let n=a.type;n||(n=a.field);const s=a.width,o=a.readOnly,i=a.format;e={},n&&"rownumber"!=n&&"timeAxis"!=n&&"addnew"!=n&&a.isVisible&&(e.type=n,s&&(e.width=s),o&&(e.readOnly=o),i&&(e.format=i),t.push(e))})),t.push({type:"addnew"}),fetch("/plan/saveHeaderColumn",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then((t=>{})).catch((t=>{}))}function getNewTaskId(t){return t?t.length>36&&(t=t.substring(t.length-36)):t="",t}taskStore.on("beforeadd",(({records:t})=>{const e=t[0];if(e){const t=e.isPhantom;e.hasOwnProperty("isPhantom")&&!t&&(isNewTask=!0)}})),taskStore.on("add",(({records:t,context:e,event:a})=>{globalThis.isExpandOrCollapse||globalThis.isRowSorting||(globalThis.isExpandOrCollapse=!1,t.forEach((t=>{const e=getNewTaskId(t.id);var a=t._data,n=a.startDate,s=a.endDate;n&&(n=n.toLocaleString()),s&&(s=s.toLocaleString());let o="";t.previousSibling&&(o=getNewTaskId(t.previousSibling.id));let i={id:e,name:a.name,startDate:n,endDate:s,planId:$("#planId").val(),isTemplate:$("#isTemplate").val(),belongId:$("#objectId").val(),belongType:$("#objectType").val(),preTaskId:o,parentId:a.parentId?a.parentId:""};const r=JSON.stringify(i,(function(t,e){if("string"==typeof e)return e;if(e&&e.hasOwnProperty("value")&&e.value){if("string"==typeof e.value||"number"==typeof e.value)return e.value;if(e.value instanceof Date)return e.value.toLocaleString();if(e.value.hasOwnProperty("id"))return e.value.id}return e}));fetch("/plan/saveTasks",{method:"POST",headers:{"Content-Type":"application/json"},body:r}).then((t=>{})).catch((t=>{}))})))})),taskStore.on("indent",(({records:t,context:e,event:a})=>{t.forEach((t=>{let e={id:getNewTaskId(t.id),parentId:getNewTaskId(t.parentId)};fetch("/plan/saveTasksIndentOrOutdent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then((t=>{})).catch((t=>{}))}))})),taskStore.on("outdent",(({records:t,context:e,event:a})=>{t.forEach((t=>{let e={id:getNewTaskId(t.id),parentId:getNewTaskId(t.parentId)};fetch("/plan/saveTasksIndentOrOutdent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then((t=>{})).catch((t=>{}))}))})),gantt.taskStore.on("beforeRemove",(function(t){globalThis.isRemoveTask=!0;let e=!0;return t.records.forEach((t=>{t.isNode&&"Y"==t.isNode&&(e=!1)})),!0})),taskStore.on("remove",(({records:t,context:e,event:a})=>{if(!globalThis.isExpandOrCollapse&&!globalThis.isRowSorting){globalThis.isExpandOrCollapse=!1;var n="";t.forEach((t=>{const e=getNewTaskId(t.id);n?n+=","+e:n=e}));const e={taskIds:n,planId:$("#planId").val()};fetch("/plan/deleteTasks",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then((t=>{})).catch((t=>{}))}})),gantt.dependencyStore.on("change",(({source:t,action:e,records:a,changes:n})=>{if(e&&a&&a.length){let t=[];var s=$("#planId").val();a.forEach((e=>{if(e.from&&e.to){const a=getNewTaskId(e.from),n=getNewTaskId(e.to);t.push({planId:s,fromId:a,toId:n,type:e.type})}})),"add"==e||"update"==e?n&&!n.hasOwnProperty("type")||fetch("/plan/linkTasks",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then((t=>{})).catch((t=>{})):"remove"==e&&(globalThis.isRemoveTask?globalThis.isRemoveTask=!1:fetch("/plan/unlinkTasks",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then((t=>{})).catch((t=>{})))}})),gantt.columns.on("change",(({record:t,changes:e})=>{t&&"timeAxis"==t.type||e&&e.hidden&&saveHeaderColumnInfo()})),gantt.columns.on("add",(({record:t,changes:e})=>{saveHeaderColumnInfo()})),gantt.on("beforeCellEditStart",(function(t){var e=t.editorContext.record,a=e.statusId;if(a&&!isAllowEdit(a))return!1;if(e.isMilestone||e.isNode&&"Y"==e.isNode){var n=t.editorContext.editor.name;if(n&&(e.isMilestone&&"endDate"==n||"Y"==e.isNode&&"startDate"==n))return!1}})),globalThis.ganttInit=gantt,globalThis.ganttTool=GanttToolbar.registeredInstances[1],$("#addTaskBtn").click((function(){globalThis.ganttTool.onAddTaskClick()})),$("#searchName").change((function(){const t={value:$(this).val()};globalThis.ganttTool.onFilterChange(t)})),globalThis.undoRedoTool=GanttToolbar.registeredInstances[4],$("#undoBtn").click((function(){globalThis.undoRedoTool.onUndo()})),$("#redoBtn").click((function(){globalThis.undoRedoTool.onRedo()}));