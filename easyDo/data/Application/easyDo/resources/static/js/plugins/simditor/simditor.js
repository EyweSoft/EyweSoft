!function(t,e){"function"==typeof define&&define.amd?define("simditor",["jquery","simple-module","simple-hotkeys","simple-uploader"],(function(r,i,o,n){return t.returnExportsGlobal=e(r,i,o,n)})):"object"==typeof exports?module.exports=e(require("jquery"),require("simple-module"),require("simple-hotkeys"),require("simple-uploader")):t.Simditor=e(jQuery,SimpleModule,simple.hotkeys,simple.uploader)}(this,(function(t,e,r,i){var o,n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};o=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return s(r,e),r.pluginName="Selection",r.prototype._init=function(){return this.editor=this._module,this.sel=document.getSelection()},r.prototype.clear=function(){try{return this.sel.removeAllRanges()}catch(t){t}},r.prototype.getRange=function(){return this.editor.inputManager.focused&&this.sel.rangeCount?this.sel.getRangeAt(0):null},r.prototype.selectRange=function(t){return this.clear(),this.sel.addRange(t),this.editor.inputManager.focused||!this.editor.util.browser.firefox&&!this.editor.util.browser.msie||this.editor.body.focus(),t},r.prototype.rangeAtEndOf=function(e,r){var i,o,n;if(null==r&&(r=this.getRange()),null!=r&&r.collapsed)return e=t(e)[0],i=r.endContainer,o=this.editor.util.getNodeLength(i),!!(r.endOffset===o-1&&t(i).contents().last().is("br")||r.endOffset===o)&&(e===i||!!t.contains(e,i)&&(n=!0,t(i).parentsUntil(e).addBack().each((function(e,r){var i;if(!((i=t(r).parent().contents().filter((function(){return!(this!==r&&3===this.nodeType&&!this.nodeValue)})).last()).get(0)===r||i.is("br")&&i.prev().get(0)===r))return n=!1,!1})),n))},r.prototype.rangeAtStartOf=function(e,r){var i,o;if(null==r&&(r=this.getRange()),null!=r&&r.collapsed)return e=t(e)[0],o=r.startContainer,0===r.startOffset&&(e===o||!!t.contains(e,o)&&(i=!0,t(o).parentsUntil(e).addBack().each((function(e,r){if(t(r).parent().contents().filter((function(){return!(this!==r&&3===this.nodeType&&!this.nodeValue)})).first().get(0)!==r)return i=!1})),i))},r.prototype.insertNode=function(e,r){if(null==r&&(r=this.getRange()),null!=r)return e=t(e)[0],r.insertNode(e),this.setRangeAfter(e,r)},r.prototype.setRangeAfter=function(e,r){if(null==r&&(r=this.getRange()),null!=r)return e=t(e)[0],r.setEndAfter(e),r.collapse(!1),this.selectRange(r)},r.prototype.setRangeBefore=function(e,r){if(null==r&&(r=this.getRange()),null!=r)return e=t(e)[0],r.setEndBefore(e),r.collapse(!1),this.selectRange(r)},r.prototype.setRangeAtStartOf=function(e,r){return null==r&&(r=this.getRange()),e=t(e).get(0),r.setEnd(e,0),r.collapse(!1),this.selectRange(r)},r.prototype.setRangeAtEndOf=function(e,r){var i,o,n,s,a,l;return null==r&&(r=this.getRange()),e=(o=t(e)).get(0),o.is("pre")?(n=o.contents()).length>0?"\n"===(a=(s=n.last()).text()).charAt(a.length-1)?r.setEnd(s[0],this.editor.util.getNodeLength(s[0])-1):r.setEnd(s[0],this.editor.util.getNodeLength(s[0])):r.setEnd(e,0):(l=this.editor.util.getNodeLength(e),3!==e.nodeType&&l>0&&((i=t(e).contents().last()).is("br")?l-=1:3!==i[0].nodeType&&this.editor.util.isEmptyNode(i)&&(i.append(this.editor.util.phBr),e=i[0],l=0)),r.setEnd(e,l)),r.collapse(!1),this.selectRange(r)},r.prototype.deleteRangeContents=function(t){var e,r;return null==t&&(t=this.getRange()),r=t.cloneRange(),e=t.cloneRange(),r.collapse(!0),e.collapse(!1),!t.collapsed&&this.rangeAtStartOf(this.editor.body,r)&&this.rangeAtEndOf(this.editor.body,e)?(this.editor.body.empty(),t.setStart(this.editor.body[0],0),t.collapse(!0),this.selectRange(t)):t.deleteContents(),t},r.prototype.breakBlockEl=function(e,r){var i;return null==r&&(r=this.getRange()),i=t(e),r.collapsed?(r.setStartBefore(i.get(0)),r.collapsed?i:i.before(r.extractContents())):i},r.prototype.save=function(e){var r,i,o;if(null==e&&(e=this.getRange()),!this._selectionSaved)return(i=e.cloneRange()).collapse(!1),o=t("<span/>").addClass("simditor-caret-start"),r=t("<span/>").addClass("simditor-caret-end"),i.insertNode(r[0]),e.insertNode(o[0]),this.clear(),this._selectionSaved=!0},r.prototype.restore=function(){var t,e,r,i,o,n,s;return!!this._selectionSaved&&(o=this.editor.body.find(".simditor-caret-start"),t=this.editor.body.find(".simditor-caret-end"),o.length&&t.length?(s=(n=o.parent()).contents().index(o),r=(e=t.parent()).contents().index(t),n[0]===e[0]&&(r-=1),(i=document.createRange()).setStart(n.get(0),s),i.setEnd(e.get(0),r),o.remove(),t.remove(),this.selectRange(i)):(o.remove(),t.remove()),this._selectionSaved=!1,i)},r}(e);n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};var a,l=[].indexOf||function(t){for(var e=0,r=this.length;e<r;e++)if(e in this&&this[e]===t)return e;return-1};a=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return s(r,e),r.pluginName="Formatter",r.prototype._init=function(){return this.editor=this._module,this._allowedTags=["br","a","img","b","strong","i","u","font","p","ul","ol","li","blockquote","pre","h1","h2","h3","h4","hr"],this._allowedAttributes={img:["src","alt","width","height","data-image-src","data-image-size","data-image-name","data-non-image"],a:["href","target"],font:["color"],pre:["data-lang","class"],p:["data-indent"],h1:["data-indent"],h2:["data-indent"],h3:["data-indent"],h4:["data-indent"]},this.editor.body.on("click","a",(function(t){return!1}))},r.prototype.decorate=function(t){return null==t&&(t=this.editor.body),this.editor.trigger("decorate",[t])},r.prototype.undecorate=function(e){return null==e&&(e=this.editor.body.clone()),this.editor.trigger("undecorate",[e]),t.trim(e.html())},r.prototype.autolink=function(e){var r,i,o,n,s,a,l,u,d,p,c;for(null==e&&(e=this.editor.body),n=[],i=function(r){return r.contents().each((function(r,o){var s,a;if(!(s=t(o)).is("a")&&!s.closest("a, pre",e).length)return s.contents().length?i(s):(a=s.text())&&/https?:\/\/|www\./gi.test(a)?n.push(s):void 0}))},i(e),a=/(https?:\/\/|www\.)[\w\-\.\?&=\/#%:,@\!\+]+/gi,p=0,c=n.length;p<c;p++){for(u=(r=n[p]).text(),l=[],s=null,o=0;null!==(s=a.exec(u));)l.push(document.createTextNode(u.substring(o,s.index))),o=a.lastIndex,d=/^(http(s)?:\/\/|\/)/.test(s[0])?s[0]:"http://"+s[0],l.push(t('<a href="'+d+'" rel="nofollow"></a>').text(s[0])[0]);l.push(document.createTextNode(u.substring(o))),r.replaceWith(t(l))}return e},r.prototype.format=function(e){var r,i,o,n,s,a,l,u,d,p;if(null==e&&(e=this.editor.body),e.is(":empty"))return e.append("<p>"+this.editor.util.phBr+"</p>"),e;for(s=0,l=(d=e.contents()).length;s<l;s++)o=d[s],this.cleanNode(o,!0);for(a=0,u=(p=e.contents()).length;a<u;a++)n=p[a],(r=t(n)).is("br")?(null!=i&&(i=null),r.remove()):this.editor.util.isBlockNode(n)?r.is("li")?i&&i.is("ul, ol")?i.append(n):(i=t("<ul/>").insertBefore(n)).append(n):i=null:(i&&!i.is("ul, ol")||(i=t("<p/>").insertBefore(n)),i.append(n));return e},r.prototype.cleanNode=function(e,r){var i,o,n,s,a,u,d,p,c,h,f,g,m,v,y,_,b;if((o=t(e)).length>0){if(3!==o[0].nodeType){if(d=o.contents(),p=o.is('[class^="simditor-"]'),o.is(this._allowedTags.join(","))||p){if(o.is("a")&&(i=o.find("img")).length>0&&(o.replaceWith(i),o=i,d=null),o.is("img")&&o.hasClass("uploading")&&o.remove(),!p)for(a=this._allowedAttributes[o[0].tagName.toLowerCase()],g=0,v=(_=t.makeArray(o[0].attributes)).length;g<v;g++)u=_[g],null!=a&&(b=u.name,l.call(a,b)>=0)||o.removeAttr(u.name)}else 1!==o[0].nodeType||o.is(":empty")?(o.remove(),d=null):o.is("div, article, dl, header, footer, tr")?(o.append("<br/>"),d.first().unwrap()):o.is("table")?(n=t("<p/>"),o.find("tr").each((function(e,r){return n.append(t(r).text()+"<br/>")})),o.replaceWith(n),d=null):o.is("thead, tfoot")?(o.remove(),d=null):o.is("th")?(s=t("<td/>").append(o.contents()),o.replaceWith(s)):d.first().unwrap();if(r&&null!=d&&!o.is("pre"))for(m=0,y=d.length;m<y;m++)c=d[m],this.cleanNode(c,!0);return null}(h=o.text().replace(/(\r\n|\n|\r)/gm,""))?(f=document.createTextNode(h),o.replaceWith(f)):o.remove()}},r.prototype.clearHtml=function(e,r){var i,o,n,s;return null==r&&(r=!0),i=t("<div/>").append(e),o=i.contents(),n="",o.each((s=this,function(e,i){var a,l;return 3===i.nodeType?n+=i.nodeValue:1===i.nodeType&&((l=(a=t(i)).contents()).length>0&&(n+=s.clearHtml(l)),r&&e<o.length-1&&a.is("br, p, div, li, tr, pre, address, artticle, aside, dl, figcaption, footer, h1, h2, h3, h4, header"))?n+="\n":void 0})),n},r.prototype.beautify=function(e){var r;return r=function(t){return!!(t.is("p")&&!t.text()&&t.children(":not(br)").length<1)},e.each((function(e,i){var o;return(o=t(i)).is(':not(img, br, col, td, hr, [class^="simditor-"]):empty')&&o.remove(),r(o)&&o.remove(),o.find(':not(img, br, col, td, hr, [class^="simditor-"]):empty').remove()}))},r}(e);var u;n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},l=[].indexOf||function(t){for(var e=0,r=this.length;e<r;e++)if(e in this&&this[e]===t)return e;return-1};u=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return s(i,e),i.pluginName="InputManager",i.prototype.opts={pasteImage:!1},i.prototype._modifierKeys=[16,17,18,91,93,224],i.prototype._arrowKeys=[37,38,39,40],i.prototype._init=function(){var e,i;if(this.editor=this._module,this.opts.pasteImage&&"string"!=typeof this.opts.pasteImage&&(this.opts.pasteImage="inline"),this._keystrokeHandlers={},this.hotkeys=r({el:this.editor.body}),this._pasteArea=t("<div/>").css({width:"1px",height:"1px",overflow:"hidden",position:"fixed",right:"0",bottom:"100px"}).attr({tabIndex:"-1",contentEditable:!0}).addClass("simditor-paste-area").appendTo(this.editor.el),this._cleanPasteArea=t("<textarea/>").css({width:"1px",height:"1px",overflow:"hidden",position:"fixed",right:"0",bottom:"101px"}).attr({tabIndex:"-1"}).addClass("simditor-clean-paste-area").appendTo(this.editor.el),t(document).on("selectionchange.simditor"+this.editor.id,(i=this,function(t){if(i.focused)return i._selectionTimer&&(clearTimeout(i._selectionTimer),i._selectionTimer=null),i._selectionTimer=setTimeout((function(){return i.editor.trigger("selectionchanged")}),20)})),this.editor.on("valuechanged",function(e){return function(){if(!e.editor.util.closestBlockEl()&&e.focused&&(e.editor.selection.save(),e.editor.formatter.format(),e.editor.selection.restore()),e.editor.body.find("hr, pre, .simditor-table").each((function(r,i){var o,n;if(((o=t(i)).parent().is("blockquote")||o.parent()[0]===e.editor.body[0])&&(n=!1,0===o.next().length&&(t("<p/>").append(e.editor.util.phBr).insertAfter(o),n=!0),0===o.prev().length&&(t("<p/>").append(e.editor.util.phBr).insertBefore(o),n=!0),n))return setTimeout((function(){return e.editor.trigger("valuechanged")}),10)})),e.editor.body.find("pre:empty").append(e.editor.util.phBr),!e.editor.util.supportSelectionChange&&e.focused)return e.editor.trigger("selectionchanged")}}(this)),this.editor.on("selectionchanged",function(t){return function(e){return t.editor.undoManager.update()}}(this)),this.editor.body.on("keydown",t.proxy(this._onKeyDown,this)).on("keypress",t.proxy(this._onKeyPress,this)).on("keyup",t.proxy(this._onKeyUp,this)).on("mouseup",t.proxy(this._onMouseUp,this)).on("focus",t.proxy(this._onFocus,this)).on("blur",t.proxy(this._onBlur,this)).on("paste",t.proxy(this._onPaste,this)).on("drop",t.proxy(this._onDrop,this)),this.editor.util.browser.firefox&&(this.addShortcut("cmd+left",function(t){return function(e){return e.preventDefault(),t.editor.selection.sel.modify("move","backward","lineboundary"),!1}}(this)),this.addShortcut("cmd+right",function(t){return function(e){return e.preventDefault(),t.editor.selection.sel.modify("move","forward","lineboundary"),!1}}(this)),this.addShortcut("cmd+a",function(t){return function(e){var r,i,o,n;if((r=t.editor.body.children()).length>0)return i=r.first().get(0),o=r.last().get(0),(n=document.createRange()).setStart(i,0),n.setEnd(o,t.editor.util.getNodeLength(o)),t.editor.selection.selectRange(n),!1}}(this))),e=this.editor.util.os.mac?"cmd+enter":"ctrl+enter",this.addShortcut(e,function(t){return function(e){return t.editor.el.closest("form").find("button:submit").click(),!1}}(this)),this.editor.textarea.attr("autofocus"))return setTimeout(function(t){return function(){return t.editor.focus()}}(this),0)},i.prototype._onFocus=function(t){return this.editor.el.addClass("focus").removeClass("error"),this.focused=!0,this.lastCaretPosition=null,setTimeout((e=this,function(){return e.editor.triggerHandler("focus"),e.editor.trigger("selectionchanged")}),0);var e},i.prototype._onBlur=function(t){var e;return this.editor.el.removeClass("focus"),this.editor.sync(),this.focused=!1,this.lastCaretPosition=null!=(e=this.editor.undoManager.currentState())?e.caret:void 0,this.editor.triggerHandler("blur")},i.prototype._onMouseUp=function(t){if(!this.editor.util.supportSelectionChange)return setTimeout((e=this,function(){return e.editor.trigger("selectionchanged")}),0);var e},i.prototype._onKeyDown=function(e){var r,i,o,n,s,a;if(!1===this.editor.triggerHandler(e))return!1;if(!this.hotkeys.respondTo(e)){if(e.which in this._keystrokeHandlers){if(o="function"==typeof(n=this._keystrokeHandlers[e.which])["*"]?n["*"](e):void 0)return this.editor.trigger("valuechanged"),!1;if(this.editor.util.traverseUp((u=this,function(r){var i,n;if(1===r.nodeType)return i=null!=(n=u._keystrokeHandlers[e.which])?n[r.tagName.toLowerCase()]:void 0,!0!==(o="function"==typeof i?i(e,t(r)):void 0)&&!1!==o&&void 0})),o)return this.editor.trigger("valuechanged"),!1}var u;if(!(s=e.which,l.call(this._modifierKeys,s)>=0||(a=e.which,l.call(this._arrowKeys,a)>=0)||(i=this.editor.util.metaKey(e),r=this.editor.util.closestBlockEl(),i&&86===e.which)))return this.editor.util.browser.webkit&&8===e.which&&this.editor.selection.rangeAtStartOf(r)?(setTimeout(function(t){return function(){var e;if(t.focused)return e=t.editor.util.closestBlockEl(),t.editor.selection.save(),t.editor.formatter.cleanNode(e,!0),t.editor.selection.restore(),t.editor.trigger("valuechanged")}}(this),10),this.typing=!0):this._typing?(!0!==this._typing&&clearTimeout(this._typing),this._typing=setTimeout(function(t){return function(){return t.editor.trigger("valuechanged"),t._typing=!1}}(this),200)):(setTimeout(function(t){return function(){return t.editor.trigger("valuechanged")}}(this),10),this._typing=!0),null}},i.prototype._onKeyPress=function(t){if(!1===this.editor.triggerHandler(t))return!1},i.prototype._onKeyUp=function(e){var r,i;if(!1===this.editor.triggerHandler(e))return!1;!this.editor.util.supportSelectionChange&&(i=e.which,l.call(this._arrowKeys,i)>=0)?this.editor.trigger("selectionchanged"):8!==e.which&&46!==e.which||!this.editor.util.isEmptyNode(this.editor.body)||(this.editor.body.empty(),r=t("<p/>").append(this.editor.util.phBr).appendTo(this.editor.body),this.editor.selection.setRangeAtStartOf(r))},i.prototype._onPaste=function(e){var r,i,o,n,s,a,l,u;if(!1===this.editor.triggerHandler(e))return!1;if((s=this.editor.selection.deleteRangeContents()).collapsed||s.collapse(!0),r=this.editor.util.closestBlockEl(),i=r.is("pre, table"),e.originalEvent.clipboardData&&e.originalEvent.clipboardData.items&&e.originalEvent.clipboardData.items.length>0&&(n=e.originalEvent.clipboardData.items[0],/^image\//.test(n.type)&&!i)){if(null==(o=n.getAsFile())||!this.opts.pasteImage)return;return o.name||(o.name="Clipboard Image.png"),(a={})[this.opts.pasteImage]=!0,null!=(l=this.editor.uploader)&&l.upload(o,a),!1}return this.editor.selection.save(s),i?(this._cleanPasteArea.focus(),this.editor.util.browser.firefox?(e.preventDefault(),this._cleanPasteArea.val(e.originalEvent.clipboardData.getData("text/plain"))):this.editor.util.browser.msie&&10===this.editor.util.browser.version&&(e.preventDefault(),this._cleanPasteArea.val(window.clipboardData.getData("Text")))):(this._pasteArea.focus(),this.editor.util.browser.msie&&10===this.editor.util.browser.version&&(e.preventDefault(),this._pasteArea.html(window.clipboardData.getData("Text")))),setTimeout((u=this,function(){var e,o,n,l,d,p,c,h,f,g,m,v,y,_,b,w,x,T,C,k,A,E;if(u._pasteArea.is(":empty")&&!u._cleanPasteArea.val()?f=null:i?f=u._cleanPasteArea.val():((f=t("<div/>").append(u._pasteArea.contents())).find("table colgroup").remove(),u.editor.formatter.format(f),u.editor.formatter.decorate(f),u.editor.formatter.beautify(f.children()),f=f.contents()),u._pasteArea.empty(),u._cleanPasteArea.val(""),s=u.editor.selection.restore(),!1!==u.editor.triggerHandler("pasting",[f])&&f){if(i)if(r.is("table")){for(d=(c=f.split("\n")).pop(),g=0,_=c.length;g<_;g++)p=c[g],u.editor.selection.insertNode(document.createTextNode(p)),u.editor.selection.insertNode(t("<br/>"));u.editor.selection.insertNode(document.createTextNode(d))}else for(m=0,b=(k=(f=t("<div/>").text(f)).contents()).length;m<b;m++)h=k[m],u.editor.selection.insertNode(t(h)[0],s);else if(r.is(u.editor.body))for(v=0,w=f.length;v<w;v++)h=f[v],u.editor.selection.insertNode(h,s);else{if(f.length<1)return;if(1===f.length)if(f.is("p")){if(1===(n=f.contents()).length&&n.is("img")){if(/^data:image/.test((e=n).attr("src"))){if(!u.opts.pasteImage)return;return(o=u.editor.util.dataURLtoBlob(e.attr("src"))).name="Clipboard Image.png",(a={})[u.opts.pasteImage]=!0,void(null!=(A=u.editor.uploader)&&A.upload(o,a))}if(e.is('img[src^="webkit-fake-url://"]'))return}for(y=0,x=n.length;y<x;y++)h=n[y],u.editor.selection.insertNode(h,s)}else if(r.is("p")&&u.editor.util.isEmptyNode(r))r.replaceWith(f),u.editor.selection.setRangeAtEndOf(f,s);else if(f.is("ul, ol"))if(1===f.find("li").length)for(C=0,T=(E=(f=t("<div/>").text(f.text())).contents()).length;C<T;C++)h=E[C],u.editor.selection.insertNode(t(h)[0],s);else r.is("li")?(r.parent().after(f),u.editor.selection.setRangeAtEndOf(f,s)):(r.after(f),u.editor.selection.setRangeAtEndOf(f,s));else r.after(f),u.editor.selection.setRangeAtEndOf(f,s);else r.is("li")&&(r=r.parent()),u.editor.selection.rangeAtStartOf(r,s)?l="before":u.editor.selection.rangeAtEndOf(r,s)?l="after":(u.editor.selection.breakBlockEl(r,s),l="before"),r[l](f),u.editor.selection.setRangeAtEndOf(f.last(),s)}return u.editor.trigger("valuechanged")}}),10)},i.prototype._onDrop=function(t){return!1!==this.editor.triggerHandler(t)&&setTimeout((e=this,function(){return e.editor.trigger("valuechanged")}),0);var e},i.prototype.addKeystrokeHandler=function(t,e,r){return this._keystrokeHandlers[t]||(this._keystrokeHandlers[t]={}),this._keystrokeHandlers[t][e]=r},i.prototype.addShortcut=function(e,r){return this.hotkeys.add(e,t.proxy(r,this))},i}(e);var d;n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};d=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return s(r,e),r.pluginName="Keystroke",r.prototype._init=function(){var e,r;return this.editor=this._module,this.editor.util.browser.safari&&this.editor.inputManager.addKeystrokeHandler("13","*",(r=this,function(e){var i,o;if(e.shiftKey&&!(i=r.editor.util.closestBlockEl()).is("pre"))return o=t("<br/>"),r.editor.selection.rangeAtEndOf(i)?(r.editor.selection.insertNode(o),r.editor.selection.insertNode(t("<br/>")),r.editor.selection.setRangeBefore(o)):r.editor.selection.insertNode(o),!0})),(this.editor.util.browser.webkit||this.editor.util.browser.msie)&&(e=function(e){return function(r,i){var o;if(e.editor.selection.rangeAtEndOf(i))return o=t("<p/>").append(e.editor.util.phBr).insertAfter(i),e.editor.selection.setRangeAtStartOf(o),!0}}(this),this.editor.inputManager.addKeystrokeHandler("13","h1",e),this.editor.inputManager.addKeystrokeHandler("13","h2",e),this.editor.inputManager.addKeystrokeHandler("13","h3",e),this.editor.inputManager.addKeystrokeHandler("13","h4",e),this.editor.inputManager.addKeystrokeHandler("13","h5",e),this.editor.inputManager.addKeystrokeHandler("13","h6",e)),this.editor.inputManager.addKeystrokeHandler("8","*",function(t){return function(e){var r,i;if((r=(i=t.editor.util.furthestBlockEl()).prev()).is("hr")&&t.editor.selection.rangeAtStartOf(i))return t.editor.selection.save(),r.remove(),t.editor.selection.restore(),!0}}(this)),this.editor.inputManager.addKeystrokeHandler("9","*",function(t){return function(e){var r;if(r=t.editor.toolbar.findButton("code"),t.editor.opts.tabIndent||r&&r.active)return e.shiftKey?t.editor.util.outdent():t.editor.util.indent(),!0}}(this)),this.editor.inputManager.addKeystrokeHandler("13","li",function(e){return function(r,i){var o,n,s,a;if((o=i.clone()).find("ul, ol").remove(),e.editor.util.isEmptyNode(o)&&i.is(e.editor.util.closestBlockEl())){if(n=i.parent(),i.next("li").length>0){if(!e.editor.util.isEmptyNode(i))return;n.parent("li").length>0?(s=t("<li/>").append(e.editor.util.phBr).insertAfter(n.parent("li")),a=t("<"+n[0].tagName+"/>").append(i.nextAll("li")),s.append(a)):(s=t("<p/>").append(e.editor.util.phBr).insertAfter(n),a=t("<"+n[0].tagName+"/>").append(i.nextAll("li")),s.after(a))}else n.parent("li").length>0?(s=t("<li/>").insertAfter(n.parent("li")),i.contents().length>0?s.append(i.contents()):s.append(e.editor.util.phBr)):(s=t("<p/>").append(e.editor.util.phBr).insertAfter(n),i.children("ul, ol").length>0&&s.after(i.children("ul, ol")));return i.prev("li").length?i.remove():n.remove(),e.editor.selection.setRangeAtStartOf(s),!0}}}(this)),this.editor.inputManager.addKeystrokeHandler("13","pre",function(e){return function(r,i){var o,n,s;return r.preventDefault(),r.shiftKey?(o=t("<p/>").append(e.editor.util.phBr).insertAfter(i),e.editor.selection.setRangeAtStartOf(o),!0):(n=null,(s=e.editor.selection.getRange()).deleteContents(),!e.editor.util.browser.msie&&e.editor.selection.rangeAtEndOf(i)?(n=document.createTextNode("\n\n"),s.insertNode(n),s.setEnd(n,1)):(n=document.createTextNode("\n"),s.insertNode(n),s.setStartAfter(n)),s.collapse(!1),e.editor.selection.selectRange(s),!0)}}(this)),this.editor.inputManager.addKeystrokeHandler("13","blockquote",function(t){return function(e,r){var i,o;if((i=t.editor.util.closestBlockEl()).is("p")&&!i.next().length&&t.editor.util.isEmptyNode(i))return r.after(i),o=document.createRange(),t.editor.selection.setRangeAtStartOf(i,o),!0}}(this)),this.editor.inputManager.addKeystrokeHandler("8","li",function(e){return function(r,i){var o,n,s,a,l,u,d,p;return n=i.children("ul, ol"),l=i.prev("li"),n.length>0&&l.length>0&&(p="",u=null,i.contents().each((function(e,r){return(1!==r.nodeType||!/UL|OL/.test(r.nodeName))&&(1===r.nodeType&&/BR/.test(r.nodeName)?void 0:(3===r.nodeType&&r.nodeValue?p+=r.nodeValue:1===r.nodeType&&(p+=t(r).text()),u=t(r)))})),u&&1===p.length&&e.editor.util.browser.firefox&&!u.next("br").length?(o=t(e.editor.util.phBr).insertAfter(u),u.remove(),e.editor.selection.setRangeBefore(o),!0):!(p.length>0)&&(d=document.createRange(),(a=l.children("ul, ol")).length>0?(s=t("<li/>").append(e.editor.util.phBr).appendTo(a),a.append(n.children("li")),i.remove(),e.editor.selection.setRangeAtEndOf(s,d)):(e.editor.selection.setRangeAtEndOf(l,d),l.append(n),i.remove(),e.editor.selection.selectRange(d)),!0))}}(this)),this.editor.inputManager.addKeystrokeHandler("8","pre",function(e){return function(r,i){var o,n,s;if(e.editor.selection.rangeAtStartOf(i))return n=i.html().replace("\n","<br/>"),o=t("<p/>").append(n||e.editor.util.phBr).insertAfter(i),i.remove(),s=document.createRange(),e.editor.selection.setRangeAtStartOf(o,s),!0}}(this)),this.editor.inputManager.addKeystrokeHandler("8","blockquote",function(t){return function(e,r){var i,o;if(t.editor.selection.rangeAtStartOf(r))return i=r.children().first().unwrap(),o=document.createRange(),t.editor.selection.setRangeAtStartOf(i,o),!0}}(this))},r}(e);var p;n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};p=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return s(r,e),r.pluginName="UndoManager",r.prototype._index=-1,r.prototype._capacity=50,r.prototype._timer=null,r.prototype._init=function(){var t,e,r;return this.editor=this._module,this._stack=[],this.editor.util.os.mac?(e="cmd+z",t="shift+cmd+z"):this.editor.util.os.win?(e="ctrl+z",t="ctrl+y"):(e="ctrl+z",t="shift+ctrl+z"),this.editor.inputManager.addShortcut(e,(r=this,function(t){return t.preventDefault(),r.undo(),!1})),this.editor.inputManager.addShortcut(t,function(t){return function(e){return e.preventDefault(),t.redo(),!1}}(this)),this.editor.on("valuechanged",function(t){return function(e,r){if("undo"!==r)return t._timer&&(clearTimeout(t._timer),t._timer=null),t._timer=setTimeout((function(){return t._pushUndoState(),t._timer=null}),200)}}(this))},r.prototype._pushUndoState=function(){var t,e;if(!1!==this.editor.triggerHandler("pushundostate")&&(t=this.currentState(),e=this.editor.body.html(),!t||t.html!==e))return this._index+=1,this._stack.length=this._index,this._stack.push({html:e,caret:this.caretPosition()}),this._stack.length>this._capacity?(this._stack.shift(),this._index-=1):void 0},r.prototype.currentState=function(){return this._stack.length&&this._index>-1?this._stack[this._index]:null},r.prototype.undo=function(){var t;if(!(this._index<1||this._stack.length<2))return this.editor.hidePopover(),this._index-=1,t=this._stack[this._index],this.editor.body.html(t.html),this.caretPosition(t.caret),this.editor.body.find(".selected").removeClass("selected"),this.editor.sync(),this.editor.trigger("valuechanged",["undo"])},r.prototype.redo=function(){var t;if(!(this._index<0||this._stack.length<this._index+2))return this.editor.hidePopover(),this._index+=1,t=this._stack[this._index],this.editor.body.html(t.html),this.caretPosition(t.caret),this.editor.body.find(".selected").removeClass("selected"),this.editor.sync(),this.editor.trigger("valuechanged",["undo"])},r.prototype.update=function(){var t,e;if(!this._timer&&(t=this.currentState()))return e=this.editor.body.html(),t.html=e,t.caret=this.caretPosition()},r.prototype._getNodeOffset=function(e,r){var i,o,n;return i=r?t(e):t(e).parent(),n=0,o=!1,i.contents().each((function(t,i){return r!==t&&e!==i&&(3===i.nodeType?o||(n+=1,o=!0):(n+=1,o=!1),null)})),n},r.prototype._getNodePosition=function(t,e){var r,i,o;if(3===t.nodeType)for(i=t.previousSibling;i&&3===i.nodeType;)t=i,e+=this.editor.util.getNodeLength(i),i=i.previousSibling;else e=this._getNodeOffset(t,e);return(r=[]).unshift(e),this.editor.util.traverseUp((o=this,function(t){return r.unshift(o._getNodeOffset(t))}),t),r},r.prototype._getNodeByPosition=function(e){var r,i,o,n,s,a,l,u;for(n=this.editor.body[0],o=a=0,l=(u=e.slice(0,e.length-1)).length;a<l;o=++a){if((s=u[o])>(i=n.childNodes).length-1){if(o!==e.length-2||!t(n).is("pre")){n=null;break}r=document.createTextNode(""),n.appendChild(r),i=n.childNodes}n=i[s]}return n},r.prototype.caretPosition=function(t){var e,r,i,o,n;if(t){if(this.editor.inputManager.focused||this.editor.body.focus(),!t.start)return void this.editor.body.blur();if(o=this._getNodeByPosition(t.start),n=t.start[t.start.length-1],t.collapsed?(e=o,r=n):(e=this._getNodeByPosition(t.end),r=t.start[t.start.length-1]),!o||!e)throw new Error("simditor: invalid caret state");return(i=document.createRange()).setStart(o,n),i.setEnd(e,r),this.editor.selection.selectRange(i)}return i=this.editor.selection.getRange(),this.editor.inputManager.focused&&null!=i?((t={start:[],end:null,collapsed:!0}).start=this._getNodePosition(i.startContainer,i.startOffset),i.collapsed||(t.end=this._getNodePosition(i.endContainer,i.endOffset),t.collapsed=!1),t):{}},r}(e);var c;n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};c=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}var i,o,n,a,l,u,d,p,c,h;return s(r,e),r.pluginName="Util",r.prototype._init=function(){if(this.editor=this._module,this.browser.msie&&this.browser.version<11)return this.phBr=""},r.prototype.phBr="<br/>",r.prototype.os=(i={},/Mac/.test(navigator.appVersion)?i.mac=!0:/Linux/.test(navigator.appVersion)?i.linux=!0:/Win/.test(navigator.appVersion)?i.win=!0:/X11/.test(navigator.appVersion)&&(i.unix=!0),/Mobi/.test(navigator.appVersion)&&(i.mobile=!0),i),r.prototype.browser=(u=navigator.userAgent,a=/(msie|trident)/i.test(u),o=/chrome|crios/i.test(u),l=/safari/i.test(u)&&!o,n=/firefox/i.test(u),a?{msie:!0,version:1*(null!=(d=u.match(/(msie |rv:)(\d+(\.\d+)?)/i))?d[2]:void 0)}:o?{webkit:!0,chrome:!0,version:1*(null!=(p=u.match(/(?:chrome|crios)\/(\d+(\.\d+)?)/i))?p[1]:void 0)}:l?{webkit:!0,safari:!0,version:1*(null!=(c=u.match(/version\/(\d+(\.\d+)?)/i))?c[1]:void 0)}:n?{mozilla:!0,firefox:!0,version:1*(null!=(h=u.match(/firefox\/(\d+(\.\d+)?)/i))?h[1]:void 0)}:{}),r.prototype.supportSelectionChange=function(){var t;if(void 0!==(t=document.onselectionchange))try{return document.onselectionchange=0,null===document.onselectionchange}catch(t){t}finally{document.onselectionchange=t}return!1}(),r.prototype.reflow=function(e){return null==e&&(e=document),t(e)[0].offsetHeight},r.prototype.metaKey=function(t){return/Mac/.test(navigator.userAgent)?t.metaKey:t.ctrlKey},r.prototype.isEmptyNode=function(e){var r;return(r=t(e)).is(":empty")||!r.text()&&!r.find(":not(br, span, div)").length},r.prototype.isBlockNode=function(e){return!(!(e=t(e)[0])||3===e.nodeType)&&/^(div|p|ul|ol|li|blockquote|hr|pre|h1|h2|h3|h4|table)$/.test(e.nodeName.toLowerCase())},r.prototype.closestBlockEl=function(e){var r,i,o,n;return null==e&&(e=null!=(o=this.editor.selection.getRange())?o.commonAncestorContainer:void 0),(r=t(e)).length&&(i=(i=r.parentsUntil(this.editor.body).addBack()).filter((n=this,function(t){return n.isBlockNode(i.eq(t))}))).length?i.last():null},r.prototype.furthestNode=function(e,r){var i,o,n;return null==e&&(e=null!=(n=this.editor.selection.getRange())?n.commonAncestorContainer:void 0),(i=t(e)).length&&(o=(o=i.parentsUntil(this.editor.body).addBack()).filter((function(e){var i;return i=o.eq(e),t.isFunction(r)?r(i):i.is(r)}))).length?o.first():null},r.prototype.furthestBlockEl=function(t){return this.furthestNode(t,this.isBlockNode)},r.prototype.getNodeLength=function(t){switch(t.nodeType){case 7:case 10:return 0;case 3:case 8:return t.length;default:return t.childNodes.length}},r.prototype.traverseUp=function(e,r){var i,o,n,s,a;if(null==r&&(r=null!=(o=this.editor.selection.getRange())?o.commonAncestorContainer:void 0),null==r||!t.contains(this.editor.body[0],r))return!1;for((i=t(r).parentsUntil(this.editor.body).get()).unshift(r),a=[],n=0,s=i.length;n<s&&!1!==e(i[n]);n++)a.push(void 0);return a},r.prototype.indent=function(){var e,r,i,o,n,s,a,l,u,d;if(!((e=this.editor.util.closestBlockEl())&&e.length>0))return!1;if(e.is("pre"))l=document.createTextNode("  "),this.editor.selection.insertNode(l);else if(e.is("li")){if((o=e.prev("li")).length<1)return!1;this.editor.selection.save(),u=e.parent()[0].tagName,(r=o.children("ul, ol")).length>0?r.append(e):t("<"+u+"/>").append(e).appendTo(o),this.editor.selection.restore()}else if(e.is("p, h1, h2, h3, h4"))(s=1*(s=null!=(d=e.attr("data-indent"))?d:0)+1)>10&&(s=10),e.attr("data-indent",s);else if(e.is("table")){if(a=this.editor.selection.getRange(),(i=(n=t(a.commonAncestorContainer).closest("td")).next("td")).length>0||(i=n.parent("tr").next("tr").find("td:first")),!(n.length>0&&i.length>0))return!1;this.editor.selection.setRangeAtEndOf(i)}else l=document.createTextNode("    "),this.editor.selection.insertNode(l);return this.editor.trigger("valuechanged"),!0},r.prototype.outdent=function(){var e,r,i,o,n,s,a,l,u;if(!((e=this.editor.util.closestBlockEl())&&e.length>0))return!1;if(e.is("pre"))return!1;if(e.is("li")){if((i=(r=e.parent()).parent("li")).length<1)return null!=(s=this.editor.toolbar.findButton(r[0].tagName.toLowerCase()))&&s.command(),!1;this.editor.selection.save(),e.next("li").length>0&&t("<"+r[0].tagName+"/>").append(e.nextAll("li")).appendTo(e),e.insertAfter(i),r.children("li").length<1&&r.remove(),this.editor.selection.restore()}else if(e.is("p, h1, h2, h3, h4"))(a=1*(a=null!=(u=e.attr("data-indent"))?u:0)-1)<0&&(a=0),e.attr("data-indent",a);else{if(!e.is("table"))return!1;if(l=this.editor.selection.getRange(),(o=(n=t(l.commonAncestorContainer).closest("td")).prev("td")).length>0||(o=n.parent("tr").prev("tr").find("td:last")),!(n.length>0&&o.length>0))return!1;this.editor.selection.setRangeAtEndOf(o)}return this.editor.trigger("valuechanged"),!0},r.prototype.dataURLtoBlob=function(t){var e,r,i,o,n,s,a,l,u,d,p;if(n=(s=window.Blob&&function(){try{return Boolean(new Blob)}catch(t){return t,!1}}())&&window.Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(t){return t,!1}}(),e=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,!((s||e)&&window.atob&&window.ArrayBuffer&&window.Uint8Array))return!1;for(o=t.split(",")[0].indexOf("base64")>=0?atob(t.split(",")[1]):decodeURIComponent(t.split(",")[1]),r=new ArrayBuffer(o.length),l=new Uint8Array(r),a=d=0,p=o.length;0<=p?d<=p:d>=p;a=0<=p?++d:--d)l[a]=o.charCodeAt(a);return u=t.split(",")[0].split(":")[1].split(";")[0],s?new Blob([n?l:r],{type:u}):((i=new e).append(r),i.getBlob(u))},r}(e);var h;n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};h=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return s(r,e),r.pluginName="Toolbar",r.prototype.opts={toolbar:!0,toolbarFloat:!0,toolbarHidden:!1,toolbarFloatOffset:0},r.prototype._tpl={wrapper:'<div class="simditor-toolbar"><ul></ul></div>',separator:'<li><span class="separator"></span></li>'},r.prototype._init=function(){var e,r;if(this.editor=this._module,this.opts.toolbar)return t.isArray(this.opts.toolbar)||(this.opts.toolbar=["bold","italic","underline","strikethrough","|","ol","ul","blockquote","code","|","link","image","|","indent","outdent"]),this._render(),this.list.on("click",(function(t){return!1})),this.wrapper.on("mousedown",(r=this,function(t){return r.list.find(".menu-on").removeClass(".menu-on")})),t(document).on("mousedown.simditor"+this.editor.id,function(t){return function(e){return t.list.find(".menu-on").removeClass(".menu-on")}}(this)),!this.opts.toolbarHidden&&this.opts.toolbarFloat&&(this.wrapper.width(this.wrapper.outerWidth()),this.wrapper.css("top",this.opts.toolbarFloatOffset),e=this.wrapper.outerHeight(),this.editor.util.os.mobile||t(window).on("resize.simditor-"+this.editor.id,function(t){return function(e){return t.wrapper.css("position","static"),t.editor.util.reflow(t.wrapper),t.wrapper.css("left",t.wrapper.offset().left),t.wrapper.css("position","")}}(this)).resize(),t(window).on("scroll.simditor-"+this.editor.id,function(r){return function(i){var o,n,s;if(o=(s=r.editor.wrapper.offset().top)+r.editor.wrapper.outerHeight()-80,(n=t(document).scrollTop()+r.opts.toolbarFloatOffset)<=s||n>=o){if(r.editor.wrapper.removeClass("toolbar-floating").css("padding-top",""),r.editor.util.os.mobile)return r.wrapper.css("top",r.opts.toolbarFloatOffset)}else if(r.editor.wrapper.addClass("toolbar-floating").css("padding-top",e),r.editor.util.os.mobile)return r.wrapper.css("top",n-s+r.opts.toolbarFloatOffset)}}(this))),this.editor.on("selectionchanged",function(t){return function(){return t.toolbarStatus()}}(this)),this.editor.on("destroy",function(t){return function(){return t.buttons.length=0}}(this)),t(document).on("mousedown.simditor-"+this.editor.id,function(t){return function(e){return t.list.find("li.menu-on").removeClass("menu-on")}}(this))},r.prototype._render=function(){var e,r,i,o;for(this.buttons=[],this.wrapper=t(this._tpl.wrapper).prependTo(this.editor.wrapper),this.list=this.wrapper.find("ul"),r=0,i=(o=this.opts.toolbar).length;r<i;r++)if("|"!==(e=o[r])){if(!this.constructor.buttons[e])throw new Error('simditor: invalid toolbar button "'+e+'"');this.buttons.push(new this.constructor.buttons[e]({editor:this.editor}))}else t(this._tpl.separator).appendTo(this.list);return this.opts.toolbarHidden?this.wrapper.hide():this.editor.placeholderEl.css("top",this.wrapper.outerHeight())},r.prototype.toolbarStatus=function(e){var r;if(this.editor.inputManager.focused)return r=this.buttons.slice(0),this.editor.util.traverseUp((function(i){var o,n,s,a,l,u,d;for(s=[],n=a=0,u=r.length;a<u;n=++a)o=r[n],null!=e&&o.name!==e||o.status&&!0!==o.status(t(i))||s.push(o);for(l=0,d=s.length;l<d;l++)o=s[l],n=t.inArray(o,r),r.splice(n,1);if(0===r.length)return!1}))},r.prototype.findButton=function(t){var e;return null!=(e=this.list.find(".toolbar-item-"+t).data("button"))?e:null},r.addButton=function(t){return this.buttons[t.prototype.name]=t},r.buttons={},r}(e);var f;n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};f=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return s(r,e),r.connect(c),r.connect(u),r.connect(p),r.connect(d),r.connect(a),r.connect(o),r.connect(h),r.count=0,r.prototype.opts={textarea:null,placeholder:"",defaultImage:"images/image.png",params:{},upload:!1,tabIndent:!0},r.prototype._init=function(){var e,o,n,s;if(this.textarea=t(this.opts.textarea),this.opts.placeholder=this.opts.placeholder||this.textarea.attr("placeholder"),!this.textarea.length)throw new Error("simditor: param textarea is required.");if(null!=(e=this.textarea.data("simditor"))&&e.destroy(),this.id=++r.count,this._render(),this.opts.upload&&i&&(n="object"==typeof this.opts.upload?this.opts.upload:{},this.uploader=i(n)),(o=this.textarea.closest("form")).length&&(o.on("submit.simditor-"+this.id,(s=this,function(){return s.sync()})),o.on("reset.simditor-"+this.id,function(t){return function(){return t.setValue("")}}(this))),this.on("initialized",function(t){return function(){return t.opts.placeholder&&t.on("valuechanged",(function(){return t._placeholder()})),t.setValue(t.textarea.val().trim()||"")}}(this)),this.util.browser.mozilla){this.util.reflow();try{return document.execCommand("enableObjectResizing",!1,!1),document.execCommand("enableInlineTableEditing",!1,!1)}catch(t){t}}},r.prototype._tpl='<div class="simditor">\n  <div class="simditor-wrapper">\n    <div class="simditor-placeholder"></div>\n    <div class="simditor-body" contenteditable="true">\n    </div>\n  </div>\n</div>',r.prototype._render=function(){var e,r,i,o;if(this.el=t(this._tpl).insertBefore(this.textarea),this.wrapper=this.el.find(".simditor-wrapper"),this.body=this.wrapper.find(".simditor-body"),this.placeholderEl=this.wrapper.find(".simditor-placeholder").append(this.opts.placeholder),this.el.append(this.textarea).data("simditor",this),this.textarea.data("simditor",this).hide().blur(),this.body.attr("tabindex",this.textarea.attr("tabindex")),this.util.os.mac?this.el.addClass("simditor-mac"):this.util.os.linux&&this.el.addClass("simditor-linux"),this.util.os.mobile&&this.el.addClass("simditor-mobile"),this.opts.params){for(e in o=[],i=this.opts.params)r=i[e],o.push(t("<input/>",{type:"hidden",name:e,value:r}).insertAfter(this.textarea));return o}},r.prototype._placeholder=function(){var t,e;return 0===(t=this.body.children()).length||1===t.length&&this.util.isEmptyNode(t)&&(null!=(e=t.data("indent"))?e:0)<1?this.placeholderEl.show():this.placeholderEl.hide()},r.prototype.setValue=function(t){return this.hidePopover(),this.textarea.val(t),this.body.html(t),this.formatter.format(),this.formatter.decorate(),this.util.reflow(this.body),this.inputManager.lastCaretPosition=null,this.trigger("valuechanged")},r.prototype.getValue=function(){return this.sync()},r.prototype.sync=function(){var e,r,i,o,n,s;for(r=this.body.clone(),this.formatter.undecorate(r),this.formatter.format(r),this.formatter.autolink(r),n=(e=r.children()).last("p"),o=e.first("p");n.is("p")&&this.util.isEmptyNode(n);)i=n,n=n.prev("p"),i.remove();for(;o.is("p")&&this.util.isEmptyNode(o);)i=o,o=n.next("p"),i.remove();return r.find("img.uploading").remove(),s=t.trim(r.html()),this.textarea.val(s),s},r.prototype.focus=function(){var t,e;return this.inputManager.lastCaretPosition?this.undoManager.caretPosition(this.inputManager.lastCaretPosition):(t=this.body.find("p, li, pre, h1, h2, h3, h4, td").first()).length>0?(e=document.createRange(),this.selection.setRangeAtStartOf(t,e),this.body.focus()):void 0},r.prototype.blur=function(){return this.body.blur()},r.prototype.hidePopover=function(){return this.el.find(".simditor-popover").each((function(e,r){if((r=t(r).data("popover")).active)return r.hide()}))},r.prototype.destroy=function(){return this.triggerHandler("destroy"),this.textarea.closest("form").off(".simditor .simditor-"+this.id),this.selection.clear(),this.inputManager.focused=!1,this.textarea.insertBefore(this.el).hide().val("").removeData("simditor"),this.el.remove(),t(document).off(".simditor-"+this.id),t(window).off(".simditor-"+this.id),this.off()},r}(e),f.i18n={"zh-CN":{blockquote:"引用",bold:"加粗文字",code:"插入代码",color:"文字颜色",hr:"分隔线",image:"插入图片",localImage:"本地图片",externalImage:"外链图片",uploadImage:"上传图片",uploadFailed:"上传失败了",uploadError:"上传出错了",imageUrl:"图片地址",imageSize:"图片尺寸",restoreImageSize:"还原图片尺寸",uploading:"正在上传",indent:"向右缩进",outdent:"向左缩进",italic:"斜体文字",link:"插入链接",text:"文本",linkText:"链接文字",linkUrl:"地址",removeLink:"移除链接",ol:"有序列表",ul:"无序列表",strikethrough:"删除线文字",table:"表格",deleteRow:"删除行",insertRowAbove:"在上面插入行",insertRowBelow:"在下面插入行",deleteColumn:"删除列",insertColumnLeft:"在左边插入列",insertColumnRight:"在右边插入列",deleteTable:"删除表格",title:"标题",normalText:"普通文本",underline:"下划线文字"}};n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};var g,m=[].slice;g=function(e){function r(t){this.editor=t.editor,this.title=this._t(this.name),r.__super__.constructor.call(this,t)}return s(r,e),r.prototype._tpl={item:'<li><a tabindex="-1" unselectable="on" class="toolbar-item" href="javascript:;"><span></span></a></li>',menuWrapper:'<div class="toolbar-menu"></div>',menuItem:'<li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;"><span></span></a></li>',separator:'<li><span class="separator"></span></li>'},r.prototype.name="",r.prototype.icon="",r.prototype.title="",r.prototype.text="",r.prototype.htmlTag="",r.prototype.disableTag="",r.prototype.menu=!1,r.prototype.active=!1,r.prototype.disabled=!1,r.prototype.needFocus=!0,r.prototype.shortcut=null,r.prototype._init=function(){var e,r,i,o,n,s;for(this.render(),this.el.on("mousedown",(s=this,function(t){var e;return t.preventDefault(),!(s.el.hasClass("disabled")||s.needFocus&&!s.editor.inputManager.focused||(s.menu?(s.wrapper.toggleClass("menu-on").siblings("li").removeClass("menu-on"),s.wrapper.is(".menu-on")&&(s.menuWrapper.offset().left+s.menuWrapper.outerWidth()+5-s.editor.wrapper.offset().left-s.editor.wrapper.outerWidth()>0&&s.menuWrapper.css({left:"auto",right:0}),s.trigger("menuexpand")),1):(e=s.el.data("param"),s.command(e),1)))})),this.wrapper.on("click","a.menu-item",function(e){return function(r){var i,o;return r.preventDefault(),i=t(r.currentTarget),e.wrapper.removeClass("menu-on"),i.hasClass("disabled")||e.needFocus&&!e.editor.inputManager.focused||(e.editor.toolbar.wrapper.removeClass("menu-on"),o=i.data("param"),e.command(o)),!1}}(this)),this.wrapper.on("mousedown","a.menu-item",(function(t){return!1})),this.editor.on("blur",function(t){return function(){return t.setActive(!1),t.setDisabled(!1)}}(this)),null!=this.shortcut&&this.editor.inputManager.addShortcut(this.shortcut,function(t){return function(e){return t.el.mousedown(),!1}}(this)),n=[],r=0,i=(o=this.htmlTag.split(",")).length;r<i;r++)e=o[r],(e=t.trim(e))&&t.inArray(e,this.editor.formatter._allowedTags)<0?n.push(this.editor.formatter._allowedTags.push(e)):n.push(void 0);return n},r.prototype.render=function(){if(this.wrapper=t(this._tpl.item).appendTo(this.editor.toolbar.list),this.el=this.wrapper.find("a.toolbar-item"),this.el.attr("title",this.title).addClass("toolbar-item-"+this.name).data("button",this),this.el.find("span").addClass(this.icon?"fa fa-"+this.icon:"").text(this.text),this.menu)return this.menuWrapper=t(this._tpl.menuWrapper).appendTo(this.wrapper),this.menuWrapper.addClass("toolbar-menu-"+this.name),this.renderMenu()},r.prototype.renderMenu=function(){var e,r,i,o,n,s,a;if(t.isArray(this.menu)){for(this.menuEl=t("<ul/>").appendTo(this.menuWrapper),a=[],i=0,o=(n=this.menu).length;i<o;i++)"|"!==(r=n[i])?(e=t(this._tpl.menuItem).appendTo(this.menuEl),a.push(e.find("a.menu-item").attr({title:null!=(s=r.title)?s:r.text,"data-param":r.param}).addClass("menu-item-"+r.name).find("span").text(r.text))):t(this._tpl.separator).appendTo(this.menuEl);return a}},r.prototype.setActive=function(t){if(t!==this.active)return this.active=t,this.el.toggleClass("active",this.active),this.editor.toolbar.trigger("buttonstatus",[this])},r.prototype.setDisabled=function(t){if(t!==this.disabled)return this.disabled=t,this.el.toggleClass("disabled",this.disabled),this.editor.toolbar.trigger("buttonstatus",[this])},r.prototype.status=function(t){return null!=t&&this.setDisabled(t.is(this.disableTag)),!!this.disabled||(null!=t&&this.setActive(t.is(this.htmlTag)),this.active)},r.prototype.command=function(t){},r.prototype._t=function(){var t,e,i;return t=1<=arguments.length?m.call(arguments,0):[],(e=r.__super__._t.apply(this,t))||(e=(i=this.editor)._t.apply(i,t)),e},r}(e),f.Button=g;var v;n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};v=function(e){function r(t){this.button=t.button,this.editor=t.button.editor,r.__super__.constructor.call(this,t)}return s(r,e),r.prototype.offset={top:4,left:0},r.prototype.target=null,r.prototype.active=!1,r.prototype._init=function(){var e;return this.el=t('<div class="simditor-popover"></div>').appendTo(this.editor.el).data("popover",this),this.render(),this.el.on("mouseenter",(e=this,function(t){return e.el.addClass("hover")})),this.el.on("mouseleave",function(t){return function(e){return t.el.removeClass("hover")}}(this))},r.prototype.render=function(){},r.prototype.show=function(e,r){var i;if(null==r&&(r="bottom"),null!=e)return this.el.siblings(".simditor-popover").each((function(e,r){if((r=t(r).data("popover")).active)return r.hide()})),this.target=e.addClass("selected"),this.active?(this.refresh(r),this.trigger("popovershow")):(this.active=!0,this.el.css({left:-9999}).show(),setTimeout((i=this,function(){return i.refresh(r),i.trigger("popovershow")}),0))},r.prototype.hide=function(){if(this.active)return this.target&&this.target.removeClass("selected"),this.target=null,this.active=!1,this.el.hide(),this.trigger("popoverhide")},r.prototype.refresh=function(t){var e,r,i,o,n;if(null==t&&(t="bottom"),this.active)return e=this.editor.el.offset(),o=this.target.offset(),i=this.target.outerHeight(),"bottom"===t?n=o.top-e.top+i:"top"===t&&(n=o.top-e.top-this.el.height()),r=Math.min(o.left-e.left,this.editor.wrapper.width()-this.el.outerWidth()-10),this.el.css({top:n+this.offset.top,left:r+this.offset.left})},r.prototype.destroy=function(){return this.target=null,this.active=!1,this.editor.off(".linkpopover"),this.el.remove()},r}(e),f.Popover=v;var y;n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};y=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return s(r,e),r.prototype.name="title",r.prototype.htmlTag="h1, h2, h3, h4",r.prototype.disableTag="pre, table",r.prototype._init=function(){return this.menu=[{name:"normal",text:this._t("normalText"),param:"p"},"|",{name:"h1",text:this._t("title")+" 1",param:"h1"},{name:"h2",text:this._t("title")+" 2",param:"h2"},{name:"h3",text:this._t("title")+" 3",param:"h3"},{name:"h4",text:this._t("title")+" 4",param:"h4"},{name:"h5",text:this._t("title")+" 5",param:"h5"}],r.__super__._init.call(this)},r.prototype.setActive=function(t,e){if(r.__super__.setActive.call(this,t),this.el.removeClass("active-p active-h1 active-h2 active-h3"),t)return this.el.addClass("active active-"+e)},r.prototype.status=function(t){var e,r;return null!=t&&this.setDisabled(t.is(this.disableTag)),!!this.disabled||(null!=t&&(e=null!=(r=t[0].tagName)?r.toLowerCase():void 0,this.setActive(t.is(this.htmlTag),e)),this.active)},r.prototype.command=function(e){var r,i,o,n,s,a,l,u,d,p,c,h;for(u=(a=this.editor.selection.getRange()).startContainer,n=a.endContainer,o=this.editor.util.closestBlockEl(u),i=this.editor.util.closestBlockEl(n),this.editor.selection.save(),a.setStartBefore(o[0]),a.setEndAfter(i[0]),r=t(a.extractContents()),l=[],r.children().each((h=this,function(t,r){var i,o,n,s,a;for(a=[],n=0,s=(o=h._convertEl(r,e)).length;n<s;n++)i=o[n],a.push(l.push(i));return a})),d=0,p=(c=l.reverse()).length;d<p;d++)s=c[d],a.insertNode(s[0]);return this.editor.selection.restore(),this.editor.trigger("valuechanged")},r.prototype._convertEl=function(e,r){var i,o,n;return n=[],(o=t(e)).is(r)?n.push(o):(i=t("<"+r+"/>").append(o.contents()),n.push(i)),n},r}(g),f.Toolbar.addButton(y);var _;n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};_=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return s(r,e),r.prototype.name="bold",r.prototype.icon="bold",r.prototype.htmlTag="b, strong",r.prototype.disableTag="pre",r.prototype.shortcut="cmd+b",r.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + b )":(this.title=this.title+" ( Ctrl + b )",this.shortcut="ctrl+b"),r.__super__._init.call(this)},r.prototype.status=function(t){var e;return null!=t&&this.setDisabled(t.is(this.disableTag)),!!this.disabled||(e=!0===document.queryCommandState("bold"),this.setActive(e),e)},r.prototype.command=function(){return document.execCommand("bold"),this.editor.trigger("valuechanged"),t(document).trigger("selectionchange")},r}(g),f.Toolbar.addButton(_);var b;n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};b=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return s(r,e),r.prototype.name="italic",r.prototype.icon="italic",r.prototype.htmlTag="i",r.prototype.disableTag="pre",r.prototype.shortcut="cmd+i",r.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + i )":(this.title=this.title+" ( Ctrl + i )",this.shortcut="ctrl+i"),r.__super__._init.call(this)},r.prototype.status=function(t){var e;return null!=t&&this.setDisabled(t.is(this.disableTag)),this.disabled?this.disabled:(e=!0===document.queryCommandState("italic"),this.setActive(e),e)},r.prototype.command=function(){return document.execCommand("italic"),this.editor.trigger("valuechanged"),t(document).trigger("selectionchange")},r}(g),f.Toolbar.addButton(b);var w;n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};w=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return s(r,e),r.prototype.name="underline",r.prototype.icon="underline",r.prototype.htmlTag="u",r.prototype.disableTag="pre",r.prototype.shortcut="cmd+u",r.prototype.render=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + u )":(this.title=this.title+" ( Ctrl + u )",this.shortcut="ctrl+u"),r.__super__.render.call(this)},r.prototype.status=function(t){var e;return null!=t&&this.setDisabled(t.is(this.disableTag)),this.disabled?this.disabled:(e=!0===document.queryCommandState("underline"),this.setActive(e),e)},r.prototype.command=function(){return document.execCommand("underline"),this.editor.trigger("valuechanged"),t(document).trigger("selectionchange")},r}(g),f.Toolbar.addButton(w);var x;n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},m=[].slice;x=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return s(r,e),r.prototype.name="color",r.prototype.icon="font",r.prototype.disableTag="pre",r.prototype.menu=!0,r.prototype.render=function(){var t;return t=1<=arguments.length?m.call(arguments,0):[],r.__super__.render.apply(this,t)},r.prototype.renderMenu=function(){return t('<ul class="color-list">\n  <li><a href="javascript:;" class="font-color font-color-1" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-2" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-3" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-4" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-5" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-6" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-7" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-default" data-color=""></a></li>\n</ul>').appendTo(this.menuWrapper),this.menuWrapper.on("mousedown",".color-list",(function(t){return!1})),this.menuWrapper.on("click",".font-color",(e=this,function(r){var i,o,n,s;if(e.wrapper.removeClass("menu-on"),(i=t(r.currentTarget)).hasClass("font-color-default")){if(!((o=e.editor.body.find("p, li")).length>0))return;s=window.getComputedStyle(o[0],null).getPropertyValue("color"),n=e._convertRgbToHex(s)}else s=window.getComputedStyle(i[0],null).getPropertyValue("background-color"),n=e._convertRgbToHex(s);if(n)return document.execCommand("foreColor",!1,n),e.editor.trigger("valuechanged")}));var e},r.prototype._convertRgbToHex=function(t){var e;return(e=/rgb\((\d+),\s?(\d+),\s?(\d+)\)/g.exec(t))?function(t,e,r){var i;return"#"+(i=function(t){var e;return 1===(e=t.toString(16)).length?"0"+e:e})(t)+i(e)+i(r)}(1*e[1],1*e[2],1*e[3]):""},r}(g),f.Toolbar.addButton(x);var T,C,k;n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};T=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return s(r,e),r.prototype.type="",r.prototype.disableTag="pre, table",r.prototype.status=function(t){var e;return null!=t&&this.setDisabled(t.is(this.disableTag)),!!this.disabled||(null==t?this.active:(e="ul"===this.type?"ol":"ul",t.is(e)?(this.setActive(!1),!0):(this.setActive(t.is(this.htmlTag)),this.active)))},r.prototype.command=function(e){var r,i,o,n,s,a,l,u,d,p,c,h,f,g,m,v;for(h=(p=this.editor.selection.getRange()).startContainer,l=p.endContainer,a=this.editor.util.closestBlockEl(h),i=this.editor.util.closestBlockEl(l),this.editor.selection.save(),p.setStartBefore(a[0]),p.setEndAfter(i[0]),a.is("li")&&i.is("li")&&(n=this.editor.util.furthestNode(a,"ul, ol"),o=this.editor.util.furthestNode(i,"ul, ol"),n.is(o)?(s=(u=function(t){var e;for(e=1;!t.parent().is(n);)e+=1,t=t.parent();return e})(a)>u(i)?i.parent():a.parent(),p.setStartBefore(s[0]),p.setEndAfter(s[0])):(p.setStartBefore(n[0]),p.setEndAfter(o[0]))),r=t(p.extractContents()),c=[],r.children().each((v=this,function(t,e){var r,i,o,n,s;for(s=[],o=0,n=(i=v._convertEl(e)).length;o<n;o++)r=i[o],c.length&&c[c.length-1].is(v.type)&&r.is(v.type)?s.push(c[c.length-1].append(r.children())):s.push(c.push(r));return s})),f=0,g=(m=c.reverse()).length;f<g;f++)d=m[f],p.insertNode(d[0]);return this.editor.selection.restore(),this.editor.trigger("valuechanged")},r.prototype._convertEl=function(e){var r,i,o,n,s,a,l,u,d,p;if(r=t(e),a=[],i="ul"===this.type?"ol":"ul",r.is(this.type))r.children("li").each((p=this,function(e,r){var i,o;if(i=t(r).children("ul, ol").remove(),o=t("<p/>").append(t(r).html()||p.editor.util.phBr),a.push(o),i.length>0)return a.push(i)}));else if(r.is(i))o=t("<"+this.type+"/>").append(r.html()),a.push(o);else if(r.is("blockquote")){for(l=0,u=(d=r.children().get()).length;l<u;l++)n=d[l],s=this._convertEl(n);t.merge(a,s)}else r.is("table")||((o=t("<"+this.type+"><li></li></"+this.type+">")).find("li").append(r.html()||this.editor.util.phBr),a.push(o));return a},r}(g),C=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return s(e,t),e.prototype.type="ol",e.prototype.name="ol",e.prototype.icon="list-ol",e.prototype.htmlTag="ol",e.prototype.shortcut="cmd+/",e.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + / )":(this.title=this.title+" ( ctrl + / )",this.shortcut="ctrl+/"),e.__super__._init.call(this)},e}(T),k=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return s(e,t),e.prototype.type="ul",e.prototype.name="ul",e.prototype.icon="list-ul",e.prototype.htmlTag="ul",e.prototype.shortcut="cmd+.",e.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + . )":(this.title=this.title+" ( Ctrl + . )",this.shortcut="ctrl+."),e.__super__._init.call(this)},e}(T),f.Toolbar.addButton(C),f.Toolbar.addButton(k);var A;n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};A=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return s(r,e),r.prototype.name="blockquote",r.prototype.icon="quote-left",r.prototype.htmlTag="blockquote",r.prototype.disableTag="pre, table",r.prototype.command=function(){var e,r,i,o,n,s,a,l,u,d,p,c;for(l=(s=this.editor.selection.getRange()).startContainer,o=s.endContainer,i=this.editor.util.furthestBlockEl(l),r=this.editor.util.furthestBlockEl(o),this.editor.selection.save(),s.setStartBefore(i[0]),s.setEndAfter(r[0]),e=t(s.extractContents()),a=[],e.children().each((c=this,function(t,e){var r,i,o,n,s;for(s=[],o=0,n=(i=c._convertEl(e)).length;o<n;o++)r=i[o],a.length&&a[a.length-1].is(c.htmlTag)&&r.is(c.htmlTag)?s.push(a[a.length-1].append(r.children())):s.push(a.push(r));return s})),u=0,d=(p=a.reverse()).length;u<d;u++)n=p[u],s.insertNode(n[0]);return this.editor.selection.restore(),this.editor.trigger("valuechanged")},r.prototype._convertEl=function(e){var r,i,o;return r=t(e),o=[],r.is(this.htmlTag)?r.children().each((function(e,r){return o.push(t(r))})):(i=t("<"+this.htmlTag+"/>").append(r),o.push(i)),o},r}(g),f.Toolbar.addButton(A);var E,R;n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},m=[].slice;E=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return s(r,e),r.prototype.name="code",r.prototype.icon="code",r.prototype.htmlTag="pre",r.prototype.disableTag="li, table",r.prototype._init=function(){var e;return r.__super__._init.call(this),this.editor.on("decorate",(e=this,function(r,i){return i.find("pre").each((function(r,i){return e.decorate(t(i))}))})),this.editor.on("undecorate",function(e){return function(r,i){return i.find("pre").each((function(r,i){return e.undecorate(t(i))}))}}(this))},r.prototype.render=function(){var t;return t=1<=arguments.length?m.call(arguments,0):[],r.__super__.render.apply(this,t),this.popover=new R({button:this})},r.prototype.status=function(t){var e;return e=r.__super__.status.call(this,t),this.active?this.popover.show(t):this.editor.util.isBlockNode(t)&&this.popover.hide(),e},r.prototype.decorate=function(t){var e;if(e=t.attr("data-lang"),t.removeClass(),e&&-1!==e)return t.addClass("lang-"+e)},r.prototype.undecorate=function(t){var e;if(e=t.attr("data-lang"),t.removeClass(),e&&-1!==e)return t.addClass("lang-"+e)},r.prototype.command=function(){var e,r,i,o,n,s,a,l,u,d,p,c;for(l=(s=this.editor.selection.getRange()).startContainer,o=s.endContainer,i=this.editor.util.closestBlockEl(l),r=this.editor.util.closestBlockEl(o),s.setStartBefore(i[0]),s.setEndAfter(r[0]),e=t(s.extractContents()),a=[],e.children().each((c=this,function(t,e){var r,i,o,n,s;for(s=[],o=0,n=(i=c._convertEl(e)).length;o<n;o++)r=i[o],a.length&&a[a.length-1].is(c.htmlTag)&&r.is(c.htmlTag)?s.push(a[a.length-1].append(r.contents())):s.push(a.push(r));return s})),u=0,d=(p=a.reverse()).length;u<d;u++)n=p[u],s.insertNode(n[0]);return this.editor.selection.setRangeAtEndOf(a[0]),this.editor.trigger("valuechanged")},r.prototype._convertEl=function(e){var r,i,o,n;return n=[],(r=t(e)).is(this.htmlTag)?(i=t("<p/>").append(r.html().replace("\n","<br/>")),n.push(i)):(o=!r.text()&&1===r.children().length&&r.children().is("br")?"\n":this.editor.formatter.clearHtml(r),i=t("<"+this.htmlTag+"/>").text(o),n.push(i)),n},r}(g),R=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return s(e,t),e.prototype._tpl='<div class="code-settings">\n  <div class="settings-field">\n    <select class="select-lang">\n      <option value="-1">选择程序语言</option>\n      <option value="bash">Bash</option>\n      <option value="c++">C++</option>\n      <option value="cs">C#</option>\n      <option value="css">CSS</option>\n      <option value="erlang">Erlang</option>\n      <option value="less">Less</option>\n      <option value="scss">Sass</option>\n      <option value="diff">Diff</option>\n      <option value="coffeeScript">CoffeeScript</option>\n      <option value="html">Html,XML</option>\n      <option value="json">JSON</option>\n      <option value="java">Java</option>\n      <option value="js">JavaScript</option>\n      <option value="markdown">Markdown</option>\n      <option value="oc">Objective C</option>\n      <option value="php">PHP</option>\n      <option value="perl">Perl</option>\n      <option value="python">Python</option>\n      <option value="ruby">Ruby</option>\n      <option value="sql">SQL</option>\n    </select>\n  </div>\n</div>',e.prototype.render=function(){return this.el.addClass("code-popover").append(this._tpl),this.selectEl=this.el.find(".select-lang"),this.selectEl.on("change",(t=this,function(e){var r;if(t.lang=t.selectEl.val(),r=t.target.hasClass("selected"),t.target.removeClass().removeAttr("data-lang"),-1!==t.lang&&(t.target.addClass("lang-"+t.lang),t.target.attr("data-lang",t.lang)),r)return t.target.addClass("selected")}));var t},e.prototype.show=function(){var t;return t=1<=arguments.length?m.call(arguments,0):[],e.__super__.show.apply(this,t),this.lang=this.target.attr("data-lang"),null!=this.lang?this.selectEl.val(this.lang):this.selectEl.val(-1)},e}(v),f.Toolbar.addButton(E);var B,N;n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},m=[].slice;B=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return s(r,e),r.prototype.name="link",r.prototype.icon="link",r.prototype.htmlTag="a",r.prototype.disableTag="pre",r.prototype.render=function(){var t;return t=1<=arguments.length?m.call(arguments,0):[],r.__super__.render.apply(this,t),this.popover=new N({button:this})},r.prototype.status=function(t){var e;return null!=t&&this.setDisabled(t.is(this.disableTag)),!!this.disabled||(null==t||(e=!0,!t.is(this.htmlTag)||t.is('[class^="simditor-"]')?(this.setActive(!1),e=!1):this.editor.selection.rangeAtEndOf(t)?(this.setActive(!0),e=!1):this.setActive(!0),e?this.popover.show(t):this.editor.util.isBlockNode(t)&&this.popover.hide()),this.active)},r.prototype.command=function(){var e,r,i,o,n,s,a,l,u,d,p;return l=this.editor.selection.getRange(),this.active?(i=t(l.commonAncestorContainer).closest("a"),d=document.createTextNode(i.text()),i.replaceWith(d),l.selectNode(d)):(u=l.startContainer,s=l.endContainer,n=this.editor.util.closestBlockEl(u),r=this.editor.util.closestBlockEl(s),e=t(l.extractContents()),a=this.editor.formatter.clearHtml(e.contents(),!1),i=t("<a/>",{href:"http://www.example.com",target:"_blank",text:a||this._t("linkText")}),n[0]===r[0]?l.insertNode(i[0]):(o=t("<p/>").append(i),l.insertNode(o[0])),l.selectNodeContents(i[0]),this.popover.one("popovershow",(p=this,function(){return a?(p.popover.urlEl.focus(),p.popover.urlEl[0].select()):(p.popover.textEl.focus(),p.popover.textEl[0].select())}))),this.editor.selection.selectRange(l),this.editor.trigger("valuechanged")},r}(g),N=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return s(r,e),r.prototype.render=function(){var e,r;return e='<div class="link-settings">\n  <div class="settings-field">\n    <label>'+this._t("text")+'</label>\n    <input class="link-text" type="text"/>\n    <a class="btn-unlink" href="javascript:;" title="'+this._t("removeLink")+'" tabindex="-1"><span class="fa fa-unlink"></span></a>\n  </div>\n  <div class="settings-field">\n    <label>'+this._t("linkUrl")+'</label>\n    <input class="link-url" type="text"/>\n  </div>\n</div>',this.el.addClass("link-popover").append(e),this.textEl=this.el.find(".link-text"),this.urlEl=this.el.find(".link-url"),this.unlinkEl=this.el.find(".btn-unlink"),this.textEl.on("keyup",(r=this,function(t){if(13!==t.which)return r.target.text(r.textEl.val())})),this.urlEl.on("keyup",function(t){return function(e){var r;if(13!==e.which)return r=t.urlEl.val(),!/https?:\/\/|^\//gi.test(r)&&r&&(r="http://"+r),t.target.attr("href",r)}}(this)),t([this.urlEl[0],this.textEl[0]]).on("keydown",function(e){return function(r){if(13===r.which||27===r.which||!r.shiftKey&&9===r.which&&t(r.target).hasClass("link-url"))return r.preventDefault(),setTimeout((function(){var t;return t=document.createRange(),e.editor.selection.setRangeAfter(e.target,t),e.hide(),e.editor.trigger("valuechanged")}),0)}}(this)),this.unlinkEl.on("click",function(t){return function(e){var r,i;return i=document.createTextNode(t.target.text()),t.target.replaceWith(i),t.hide(),r=document.createRange(),t.editor.selection.setRangeAfter(i,r),t.editor.trigger("valuechanged")}}(this))},r.prototype.show=function(){var t;return t=1<=arguments.length?m.call(arguments,0):[],r.__super__.show.apply(this,t),this.textEl.val(this.target.text()),this.urlEl.val(this.target.attr("href"))},r}(v),f.Toolbar.addButton(B);var S,O;n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},m=[].slice;S=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return s(r,e),r.prototype.name="image",r.prototype.icon="picture-o",r.prototype.htmlTag="img",r.prototype.disableTag="pre, table",r.prototype.defaultImage="",r.prototype.needFocus=!1,r.prototype._init=function(){var e;return null!=this.editor.uploader?this.menu=[{name:"upload-image",text:this._t("localImage")},{name:"external-image",text:this._t("externalImage")}]:this.menu=!1,this.defaultImage=this.editor.opts.defaultImage,this.editor.body.on("click","img:not([data-non-image])",(e=this,function(r){var i,o;return i=t(r.currentTarget),(o=document.createRange()).selectNode(i[0]),e.editor.selection.selectRange(o),e.editor.util.supportSelectionChange||e.editor.trigger("selectionchanged"),!1})),this.editor.body.on("mouseup","img:not([data-non-image])",(function(t){return!1})),this.editor.on("selectionchanged.image",function(e){return function(){var r,i,o;if(null!=(o=e.editor.selection.getRange()))return 1===(r=t(o.cloneContents()).contents()).length&&r.is("img:not([data-non-image])")?(i=t(o.startContainer).contents().eq(o.startOffset),e.popover.show(i)):e.popover.hide()}}(this)),this.editor.on("valuechanged.image",function(e){return function(){var r;if((r=e.editor.wrapper.find(".simditor-image-loading")).length>0)return r.each((function(r,i){var o,n,s;if(!((o=(n=t(i)).data("img"))&&o.parent().length>0)&&(n.remove(),o&&(s=o.data("file"))&&(e.editor.uploader.cancel(s),e.editor.body.find("img.uploading").length<1)))return e.editor.uploader.trigger("uploadready",[s])}))}}(this)),r.__super__._init.call(this)},r.prototype.render=function(){var t;return t=1<=arguments.length?m.call(arguments,0):[],r.__super__.render.apply(this,t),this.popover=new O({button:this})},r.prototype.renderMenu=function(){var e,i,o,n;return r.__super__.renderMenu.call(this),i=this.menuEl.find(".menu-item-upload-image"),e=null,n=this,(o=function(){return e&&e.remove(),e=t('<input type="file" title="'+n._t("uploadImage")+'" accept="image/*">').appendTo(i)})(),i.on("click mousedown","input[type=file]",(function(t){return t.stopPropagation()})),i.on("change","input[type=file]",function(t){return function(r){return t.editor.inputManager.focused?(t.editor.uploader.upload(e,{inline:!0}),o()):(t.editor.one("focus",(function(r){return t.editor.uploader.upload(e,{inline:!0}),o()})),t.editor.focus()),t.wrapper.removeClass("menu-on")}}(this)),this._initUploader()},r.prototype._initUploader=function(){var e;if(null!=this.editor.uploader)return this.editor.uploader.on("beforeupload",(e=this,function(r,i){var o;if(i.inline)return i.img?o=t(i.img):(o=e.createImage(i.name),i.img=o),o.addClass("uploading"),o.data("file",i),e.editor.uploader.readImageFile(i.obj,(function(t){var r;if(o.hasClass("uploading"))return r=t?t.src:e.defaultImage,e.loadImage(o,r,(function(){if(e.popover.active)return e.popover.refresh(),e.popover.srcEl.val(e._t("uploading")).prop("disabled",!0)}))}))})),this.editor.uploader.on("uploadprogress",(function(t,e,r,i){var o,n,s,a;if(e.inline)return(a=(100*(a=r/i)).toFixed(0))>99&&(a=99),(n=e.img.data("mask"))?(o=n.data("img"),s=n.find("span"),o&&o.parent().length>0&&a!==s.text()?s.text(a):n.remove()):void 0})),this.editor.uploader.on("uploadsuccess",function(t){return function(e,r,i){var o,n,s;if(r.inline)return(o=r.img).removeData("file"),o.removeClass("uploading"),(n=o.data("mask"))&&n.remove(),o.removeData("mask"),!1===i.success?(s=i.msg||t._t("uploadFailed"),alert(s),o.attr("src",t.defaultImage)):o.attr("src",i.file_path),t.popover.active&&(t.popover.srcEl.prop("disabled",!1),t.popover.srcEl.val(i.file_path)),t.editor.trigger("valuechanged"),t.editor.body.find("img.uploading").length<1?t.editor.uploader.trigger("uploadready",[r,i]):void 0}}(this)),this.editor.uploader.on("uploaderror",function(e){return function(r,i,o){var n,s,a,l;if(i.inline&&"abort"!==o.statusText){if(o.responseText){try{a=(l=t.parseJSON(o.responseText)).msg}catch(t){t,a=e._t("uploadError")}alert(a)}return(n=i.img).removeData("file"),n.removeClass("uploading"),(s=n.data("mask"))&&s.remove(),n.removeData("mask"),n.attr("src",e.defaultImage),e.popover.active&&(e.popover.srcEl.prop("disabled",!1),e.popover.srcEl.val(e.defaultImage)),e.editor.trigger("valuechanged"),e.editor.body.find("img.uploading").length<1?e.editor.uploader.trigger("uploadready",[i,l]):void 0}}}(this));this.el.find(".btn-upload").remove()},r.prototype.status=function(t){if(null!=t&&this.setDisabled(t.is(this.disableTag)),this.disabled)return!0},r.prototype.loadImage=function(e,r,i){var o,n,s;return(o=e.data("mask"))||(o=t('<div class="simditor-image-loading"><span></span></div>').hide().appendTo(this.editor.wrapper),e.hasClass("uploading")&&o.addClass("uploading"),e.data("mask",o),o.data("img",e)),(n=new Image).onload=(s=this,function(){var t,a,l,u;if(!o.hasClass("uploading")||e.hasClass("uploading"))return l=n.width,t=n.height,e.attr({src:r,"data-image-size":l+","+t}),e.hasClass("uploading")?(s.editor.util.reflow(s.editor.body),u=s.editor.wrapper.offset(),a=e.offset(),o.css({top:a.top-u.top,left:a.left-u.left,width:e.width(),height:e.height()}).show()):(o.remove(),e.removeData("mask")),i(n)}),n.onerror=function(){return i(!1),o.remove(),e.removeData("mask")},n.src=r},r.prototype.createImage=function(e){var r,i,o,n;return null==e&&(e="Image"),this.editor.inputManager.focused||this.editor.focus(),(n=this.editor.selection.getRange()).deleteContents(),(r=this.editor.util.closestBlockEl()).is("p")&&!this.editor.util.isEmptyNode(r)&&(r=t("<p/>").append(this.editor.util.phBr).insertAfter(r),this.editor.selection.setRangeAtStartOf(r,n)),i=t("<img/>").attr("alt",e),n.insertNode(i[0]),(o=r.next("p")).length>0||(o=t("<p/>").append(this.editor.util.phBr).insertAfter(r)),this.editor.selection.setRangeAtStartOf(o),i},r.prototype.command=function(t){var e,r;return e=this.createImage(),this.loadImage(e,t||this.defaultImage,(r=this,function(){return r.editor.trigger("valuechanged"),r.editor.util.reflow(e),e.click(),r.popover.one("popovershow",(function(){return r.popover.srcEl.focus(),r.popover.srcEl[0].select()}))}))},r}(g),O=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return s(r,e),r.prototype.offset={top:6,left:-4},r.prototype.render=function(){var e,r;return e='<div class="link-settings">\n  <div class="settings-field">\n    <label>'+this._t("imageUrl")+'</label>\n    <input class="image-src" type="text" tabindex="1" />\n    <a class="btn-upload" href="javascript:;" title="'+this._t("uploadImage")+'" tabindex="-1">\n      <span class="fa fa-upload"></span>\n    </a>\n  </div>\n  <div class="settings-field">\n    <label>'+this._t("imageSize")+'</label>\n    <input class="image-size" id="image-width" type="text" tabindex="2" />\n    <span class="times">×</span>\n    <input class="image-size" id="image-height" type="text" tabindex="3" />\n    <a class="btn-restore" href="javascript:;" title="'+this._t("restoreImageSize")+'" tabindex="-1">\n      <span class="fa fa-reply"></span>\n    </a>\n  </div>\n</div>',this.el.addClass("image-popover").append(e),this.srcEl=this.el.find(".image-src"),this.srcEl.on("keydown",(r=this,function(t){var e,i;if(13===t.which||27===t.which)return t.preventDefault(),e=function(){return r.button.editor.body.focus(),r.button.editor.selection.setRangeAfter(r.target),r.hide()},13!==t.which||r.target.hasClass("uploading")?e():(i=r.srcEl.val(),/^data:image/.test(i)&&!r.editor.uploader?void e():r.button.loadImage(r.target,i,(function(t){var o;if(t)return/^data:image/.test(i)?((o=r.editor.util.dataURLtoBlob(i)).name="Base64 Image.png",r.editor.uploader.upload(o,{inline:!0,img:r.target})):(e(),r.editor.trigger("valuechanged"))})))})),this.widthEl=this.el.find("#image-width"),this.heightEl=this.el.find("#image-height"),this.el.find(".image-size").on("blur",function(e){return function(r){return e._resizeImg(t(r.currentTarget)),e.el.data("popover").refresh()}}(this)),this.el.find(".image-size").on("keyup",function(e){return function(r){var i;if(i=t(r.currentTarget),13!==r.which&&27!==r.which&&9!==r.which)return e._resizeImg(i,!0)}}(this)),this.el.find(".image-size").on("keydown",function(e){return function(r){var i;return i=t(r.currentTarget),13===r.which||27===r.which?(r.preventDefault(),13===r.which?e._resizeImg(i):e._restoreImg(),e.button.editor.body.focus(),e.button.editor.selection.setRangeAfter(e.target),e.hide()):9===r.which?e.el.data("popover").refresh():void 0}}(this)),this.el.find(".btn-restore").on("click",function(t){return function(e){return t._restoreImg(),t.el.data("popover").refresh()}}(this)),this.editor.on("valuechanged",function(t){return function(e){if(t.active)return t.refresh()}}(this)),this._initUploader()},r.prototype._initUploader=function(){var e,r,i;if(e=this.el.find(".btn-upload"),null!=this.editor.uploader)return i=this,(r=function(){return i.input&&i.input.remove(),i.input=t('<input type="file" title="'+i._t("uploadImage")+'" accept="image/*">').appendTo(e)})(),this.el.on("click mousedown","input[type=file]",(function(t){return t.stopPropagation()})),this.el.on("change","input[type=file]",function(t){return function(e){return t.editor.uploader.upload(t.input,{inline:!0,img:t.target}),r()}}(this));e.remove()},r.prototype._resizeImg=function(e,r){var i,o,n;if(null==r&&(r=!1),o=1*e.val(),t.isNumeric(o)||o<0)return e.is(this.widthEl)?(i=this.height*o/this.width,this.heightEl.val(i)):(n=this.width*o/this.height,this.widthEl.val(n)),r?void 0:this.target.attr({width:n||o,height:i||o})},r.prototype._restoreImg=function(){var t,e;return t=(null!=(e=this.target.data("image-size"))?e.split(","):void 0)||[this.width,this.height],this.target.attr({width:1*t[0],height:1*t[1]}),this.widthEl.val(t[0]),this.heightEl.val(t[1])},r.prototype.show=function(){var t,e;return e=1<=arguments.length?m.call(arguments,0):[],r.__super__.show.apply(this,e),t=this.target,this.width=t.width(),this.height=t.height(),t.hasClass("uploading")?this.srcEl.val(this._t("uploading")).prop("disabled",!0):(this.srcEl.val(t.attr("src")).prop("disabled",!1),this.widthEl.val(this.width),this.heightEl.val(this.height))},r}(v),f.Toolbar.addButton(S);var M;n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};M=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return s(e,t),e.prototype.name="indent",e.prototype.icon="indent",e.prototype._init=function(){return this.title=this._t(this.name)+" (Tab)",e.__super__._init.call(this)},e.prototype.status=function(t){return!0},e.prototype.command=function(){return this.editor.util.indent()},e}(g),f.Toolbar.addButton(M);var P;n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};P=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return s(e,t),e.prototype.name="outdent",e.prototype.icon="outdent",e.prototype._init=function(){return this.title=this._t(this.name)+" (Shift + Tab)",e.__super__._init.call(this)},e.prototype.status=function(t){return!0},e.prototype.command=function(){return this.editor.util.outdent()},e}(g),f.Toolbar.addButton(P);var I;n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};I=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return s(r,e),r.prototype.name="hr",r.prototype.icon="minus",r.prototype.htmlTag="hr",r.prototype.status=function(t){return!0},r.prototype.command=function(){var e,r,i;return(i=this.editor.util.furthestBlockEl()).next().length>0?this.editor.selection.save():r=t("<p/>").append(this.editor.util.phBr),e=t("<hr/>").insertAfter(i),r?(r.insertAfter(e),this.editor.selection.setRangeAtStartOf(r)):this.editor.selection.restore(),this.editor.trigger("valuechanged")},r}(g),f.Toolbar.addButton(I);var H;n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};H=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return s(r,e),r.prototype.name="table",r.prototype.icon="table",r.prototype.htmlTag="table",r.prototype.disableTag="pre, li, blockquote",r.prototype.menu=!0,r.prototype._init=function(){var e;return r.__super__._init.call(this),t.merge(this.editor.formatter._allowedTags,["tbody","tr","td","colgroup","col"]),t.extend(this.editor.formatter._allowedAttributes,{td:["rowspan","colspan"],col:["width"]}),this._initShortcuts(),this.editor.on("decorate",(e=this,function(r,i){return i.find("table").each((function(r,i){return e.decorate(t(i))}))})),this.editor.on("undecorate",function(e){return function(r,i){return i.find("table").each((function(r,i){return e.undecorate(t(i))}))}}(this)),this.editor.on("selectionchanged.table",function(e){return function(r){var i,o;if(e.editor.body.find(".simditor-table td").removeClass("active"),null!=(o=e.editor.selection.getRange()))return i=t(o.commonAncestorContainer),o.collapsed&&i.is(".simditor-table")&&(i=e.editor.selection.rangeAtStartOf(i)?i.find("td:first"):i.find("td:last"),e.editor.selection.setRangeAtEndOf(i)),i.closest("td",e.editor.body).addClass("active")}}(this)),this.editor.on("blur.table",function(t){return function(e){return t.editor.body.find(".simditor-table td").removeClass("active")}}(this)),this.editor.inputManager.addKeystrokeHandler("38","td",function(t){return function(e,r){var i,o,n;return!((i=(o=r.parent("tr")).prev("tr")).length>0)||(n=o.find("td").index(r),t.editor.selection.setRangeAtEndOf(i.find("td").eq(n)),!0)}}(this)),this.editor.inputManager.addKeystrokeHandler("40","td",function(t){return function(e,r){var i,o,n;return!((i=(o=r.parent("tr")).next("tr")).length>0)||(n=o.find("td").index(r),t.editor.selection.setRangeAtEndOf(i.find("td").eq(n)),!0)}}(this))},r.prototype.initResize=function(e){var r,i,o;return o=e.parent(".simditor-table"),(r=e.find("colgroup")).length<1&&(r=t("<colgroup/>").prependTo(e),e.find("tr:first td").each((function(e,i){return t("<col/>").appendTo(r)})),this.refreshTableWidth(e)),i=t('<div class="simditor-resize-handle" contenteditable="false"></div>').appendTo(o),o.on("mousemove","td",(function(e){var n,s,a,l,u;if(!o.hasClass("resizing"))if(s=t(e.currentTarget),e.pageX-t(e.currentTarget).offset().left<5&&s.prev().length>0&&(s=s.prev()),s.next("td").length<1)i.hide();else if(null!=(l=i.data("td"))?l.is(s):void 0)i.show();else{if(a=s.parent().find("td").index(s),n=r.find("col").eq(a),!(null!=(u=i.data("col"))?u.is(n):void 0))return i.css("left",s.position().left+s.outerWidth()-5).data("td",s).data("col",n).show();i.show()}})),o.on("mouseleave",(function(t){return i.hide()})),o.on("mousedown",".simditor-resize-handle",(function(e){var r,i,n,s,a,l,u,d,p,c,h;return n=(r=t(e.currentTarget)).data("td"),i=r.data("col"),a=n.next("td"),s=i.next("col"),c=e.pageX,d=1*n.outerWidth(),p=1*a.outerWidth(),u=parseFloat(r.css("left")),h=n.closest("table").width(),l=50,t(document).on("mousemove.simditor-resize-table",(function(t){var e,o,n;return e=t.pageX-c,n=p-e,(o=d+e)<l?(o=l,n=p-(e=l-d)):n<l&&(n=l,o=d+(e=p-l)),i.attr("width",o/h*100+"%"),s.attr("width",n/h*100+"%"),r.css("left",u+e)})),t(document).one("mouseup.simditor-resize-table",(function(e){return t(document).off(".simditor-resize-table"),o.removeClass("resizing")})),o.addClass("resizing"),!1}))},r.prototype._initShortcuts=function(){var t;return this.editor.inputManager.addShortcut("ctrl+alt+up",(t=this,function(e){return t.editMenu.find(".menu-item[data-param=insertRowAbove]").click(),!1})),this.editor.inputManager.addShortcut("ctrl+alt+down",function(t){return function(e){return t.editMenu.find(".menu-item[data-param=insertRowBelow]").click(),!1}}(this)),this.editor.inputManager.addShortcut("ctrl+alt+left",function(t){return function(e){return t.editMenu.find(".menu-item[data-param=insertColLeft]").click(),!1}}(this)),this.editor.inputManager.addShortcut("ctrl+alt+right",function(t){return function(e){return t.editMenu.find(".menu-item[data-param=insertColRight]").click(),!1}}(this))},r.prototype.decorate=function(t){return t.parent(".simditor-table").length>0&&this.undecorate(t),t.wrap('<div class="simditor-table"></div>'),this.initResize(t),t.parent()},r.prototype.undecorate=function(t){if(t.parent(".simditor-table").length>0)return t.parent().replaceWith(t)},r.prototype.renderMenu=function(){var e;return t('<div class="menu-create-table">\n</div>\n<div class="menu-edit-table">\n  <ul>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="deleteRow"><span>'+this._t("deleteRow")+' ( Ctrl + Alt + → )</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertRowAbove"><span>'+this._t("insertRowAbove")+' ( Ctrl + Alt + ↑ )</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertRowBelow"><span>'+this._t("insertRowBelow")+' ( Ctrl + Alt + ↓ )</span></a></li>\n    <li><span class="separator"></span></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="deleteCol"><span>'+this._t("deleteColumn")+'</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertColLeft"><span>'+this._t("insertColumnLeft")+' ( Ctrl + Alt + ← )</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertColRight"><span>'+this._t("insertColumnRight")+' ( Ctrl + Alt + → )</span></a></li>\n    <li><span class="separator"></span></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="deleteTable"><span>'+this._t("deleteTable")+"</span></a></li>\n  </ul>\n</div>").appendTo(this.menuWrapper),this.createMenu=this.menuWrapper.find(".menu-create-table"),this.editMenu=this.menuWrapper.find(".menu-edit-table"),this.createTable(6,6).appendTo(this.createMenu),this.createMenu.on("mouseenter","td",(e=this,function(r){var i,o,n;return e.createMenu.find("td").removeClass("selected"),n=(o=(i=t(r.currentTarget)).parent()).find("td").index(i)+1,o.prevAll("tr").addBack().find("td:lt("+n+")").addClass("selected")})),this.createMenu.on("mouseleave",(function(e){return t(e.currentTarget).find("td").removeClass("selected")})),this.createMenu.on("mousedown","td",function(e){return function(r){var i,o,n,s,a,l;if(e.wrapper.removeClass("menu-on"),e.editor.inputManager.focused)return a=(s=(n=t(r.currentTarget)).parent()).find("td").index(n)+1,l=s.prevAll("tr").length+1,o=e.createTable(l,a,!0),i=e.editor.util.closestBlockEl(),e.editor.util.isEmptyNode(i)?i.replaceWith(o):i.after(o),e.decorate(o),e.editor.selection.setRangeAtStartOf(o.find("td:first")),e.editor.trigger("valuechanged"),!1}}(this))},r.prototype.createTable=function(e,r,i){var o,n,s,a,l,u;for(o=t("<table/>"),n=t("<tbody/>").appendTo(o),l=0;0<=e?l<e:l>e;0<=e?++l:--l)for(a=t("<tr/>").appendTo(n),u=0;0<=r?u<r:u>r;0<=r?++u:--u)s=t("<td/>").appendTo(a),i&&s.append(this.editor.util.phBr);return o},r.prototype.refreshTableWidth=function(e){var r,i;return i=e.width(),r=e.find("col"),e.find("tr:first td").each((function(e,o){return r.eq(e).attr("width",t(o).outerWidth()/i*100+"%")}))},r.prototype.setActive=function(t){return r.__super__.setActive.call(this,t),t?(this.createMenu.hide(),this.editMenu.show()):(this.createMenu.show(),this.editMenu.hide())},r.prototype.deleteRow=function(t){var e,r,i;return(r=t.parent("tr")).siblings("tr").length<1?this.deleteTable(t):((e=r.next("tr")).length>0||(e=r.prev("tr")),i=r.find("td").index(t),r.remove(),this.editor.selection.setRangeAtEndOf(e.find("td").eq(i)))},r.prototype.insertRow=function(e,r){var i,o,n,s,a,l;for(null==r&&(r="after"),o=(n=e.parent("tr")).closest("table"),s=0,o.find("tr").each((function(e,r){return s=Math.max(s,t(r).find("td").length)})),i=t("<tr/>"),l=1;1<=s?l<=s:l>=s;1<=s?++l:--l)t("<td/>").append(this.editor.util.phBr).appendTo(i);return n[r](i),a=n.find("td").index(e),this.editor.selection.setRangeAtStartOf(i.find("td").eq(a))},r.prototype.deleteCol=function(e){var r,i,o,n;return(o=e.parent("tr")).siblings("tr").length<1&&e.siblings("td").length<1?this.deleteTable(e):(n=o.find("td").index(e),(r=e.next("td")).length>0||(r=o.prev("td")),(i=o.closest("table")).find("col").eq(n).remove(),i.find("tr").each((function(e,r){return t(r).find("td").eq(n).remove()})),this.refreshTableWidth(i),this.editor.selection.setRangeAtEndOf(r))},r.prototype.insertCol=function(e,r){var i,o,n,s,a,l,u,d,p;return null==r&&(r="after"),a=e.parent("tr"),l=a.find("td").index(e),i=(s=e.closest("table")).find("col").eq(l),s.find("tr").each((p=this,function(e,i){var o;return o=t("<td/>").append(p.editor.util.phBr),t(i).find("td").eq(l)[r](o)})),o=t("<col/>"),i[r](o),u=s.width(),d=Math.max(parseFloat(i.attr("width"))/2,50/u*100),i.attr("width",d+"%"),o.attr("width",d+"%"),this.refreshTableWidth(s),n="after"===r?e.next("td"):e.prev("td"),this.editor.selection.setRangeAtStartOf(n)},r.prototype.deleteTable=function(t){var e,r;if(e=(r=t.closest(".simditor-table")).next("p"),r.remove(),e.length>0)return this.editor.selection.setRangeAtStartOf(e)},r.prototype.command=function(e){var r,i;if(i=this.editor.selection.getRange(),(r=t(i.commonAncestorContainer).closest("td")).length>0){if("deleteRow"===e)this.deleteRow(r);else if("insertRowAbove"===e)this.insertRow(r,"before");else if("insertRowBelow"===e)this.insertRow(r);else if("deleteCol"===e)this.deleteCol(r);else if("insertColLeft"===e)this.insertCol(r,"before");else if("insertColRight"===e)this.insertCol(r);else{if("deleteTable"!==e)return;this.deleteTable(r)}return this.editor.trigger("valuechanged")}},r}(g),f.Toolbar.addButton(H);var D;n={}.hasOwnProperty,s=function(t,e){for(var r in e)n.call(e,r)&&(t[r]=e[r]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};return D=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return s(r,e),r.prototype.name="strikethrough",r.prototype.icon="strikethrough",r.prototype.htmlTag="strike",r.prototype.disableTag="pre",r.prototype.status=function(t){var e;return null!=t&&this.setDisabled(t.is(this.disableTag)),!!this.disabled||(e=!0===document.queryCommandState("strikethrough"),this.setActive(e),e)},r.prototype.command=function(){return document.execCommand("strikethrough"),this.editor.trigger("valuechanged"),t(document).trigger("selectionchange")},r}(g),f.Toolbar.addButton(D),f}));