(function($){"use strict";var start=0;$.fn.bootstrapTreeTable=function(options,param){if("string"==typeof options)return $.fn.bootstrapTreeTable.methods[options](this,param);options=$.extend({},$.fn.bootstrapTreeTable.defaults,options||{});var hasSelectItem=!1,target=$(this),_main_div=$("<div class='fixed-table-container'></div>");if(target.before(_main_div),_main_div.append(target),target.addClass("table table-hover treegrid-table table-bordered"),options.striped&&target.addClass("table-striped"),options.toolbar){var _tool_div=$("<div class='fixed-table-toolbar' style='display:none;'></div>"),_tool_left_div=$("<div class='bs-bars pull-left'></div>");_tool_left_div.append($(options.toolbar)),_tool_div.append(_tool_left_div),_main_div.before(_tool_div)}target.getRootNodes=function(t){var e=options.rootCodeValue?options.rootCodeValue:null,a=[];return $.each(t,(function(t,o){var r="0"==o[options.parentCode]||0==o[options.parentCode]||null==o[options.parentCode]||""==o[options.parentCode];o[options.parentCode]&&!(e?o[options.parentCode]==options.rootCodeValue:r)||a.push(o),o.isShow=!1})),a};var j=0;return target.getChildNodes=function(t,e,a,o){$.each(t,(function(r,d){if(d[options.parentCode]==e[options.code]){var n=$("<tr></tr>"),i=a+j+++1;n.addClass("treegrid-"+i),n.addClass("treegrid-parent-"+a),target.renderRow(n,d),d.isShow=!0,o.append(n),target.getChildNodes(t,d,i,o)}}))},target.renderRow=function(t,e){$.each(options.columns,(function(a,o){if(0==a&&"selectItem"==o.fields){hasSelectItem=!0;var r=$('<td style="text-align:center;width:36px"></td>');if(o.radio){var d=$('<input name="select_item" type="radio" value="'+e[options.id]+'"></input>');r.append(d)}if(o.checkbox){d=$('<input name="select_item" type="checkbox" value="'+e[options.id]+'"></input>');r.append(d)}t.append(r)}else{r=$('<td style="text-align:'+o.align+";"+(o.width?"width:"+o.width:"")+'"></td>');o.formatter?r.html(o.formatter.call(this,e,a)):"id"==o.fields.toLowerCase()?r.html(++start):r.html(e[o.fields]),"parentid"!=o.fields.toLowerCase()&&t.append(r)}}))},target.load=function(parms){target.html("");var thr=$("<tr></tr>");$.each(options.columns,(function(t,e){var a=null;0==t&&"selectItem"==e.fields?(hasSelectItem=!0,a=$('<th style="text-align:'+e.align+';width:36px"></th>')):a=$('<th style="text-align:'+e.align+";padding:10px;"+(e.width?"width:"+e.width:"")+'"></th>'),"parentid"!=e.fields.toLowerCase()&&(a.text(e.title),thr.append(a))}));var thead=$('<thead class="treegrid-thead"></thead>');thead.append(thr),target.append(thead);var tbody=$('<tbody class="treegrid-tbody"></tbody>');target.append(tbody);var _loading='<tr><td colspan="'+options.columns.length+'"><div style="display: block;text-align: center;">正在努力地加载数据中，请稍候……</div></td></tr>';tbody.html(_loading),options.height&&tbody.css("height",options.height),$.ajax({type:options.type,url:options.url,data:parms||options.ajaxParams,dataType:"JSON",success:function(data,textStatus,jqXHR){if(data){var columnsArray=[];if(data.columns)for(var columns=eval("("+data.columns+")"),i=0;i<columns.length;i++)columnsArray.push(columns[i].f);var dataArray=[];if(data.rows){for(var row={},columnArray,column,i=0;i<data.rows.length;i++){row={};for(var j=0;j<columnsArray.length;j++)column=data.rows[i][j],0==j&&column&&column.indexOf("#-%@-#@")&&(columnArray=column.split("#-%@-#@"),column=columnArray[1],row.sn=columnArray[0]),row[columnsArray[j]]=column;dataArray.push(row)}data=dataArray}}if(tbody.html(""),!data||data.length<=0){var _empty='<tr><td colspan="'+options.columns.length+'"><div style="display: block;text-align: center;">没有记录</div></td></tr>';tbody.html(_empty)}else{var rootNode=target.getRootNodes(data);$.each(rootNode,(function(t,e){var a=$("<tr></tr>");a.addClass("treegrid-"+j+"_"+t),target.renderRow(a,e),e.isShow=!0,tbody.append(a),target.getChildNodes(data,e,j+"_"+t,tbody)})),$.each(data,(function(t,e){if(!e.isShow){var a=$("<tr></tr>");a.addClass("treegrid-"+j+"_"+t),target.renderRow(a,e),tbody.append(a)}})),target.append(tbody),target.treegrid({treeColumn:options.expandColumn?options.expandColumn:hasSelectItem?1:0,expanderExpandedClass:options.expanderExpandedClass,expanderCollapsedClass:options.expanderCollapsedClass}),options.expandAll||target.treegrid("collapseAll"),target.find("tbody").find("tr").click((function(){if(hasSelectItem){var t=$(this).find("input[name='select_item']");"radio"==t.attr("type")?(t.prop("checked",!0),target.find("tbody").find("tr").removeClass("treegrid-selected"),$(this).addClass("treegrid-selected")):t.prop("checked")?(t.prop("checked",!1),$(this).removeClass("treegrid-selected")):(t.prop("checked",!0),$(this).addClass("treegrid-selected"))}}))}},error:function(t,e){var a='<tr><td colspan="'+options.columns.length+'"><div style="display: block;text-align: center;">'+t.responseText+"</div></td></tr>";tbody.html(a)}})},options.url&&target.load(),target},$.fn.bootstrapTreeTable.methods={getSelections:function(t,e){var a=t.find("tbody").find("tr").find("input[name='select_item']:checked"),o=[];return"radio"==a.attr("type")?o.push({id:a.val()}):a.each((function(t,e){o.push({id:$(e).val()})})),o},refresh:function(t,e){e?t.load(e):t.load()},resetHeight:function(t,e){t.find("tbody").css("height",e+"px")}},$.fn.bootstrapTreeTable.defaults={id:"menuId",code:"menuId",parentCode:"parentId",rootCodeValue:null,data:[],type:"GET",url:null,ajaxParams:{},expandColumn:null,expandAll:!0,striped:!1,columns:[],toolbar:null,height:0,expanderExpandedClass:"glyphicon glyphicon-chevron-down",expanderCollapsedClass:"glyphicon glyphicon-chevron-right"}})(jQuery);