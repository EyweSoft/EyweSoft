/*! jquery-html5Validate.js 基于HTML5表单验证的jQuery插件
 * 支持type="email", type="number", type="tel", type="url", type="zipcode", 以及多type, 如type="email|tel". 
 * 支持 step, min, max, required, pattern, multiple
 * isPInt='Y' 正整数
 * isInt='Y' 整数
 * 有4个自定义扩展属性 data-key, data-target, data-min, data-max
 * 文档：http://www.zhangxinxu.com/wordpress/?p=2857
 * 如果您有任何问题，可以邮件至zhangxinxu@zhangxinxu.com
 * create by zhangxinxu 2012-12-05   
 * v1.0 beta
 		on 2012-12-05 创建
 		on 2012-12-06 兼容性调试
		on 2012-12-14 增加对multiple属性支持
		              testRemind方法的最大宽度限制
		on 2012-12-17 增加submitEnabled参数
		on 2012-12-19 暴露testRemind方法的CSS参数
		on 2012-12-20 testRemind尖角设置overflow: hidden for IE6
	v1.0 publish on 2012-12-20
	v1.2 on 2012-12-21 尖角实际高度可能覆盖单复选框的问题，做了高度限制处理
	v1.2.1 on 2013-03-20 增加hidden提示时候的定位，以便在多屏下的时候提示可见
	v1.3 on 2013-06-19 新增validate参数，应对其他一些自定义的验证
**/
!function(t,e){var i,r,s,n;DBC2SBC=function(t){var e,i,r="";for(e=0;e<t.length;e++)r+=(i=t.charCodeAt(e))>=65281&&i<=65373?String.fromCharCode(t.charCodeAt(e)-65248):12288==i?String.fromCharCode(t.charCodeAt(e)-12288+32):t.charAt(e);return r},t.testRemind=(i=t(window).width(),r=function(e){e&&e.target&&e.target.id!==t.testRemind.id&&0===t(e.target).parents("#"+t.testRemind.id).length&&t.testRemind.hide()},s=function(e){e&&e.target&&"body"!==e.target.tagName.toLowerCase()&&t.testRemind.hide()},n=function(){if(t.testRemind.display){var e=t(window).width();Math.abs(i-e)>20&&(t.testRemind.hide(),i=e)}},{id:"validateRemind",display:!1,css:{},hide:function(){t("#"+this.id).remove(),this.display=!1,t(document).unbind({mousedown:r,keydown:s}),t(window).unbind("resize",n)},bind:function(){t(document).bind({mousedown:r,keydown:s}),t(window).bind("resize",n)}}),OBJREG={EMAIL:"^[a-z0-9._%-]+@([a-z0-9-]+\\.)+[a-z]{2,4}$",NUMBER:"^\\-?\\d+(\\.\\d+)?$",URL:"^(http|https|ftp)\\:\\/\\/[a-z0-9\\-\\.]+\\.[a-z]{2,3}(:[a-z0-9]*)?\\/?([a-z0-9\\-\\._\\?\\,\\'\\/\\\\\\+&amp;%\\$#\\=~])*$",TEL:"(^(1[3-9]{1}\\d{9}|0\\d{2,3}-\\d{8})$)|(^[0][1-9]{2,3}-[0-9]{5,10}$)",ZIPCODE:"^\\d{6}$",prompt:{radio:"请选择一个选项",checkbox:"如果要继续，请选中此框",select:"请选择下拉选项",email:"请输入正确的邮件地址",url:"请输入正确的网站地址",tel:"请输入正确电话号码",number:"请输入数值",date:"请输入日期",pattern:"内容格式不符合要求",empty:"请填写此字段",multiple:"多条数据使用逗号分隔",dept:"请选择部门",pjt:"请选择项目",prd:"请选择产品",user:"请选择用户"}},t.html5Attr=function(i,r){return i&&r?document.querySelector?t(i).attr(r):(s=i.getAttributeNode(r))&&""!==s.nodeValue?s.nodeValue:e:e;var s},t.html5Validate={isSupport:"email"===t('<input type="email">').attr("type"),isEmpty:function(e,i){i=i||t.html5Attr(e,"placeholder");var r=e.value;return"password"!==e.type&&(r=t.trim(r)),"number"==t(e).attr("type")&&(i="",r||(r="0")),""===r},isRegex:function(e,i,r){var s=e.value,n=s,a=e.getAttribute("type")+"";if("password"!==(a=a.replace(/\W+$/,""))&&(n=DBC2SBC(t.trim(s)))!==s&&t(e).val(n),i=i||t.html5Attr(e,"pattern")||a&&t.map(a.split("|"),(function(t){var e=OBJREG[t.toUpperCase()];if(e)return e})).join("|"),""===n||!i)return!0;var o=t(e).hasProp("multiple"),d=new RegExp(i,r||"i");if(o&&!/^number|range$/i.test(a)){var l=!0;return t.each(n.split(","),(function(e,i){i=t.trim(i),l&&!d.test(i)&&(l=!1)})),l}return d.test(n)},isOverflow:function(e){if(!e)return!1;var i,r,s,n=t(e).attr("min"),a=t(e).attr("max"),o=t(e).attr("isPInt"),d=t(e).attr("isInt"),l=e.value;if(n||a||o||d){if(l=Number(l),i=Number(t(e).attr("step"))||1,n&&l<n)t(e).testRemind("值必须大于或等于"+n);else if(a&&l>a)t(e).testRemind("值必须小于或等于"+a);else if(o&&"Y"==o&&l&&!/^[1-9]\d*$/.test(l))t(e).testRemind("必须是正整数");else if(d&&"Y"==d&&l&&!/^-?[1-9]\d*$/.test(l))t(e).testRemind("必须是整数");else{if(!i||/^\d+(\.\d{1,})?$/.test(Math.abs(l-n||0)/i))return!1;t(e).testRemind("值无效")}e.focus(),e.select()}else if(r=t(e).attr("data-min"),s=t(e).attr("data-max"),r&&l.length<r)t(e).testRemind("至少输入"+r+"个字符"),e.focus();else{if(!(s&&l.length>s))return!1;t(e).testRemind("最多输入"+s+"个字符"),t(e).selectRange(s,l.length)}return!0},isAllpass:function(e,i){if(!e)return!0;params=t.extend({},{labelDrive:!0},i||{}),e.size&&1==e.size()&&"form"==e.get(0).tagName.toLowerCase()?e=e.find(":input"):e.tagName&&"form"==e.tagName.toLowerCase()&&(e=t(e).find(":input"));var r=this,s=!0,n=function(e,i,r){var s,n=t(e),a=n.attr("data-key"),o=t("label[for='"+e.id+"']"),d="";if(params.labelDrive&&(s=t.html5Attr(e,"placeholder"),o.each((function(){var e=t(this).text();e!==s&&(d+=e.replace(/\*|:|：/g,""))}))),n.isVisible())if("radio"==i||"checkbox"==i)n.focus(),n.testRemind(OBJREG.prompt[i],{align:"left"});else if("select"==r||"empty"==r){var l=n.attr("htype");n.focus(),!l||"DEPT"!=l&&"PJT"!=l&&"PRD"!=l&&"USER"!=l&&"SELECT"!=l&&"DATE"!=l?n.testRemind("empty"==r&&d?"请输入"+d:OBJREG.prompt[r]):n.testRemind(OBJREG.prompt[l.toLowerCase()])}else if(/^range|number$/i.test(i)&&Number(e.value))n.focus(),n.select(),n.testRemind("值无效");else{var c=OBJREG.prompt[i]||OBJREG.prompt.pattern;d&&(c="您输入的"+d+"格式不准确"),"number"!=i&&n.hasProp("multiple")&&(c+="，"+OBJREG.prompt.multiple),n.focus(),n.select(),n.testRemind(c)}else{var p=n.attr("data-target"),m=n.attr("hType"),u=t("#"+p);0==u.size()&&"SELECT"!=n.get(0).tagName&&(u=n.closest("."+p)),0==u.size()&&(u=n.parent());var h="";if(m&&(m=m.toLowerCase(),h=OBJREG.prompt[m]),h||(h=h="请"+(a||("empty"==r?"输入":"选择"))+(!/^radio|checkbox$/i.test(i)&&d||"该项内容")),u.size()){var f=u.offset().top,b=t(".title-ul");b.length&&(f-=b.height());var v=t(".windowPage");v&&v.length?t(".layout-left").animate({scrollTop:f},0):t(".layer-box").animate({scrollTop:f},0),u.testRemind(h)}else n.testRemind(h)}return!1};return e.each((function(){var e=this,i=e.getAttribute("type"),a=e.tagName.toLowerCase(),o=t(this).hasProp("required");if(i){var d=i.replace(/\W+$/,"");if(!params.hasTypeNormally&&t.html5Validate.isSupport&&i!=d)try{e.type=d}catch(t){}i=d}if(0!=s&&!e.disabled&&"submit"!=i&&"reset"!=i&&"file"!=i&&"image"!=i){var l=t(this).closest(".field-li");if(!l.length||!l.is(":hidden"))if("radio"==i&&o){var c=e.name?t("input[type='radio'][name='"+e.name+"']"):t(e),p=!1;c.each((function(){0==p&&t(this).is(":checked")&&(p=!0)})),0==p&&(s=n(c.get(0),i,a))}else"checkbox"==i&&o&&!t(e).closest(".field-content-check").find('input[type="checkbox"]').is(":checked")||"select"==a&&o&&!e.value||"number"==i&&o&&!e.value?s=n(e,i,a):o&&r.isEmpty(e)||!(s=r.isRegex(e))?(n(e,i,s?"empty":a),s=!1):r.isOverflow(e)&&(s=!1)}})),s}},t.fn.extend({isVisible:function(){return"hidden"!==t(this).attr("type")&&"none"!==t(this).css("display")&&"hidden"!==t(this).css("visibility")},hasProp:function(i){if("string"!=typeof i)return e;var r=!1;if(document.querySelector){var s=t(this).attr(i);s!==e&&!1!==s&&(r=!0)}else{var n=t(this).get(0).outerHTML,a=n.slice(0,n.search(/\/?['"]?>(?![^<]*<['"])/));r=new RegExp("\\s"+i+"\\b","i").test(a)}return r},selectRange:function(e,i){var r=t(this).get(0);if(r.createTextRange){var s=r.createTextRange();s.collapse(!0),s.moveEnd("character",i),s.moveStart("character",e),s.select()}else r.focus(),r.setSelectionRange(e,i);return this},testRemind:function(e,i){var r={size:6,align:"center",css:{maxWidth:280,backgroundColor:"#ff9948cc",borderColor:"#ff9948cc",color:"#fff",fontSize:"12px",padding:"5px 10px",zIndex:9999,borderRadius:"4px"}};(i=i||{}).css=t.extend({},r.css,i.css||t.testRemind.css);var s=t.extend({},r,i||{});if(e&&t(this).isVisible()){var n={center:"50%",left:"15%",right:"85%"}[s.align]||"50%";s.css.position="absolute",s.css.top="-99px",s.css.border="1px solid "+s.css.borderColor,t("#"+t.testRemind.id).size()&&t.testRemind.hide(),this.remind=t('<div id="'+t.testRemind.id+'">'+e+"</div>").css(s.css);var a,o=t(this).closest(".modal-dialog");o.length?o.append(this.remind):t(document.body).append(this.remind),!window.XMLHttpRequest&&(a=parseInt(s.css.maxWidth))&&this.remind.width()>a&&this.remind.width(a);var d=t(this).offset(),l="top";if(!d)return t(this);var c=d.top-this.remind.outerHeight()-s.size;c<t(document).scrollTop()&&(l="bottom",c=d.top+t(this).outerHeight()+s.size);var p=function(e){var i="transparent",r="dashed",n="solid",a={},o={width:0,height:0,overflow:"hidden",borderWidth:s.size+"px",position:"absolute"},d={};if("before"===e)a={top:{borderColor:[s.css.borderColor,i,i,i].join(" "),borderStyle:[n,r,r,r].join(" "),top:0},bottom:{borderColor:[i,i,s.css.borderColor,""].join(" "),borderStyle:[r,r,n,r].join(" "),bottom:0}};else{if("after"!==e)return a=null,o=null,d=null,null;a={top:{borderColor:s.css.backgroundColor+["",i,i,i].join(" "),borderStyle:[n,r,r,r].join(" "),top:-1},bottom:{borderColor:[i,i,s.css.backgroundColor,""].join(" "),borderStyle:[r,r,n,r].join(" "),bottom:-1}}}return d=t.extend({},a[l],o),t("<"+e+"></"+e+">").css(d)},m={width:2*s.size,left:n,marginLeft:-1*s.size+"px",height:s.size,textIndent:0,overflow:"hidden",position:"absolute"};return"top"==l?m.bottom=-1*s.size:m.top=-1*s.size,this.remind.css({left:d.left,top:c,marginLeft:"10px"}).prepend(t("<div></div>").css(m).append(p("before")).append(p("after"))),t.testRemind.display=!0,t.testRemind.bind(),t(this)}},html5Validate:function(e,i){var r=t.extend({},{novalidate:!0,submitEnabled:!0,validate:function(){return!0}},i||{}),s=t(this).find(":input");return t.html5Validate.isSupport&&(r.novalidate?t(this).attr("novalidate","novalidate"):(s.each((function(){var t=this.getAttribute("type")+"",e=t.replace(/\W+$/,"");if(t!=e)try{this.type=e}catch(t){}})),r.hasTypeNormally=!0)),r.submitEnabled&&t(this).find(":disabled").each((function(){/^image|submit$/.test(this.type)&&t(this).removeAttr("disabled")})),t(this).bind("submit",(function(){return showLoading(),t.html5Validate.isAllpass(s,r)&&r.validate()&&t.isFunction(e)?setTimeout((function(){e.call(this)}),100):hideLoading(),!1})),t(this)}})}(jQuery);