function getViewH(){return $(".layer-body").height()-222}function getRightW(){return $(".render-container").width()}function getEvt(){return""}function getTH(){return"100%"}function getW(){return"100%"}!function(e,t){e.widget("ui.workflow",e.ui.mouse,{options:{data:"",canEdit:!0,hasLock:!1,opEdit:null,nodeEdit:null,workflowId:null},ops:{NONE:-1,SELECT:0,CONNECT:1,NODE:2,DECIDE:3,DERIVE:4,TOSELF:5,START:6},drags:{NONE:-1,NODE:0,POINT:1,CONNECT:2,SELECT:3,NODES:4},_create:function(){var t=this;if(t.ACTIVE_OP=t.ops.NONE,t.ACTIVE_DRAG=t.drags.NONE,this.selHelper=e("<div class='select-helper' />"),this.lineHelperH=e("<div class='line-helperH' />"),this.lineHelperV=e("<div class='line-helperV' />"),t.options.canEdit&&t._initEditPanel(),3==getBrowser()?t.render=new VMLRender(t):(e.ajax({url:ctx+"page/wfDesignItems.html",async:!1,success:function(e){t.element.append(e)}}),t.render=new SVGRender(t)),""!=t.options.data&&t.render.draw(),3!=getBrowser()){var r=e("<input>");this.element.prepend(r),r.focus().remove()}t.resize(),t.selectable(!1),t._initEvent(),t._mouseInit()},autoSave:function(){e("#btnSave").mousedown()},resize:function(){this._trigger("resize",getEvt())},saveText:function(e,t){this._trigger("editItem",getEvt(),[e.attr("id"),t,"node"==e.attr("itype")?"Y":"N"])},nodeImg:function(e){var t=this,r="";return e==t.ops.START?r="icon1012.gif":e==t.ops.NODE?r="icon1013.gif":e==t.ops.DECIDE?r="icon1014.gif":e==t.ops.TOSELF?r="icon1015.jpg":e==t.ops.DERIVE&&(r="icon1016.jpg"),ctx+"img/workflow/"+r},updateText:function(t,r,i,o){var n=this.render.getSelect();n.size()>0&&(this.render.updateText(n,t),r&&(e("#"+n.attr("id")+"_node").attr("id",r+"_node"),n.attr("id",r)),i&&this.render.updateText(e("#"+r+"_node"),i),o&&e("#"+r+"_node").attr("wi",o))},updateColor:function(e,t,r){for(var i=0;i<e.length;i++)this.render.updateColor(e[i],t,r)},selectable:function(e){e?this.render.panel.enableSelection():this.render.panel.disableSelection()},_mouseCapture:function(t){var r=this,i=e(t.target),o=r.ACTIVE_OP,n=r.render.getGroup(i);if(!r.options.canEdit&&n.attr("ntype")!=r.ops.DECIDE)return!1;if("panel"==i.attr("itype")){if(r.render.cancelSelect(),o==r.ops.NODE||o==r.ops.DECIDE){var a,s,d=r.render.initPos({x:t.clientX,y:t.clientY});o==r.ops.DECIDE?(s="decision",a=e("#workflowGraphDecide").text()):(s="state",a=e("#workflowGraphNode").text()),r._trigger("saveNode",getEvt(),[a,s]),r.render.addNode(r.newId,o,a,d)}return!0}var p=n.attr("itype");return"node"==p?(r._selectNode(i),!0):"op"==p?(r._selectOperate(i),!0):void 0},_mouseStart:function(t){var r=this,i=e(t.target),o=r.render.getGroup(i);if(0==o.size()||"Y"!=o.attr("selected"))return r._mouseStart_SELECT(t),void(r.ACTIVE_DRAG=r.drags.SELECT);var n=r.ACTIVE_OP,a=r.drags.NONE;"node"==o.attr("itype")?(n==r.ops.SELECT?(a=1==e("[selected='Y']").size()?r.drags.NODE:r.drags.NODES,r._mouseStart_LINE(a)):n==r.ops.CONNECT&&(r._isSpecial(o.attr("ntype"))||(a=r.drags.CONNECT)),r.begin=o,r.beginPos=r.render.nodePos(o)):"op_point"==i.attr("itype")&&(a=r.drags.POINT,r.begin=i,r._mouseStart_LINE(a)),r.ACTIVE_DRAG=a},_mouseStart_SELECT:function(t){this.opos=[t.pageX,t.pageY],e("body").append(this.selHelper.css({top:t.clientY,left:t.clientX,width:0,height:0}))},_mouseStart_LINE:function(t){var r,i,o,n=this,a=[];t==n.drags.NODE?n.render.getNodes().not("[selected='Y']").each((function(){a.push(n.render.nodePos(e(this)))})):t==n.drags.POINT&&(i=n.render.pointPos(),n.render.getNodes().each((function(){a.push(n.render.nodePos(e(this)))})),n.render.getOperates().each((function(){r=n.render.tool.points(e("[itype='op_path']",e(this))),o=n.render.groupPos(e(this));for(var t=1;t<r.length-1;t++)r[t].x==i.x&&r[t].y==i.y||a.push({x:r[t].x+o.x,y:r[t].y+o.y})}))),this.nPos=a,e("body").append(n.lineHelperH.hide()).append(n.lineHelperV.hide())},_mouseDrag:function(t){var r=this,i=r.ACTIVE_DRAG,o=e(t.target),n=r.render.initPos({x:t.clientX,y:t.clientY});if(n.x<4&&(n.x=4),n.y<4&&(n.y=4),i!=r.drags.NONE&&r.render.autoFlexPanel(n),i==r.drags.NODE||i==r.drags.POINT)r._lineNode(r.begin,n,o,i);else if(i==r.drags.NODES)r.render.moveSelectedNode(r.begin,n);else if(i==r.drags.CONNECT)r.render.moveConnect(r.beginPos,n,o);else if(i==r.drags.SELECT){var a=r.opos[0],s=r.opos[1],d=t.pageX,p=t.pageY;if(a>d){var l=d;d=a,a=l}if(s>p){l=p;p=s,s=l}r.selHelper.css({top:s,left:a,width:d-a-1,height:p-s-1})}},_mouseStop:function(t){var r=this,i=r.ACTIVE_DRAG,o=r.render.getConnectNode();if(i==r.drags.POINT){var n=r.render.getGroup(r.begin);if(o&&o.size()>0){var a=r.render.changeOperate(r.begin,o);r._trigger("updateOperate",getEvt(),[n.attr("id"),o.attr("id"),a])}r.render.refreshOperate(n)}else if(i==r.drags.CONNECT){if(r.render.hideConnect(),o&&o.size()>0){var s=e("#workflowGraphOperate").text();r.begin.attr("ntype")==r.ops.DECIDE&&(s=e("#workflowGraphPart").text()),r._trigger("saveOperate",getEvt(),[s,"COMMON",r.begin.attr("id"),o.attr("id")]),r.render.addOperate(r.newId,r.begin,o,s)}}else if(i==r.drags.SELECT){r.selHelper.remove();var d=r.opos[0]>t.pageX?t.pageX:r.opos[0],p=r.opos[0]>t.pageX?r.opos[0]:t.pageX,l=r.opos[1]>t.pageY?t.pageY:r.opos[1],c=r.opos[1]>t.pageY?r.opos[1]:t.pageY,g="",f=!0;r.render.getNodes().each((function(t){var i=e("[itype='node_img']",e(this)),o=i.offset().left,n=i.offset().top,a=r.render.tool.getLen(i);o>=d&&o<=p-a.w&&n>=l&&n<=c-a.h&&(f?(r._selectNode(e(this),!0),f=!1):(r.render.selectNode(e(this),!0),f=!0),g+=","+e(this).attr("uid")+",")})),r.render.getOperates().each((function(){g.indexOf(","+e(this).attr("from")+",")>=0&&g.indexOf(","+e(this).attr("to")+",")>=0&&r.render.selectOperate(e(this),!0)})),""!=g&&f&&(e("#btnSelect").click(),e("#btnSelf, #btnDerive, #btnDel").addClass("operate-invalid"),r.options.hasLock||e("#btnDel").removeClass("operate-invalid"))}r.ACTIVE_DRAG=r.drags.ACTIVE_NONE,r.lineHelperH.remove(),r.lineHelperV.remove()},_lineNode:function(t,r,i,o){var n=this,a=n.render.container,s=n.lineHelperH,d=n.lineHelperV,p=e("div.operate-container").width(),l=a.attr("scrollTop"),c=a.attr("scrollLeft");e.each(n.nPos,(function(e,t){if(r.y>=t.y-7&&r.y<=t.y+7)return r.y=t.y,s.css({top:t.y-l,left:p}).show(),a.attr("scrollHeight")>a.height()&&s.width(getRightW()-p-18),!1;s.hide()})),e.each(n.nPos,(function(e,t){if(r.x>=t.x-7&&r.x<=t.x+7)return r.x=t.x,d.css({top:0,left:t.x-c+p}).show(),!1;d.hide()})),o==n.drags.NODE?n.render.moveNode(t,r):n.render.movePoint(t,r,i)},_selectNode:function(t,r){var i=this,o=i.render.getGroup(t),n=parseInt(o.attr("ntype"));i.render.selectNode(o,r),i.options.hasLock||(n==i.ops.NODE?e("#btnSelf, #btnDerive, #btnDel").removeClass("operate-invalid"):n==i.ops.START?e("#btnSelf").removeClass("operate-invalid"):n==i.ops.DECIDE&&e("#btnDel").removeClass("operate-invalid")),(i.ACTIVE_OP!=i.ops.CONNECT||i._isSpecial(n))&&e("#btnSelect").click()},_selectOperate:function(t){var r=this,i=r.render.getGroup(t);r.render.selectOperate(i),"op_point"==t.attr("itype")&&r.render.selectPoint(t),e("#btnAddP, #btnDelP").removeClass("operate-invalid"),r.options.hasLock||r.render.tool.itemByUid(i.attr("from")).attr("ntype")==r.ops.DERIVE||e("#btnDel").removeClass("operate-invalid")},_isSpecial:function(e){return(e=parseInt(e))==this.ops.TOSELF||e==this.ops.DERIVE},_initOpenEvent:function(e,t){var r=this;e.bind("dblclick",(function(){var e=t.attr("wi"),i=t.attr("li");e&&""!=e&&r._trigger("openWorkflow",getEvt(),e),i&&""!=i&&r._trigger("openLifecycle",getEvt(),i)}))},_initEditPanel:function(){var t=this,r=ctx+"img/workflow/icon",i=top.document;t.element.append("<div class='operate-container'><table id='operateTab' cellpadding='3'><tr><td title='"+e("#workflowGraphHint1").text()+"' id='btnSelect' class='operate-td operate-invalid operate-type-keep' val=0><img src='"+r+"1001.gif'></td><td title='"+e("#workflowGraphHint2").text()+"' class='operate-td operate-invalid operate-type-keep' val=1><img src='"+r+"1002.gif'></td></tr><tr><td title='"+e("#workflowGraphHint3").text()+"' class='operate-td operate-invalid operate-type-keep' val=2><img src='"+r+"1003.gif'></td><td title='"+e("#workflowGraphHint4").text()+"' class='operate-td operate-invalid operate-type-keep' val=3><img src='"+r+"1004.gif'></td></tr><tr><td colspan='2' class='operate-split'><span/></td></tr><tr><td title='"+e("#workflowGraphHint5").text()+"' id='btnAddP' class='operate-td operate-invalid operate-type-immi'><img src='"+r+"1005.gif'></td><td title='"+e("#workflowGraphHint6").text()+"' id='btnDelP' class='operate-td operate-invalid operate-type-immi'><img src='"+r+"1006.gif'></td></tr><tr><td title='"+e("#workflowGraphHint7").text()+"' id='btnSelf' title='to self' class='operate-td operate-invalid operate-type-immi'><img src='"+r+"1007.jpg'></td><td title='"+e("#workflowGraphHint8").text()+"' id='btnDerive' title='derive' class='operate-td operate-invalid operate-type-immi'><img src='"+r+"1008.jpg'></td></tr><tr><td title='"+e("#workflowGraphHint9").text()+"' id='btnDel' class='operate-td operate-invalid operate-type-immi'><img src='"+r+"1009.gif'></td><td title='"+e("#workflowGraphHint10").text()+"' id='btnSave' class='operate-td operate-type-immi'><img src='"+r+"1010.gif'></td></tr><tr><td colspan='2' class='operate-split'><span/></td></tr><tr><td colspan='2'><input id='btnTest' type='button' class='button' style='width: 90%;' value='"+e("#workflowTest",i).text()+"'></td></tr></table><input id='editInput' class='inputText edit-input'></div>"),e("#btnTest").bind("click",(function(){showModDialog(ctx+"pages/workflow/workflowTestDialog.jsf?workflowId="+t.options.workflowId,950,470)})),e("#operateTab td.operate-type-keep").bind("click",(function(){if(!t.options.hasLock||"btnSelect"==e(this).attr("id")){var r=e("td.operate-selected");r.size()>0&&r[0]!==this&&r.removeClass("operate-selected"),t.ACTIVE_OP=e(this).addClass("operate-selected").attr("val")}})).first().click(),e("#operateTab td.operate-type-immi").bind("mousedown",(function(){if(!e(this).hasClass("operate-invalid")){var r,i=e(this).attr("id"),o=t.render.getSelect();if("btnAddP"==i)t.render.addPoint(o);else if("btnDelP"==i)t.render.removePoint(o);else if("btnDerive"==i)r=e("#workflowGraphDerive").text(),t._trigger("saveOperate",getEvt(),[r,"DERIVE",o.attr("id"),o.attr("id")]),t.render.addSpecial(t.newId,r,t.ops.DERIVE,o);else if("btnSelf"==i)r=e("#workflowGraphOperate").text(),t._trigger("saveOperate",getEvt(),[r,"COMMON",o.attr("id"),o.attr("id")]),t.render.addSpecial(t.newId,r,t.ops.TOSELF,o);else if("btnDel"==i)var n=top.layer.confirm("确定要删除该状态吗？",{btn:[e.i18n.prop("common.comfirm"),e.i18n.prop("common.cancel")]},(function(){top.layer.close(n),o.each((function(){var r=parseInt(e(this).attr("ntype"));r!=t.ops.NODE&&r!=t.ops.DECIDE&&1!=o.size()||(t._trigger("removeItem",getEvt(),[e(this).attr("id"),"node"==e(this).attr("itype")?"Y":"N"]),t.render.removeItem(e(this)))})),t.render.cancelSelect(),3!=getBrowser()&&e(window).focus().blur(),e("[itype='panel']").focus().blur()}),(function(){3!=getBrowser()&&e(window).focus().blur(),e("[selected=Y]").focus().blur()}));else"btnSave"==i&&t._trigger("saveGraph",getEvt(),t.render.graphData());e(this).addClass("operate-selected")}})).bind("mouseup",(function(){e(this).removeClass("operate-selected")}))},_initEvent:function(){(3==getBrowser()?e(document.body):e(window)).bind("keydown",(function(t){t.keyCode==e.ui.keyCode.DELETE&&e("#btnDel").mousedown().mouseup()}))}})}(jQuery);