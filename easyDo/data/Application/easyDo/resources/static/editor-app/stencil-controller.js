"use strict";angular.module("activitiModeler").controller("StencilController",["$rootScope","$scope","$http","$modal","$timeout",function(e,t,i,n,a){t.propertyWindowState={collapsed:!1},t.headerConfig=KISBPM.HEADER_CONFIG,t.propertyWindowState.toggle=function(){t.propertyWindowState.collapsed=!t.propertyWindowState.collapsed,a((function(){jQuery(window).trigger("resize")}))},t.editorFactory.promise.then((function(){var n=[],a=function(e,t){for(var i=0;i<t.length;i++)if(t[i].name===e)return t[i];return null},r=function(e,t){var i={name:e,items:[],paletteItems:[],groups:[],visible:!0};return t.push(i),i};i({method:"GET",url:KISBPM.URL.getStencilSet()}).success((function(e,i,o,s){for(var d=["UserTask","EndNoneEvent","ExclusiveGateway","CatchTimerEvent","ThrowNoneEvent","TextAnnotation","SequenceFlow","Association"],l=["SequenceFlow","MessageFlow","Association","DataAssociation","DataStore","SendTask"],c=[],h=[],p=0;p<e.rules.morphingRules.length;p++){var f={role:e.rules.morphingRules[p].role,morphOptions:[]};h.push(f)}for(var u=0;u<e.stencils.length;u++){var g=e.stencils[u].groups[0];if("Diagram"!==g&&"Form"!==g){var v=!1;e.stencils[u].removed&&(v=!0);var S=void 0;if(!v&&null!=g&&g.length>0){null===(S=a(g,n))&&(S=r(g,n));for(var y=1;y<e.stencils[u].groups.length;y++){var C=e.stencils[u].groups[y],m=a(C,S.groups);null===m&&(m=r(C,S.groups)),S=m}}var E={id:e.stencils[u].id,name:e.stencils[u].title,description:e.stencils[u].description,icon:e.stencils[u].icon,type:e.stencils[u].type,roles:e.stencils[u].roles,removed:v,customIcon:!1,canConnect:!1,canConnectTo:!1,canConnectAssociation:!1};e.stencils[u].customIconId&&e.stencils[u].customIconId>0&&(E.customIcon=!0,E.icon=e.stencils[u].customIconId),v||d.indexOf(E.id)>=0&&(c[d.indexOf(E.id)]=E),"TextAnnotation"!==E.id&&"BoundaryCompensationEvent"!==E.id||(E.canConnectAssociation=!0);for(p=0;p<e.stencils[u].roles.length;p++){var I=e.stencils[u].roles[p];"sequence_start"===I?E.canConnect=!0:"sequence_end"===I&&(E.canConnectTo=!0);for(var O=0;O<h.length;O++)if(I===h[O].role){v||h[O].morphOptions.push(E),E.morphRole=h[O].role;break}}S?(S.items.push(E),l.indexOf(E.id)<0&&S.paletteItems.push(E)):v||n.push(E)}}for(p=0;p<n.length;p++)n[p].paletteItems&&0==n[p].paletteItems.length&&(n[p].visible=!1);t.stencilItemGroups=n;var R=[];for(p=0;p<e.rules.containmentRules.length;p++){var N=e.rules.containmentRules[p];R.push(N)}t.containmentRules=R;var T=[];for(p=0;p<c.length;p++)c[p]&&(T[T.length]=c[p]);t.quickMenuItems=T,t.morphRoles=h})).error((function(e,t,i,n){console.log("Something went wrong when fetching stencil items:"+JSON.stringify(e))})),t.editor.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,(function(i){var n=i.elements,a=!1;if(n&&0==n.length&&(n=[t.editor.getCanvas()],a=!0),n&&n.length>0){var r=n.first(),o=r.getStencil();if(e.selectedElementBeforeScrolling&&-1!==o.id().indexOf("BPMNDiagram"))return;if(e.selectedElementBeforeScrolling&&e.selectedElementBeforeScrolling.getId()===r.getId())return void(e.selectedElementBeforeScrolling=null);if(t.previousSelectedShape=t.selectedShape,void 0!==t.selectedShape&&t.selectedShape.getId()===r.getId()){if(!e.forceSelectionRefresh)return;e.forceSelectionRefresh=!1}var s={title:"",properties:[]};a&&(s.auditData={author:t.modelData.createdByUser,createDate:t.modelData.createDate});for(var d=o.properties(),l=0;l<d.length;l++){var c=d[l];if(0!=c.popular()){var h=c.prefix()+"-"+c.id();"oryx-name"===h&&(s.title=r.properties[h]);var p=KISBPM.PROPERTY_CONFIG[h+"-"+c.type()];if(null==p&&(p=KISBPM.PROPERTY_CONFIG[c.type()]),null==p)console.log("WARNING: no property configuration defined for "+h+" of type "+c.type());else{if("true"===r.properties[h]&&(r.properties[h]=!0),0==KISBPM.CONFIG.showRemovedProperties&&c.isHidden())continue;var f={key:h,title:c.title(),type:c.type(),mode:"read",hidden:c.isHidden(),value:r.properties[h]};if(("complex"===f.type||"multiplecomplex"===f.type)&&f.value&&f.value.length>0)try{f.value=JSON.parse(f.value)}catch(e){}void 0!==p.readModeTemplateUrl&&null!==p.readModeTemplateUrl&&(f.readModeTemplateUrl=p.readModeTemplateUrl+"?version="+e.staticIncludeVersion),null!==p.writeModeTemplateUrl&&null!==p.writeModeTemplateUrl&&(f.writeModeTemplateUrl=p.writeModeTemplateUrl+"?version="+e.staticIncludeVersion),void 0!==p.templateUrl&&null!==p.templateUrl?(f.templateUrl=p.templateUrl+"?version="+e.staticIncludeVersion,f.hasReadWriteMode=!1):f.hasReadWriteMode=!0,void 0!==f.value&&null!==f.value&&0!=f.value.length||(f.noValue=!0),s.properties.push(f)}}}t.safeApply((function(){t.selectedItem=s,t.selectedShape=r}))}else t.safeApply((function(){t.selectedItem={},t.selectedShape=null}))})),t.editor.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,(function(e){KISBPM.eventBus.dispatch(KISBPM.eventBus.EVENT_TYPE_HIDE_SHAPE_BUTTONS);var i=e.elements;if(i&&1==i.length){var n=i.first(),a=t.editor.getCanvas().node.getScreenCTM(),r=n.absoluteXY();r.x*=a.a,r.y*=a.d;var o=1;if(!isNaN(screen.logicalXDPI)&&!isNaN(screen.systemXDPI))if(navigator.userAgent.indexOf("MSIE")>=0){var s=Math.round(screen.deviceXDPI/screen.logicalXDPI*100);100!==s&&(o=s/100)}if(1===o)r.y=r.y-jQuery("#canvasSection").offset().top+5,r.x=r.x-jQuery("#canvasSection").offset().left;else{var d=jQuery("#canvasSection").offset().left,l=jQuery("#canvasSection").scrollLeft(),c=jQuery("#canvasSection").scrollTop(),h=a.e-d*o,p=0;h>10&&(p=h/o-h),r.y=r.y-jQuery("#canvasSection").offset().top*o+5+(c*o-c),r.x=r.x-d*o+p+(l*o-l)}var f=new ORYX.Core.Bounds(a.e+r.x,a.f+r.y,a.e+r.x+a.a*n.bounds.width(),a.f+r.y+a.d*n.bounds.height()),u=f.upperLeft(),g=t.getStencilItemById(n.getStencil().idWithoutNs()),v=[];if(g&&g.morphRole)for(var S=0;S<t.morphRoles.length;S++)t.morphRoles[S].role===g.morphRole&&(v=t.morphRoles[S].morphOptions);var y=u.x;f.width()<48&&(y-=24);var C=jQuery("#canvasSection").scrollTop(),m=jQuery("#canvasSection").scrollLeft();if(v&&v.length>0&&"ExclusiveGateway"!=g.id&&"DeriveEvent"!=g.id){var E=document.getElementById("morph-button");E.style.display="block";var I=i[0]._labels.values()[0];if("SequenceFlow"==g.id){if(n.incoming.length){var O=t.getStencilItemById(n.incoming.first().getStencil().idWithoutNs());if(O&&("StartNoneEvent"==O.id||"DeriveEvent"==O.id))return void(E.style.display="none")}E.style.left=I.x+102-m+"px",jQuery(".step-guide").length?E.style.top=I.y+36-C+"px":E.style.top=I.y+2-C+"px"}else E.style.left=y+136+"px",jQuery(".step-guide").length?E.style.top=u.y+36+"px":E.style.top=u.y+6+"px"}var R=document.getElementById("delete-button");if(R.style.display="block","SequenceFlow"==g.id?(R.style.left=I.x+78-m+"px",jQuery(".step-guide").length?R.style.top=I.y+36-C+"px":R.style.top=I.y+2-C+"px"):(R.style.left=y+112+"px",jQuery(".step-guide").length?R.style.top=u.y+36+"px":R.style.top=u.y+6+"px"),"DeriveEvent"==g.id)return void(n.outgoing.length&&(R.style.display="none"));if(g&&(g.canConnect||g.canConnectAssociation)){var N=0,T=0,P=0;jQuery(".step-guide").length?(T=u.x+f.width()+2,P=u.y+57):(T=u.x+f.width()+2,P=u.y+25);var _=T,x=P,k="StartNoneEvent"==v[0].id;jQuery(".Oryx_button").each((function(e,t){(!k||"CountSignEvent"!=t.id&&"DeriveEvent"!=t.id)&&"morph-button"!==t.id&&"delete-button"!=t.id&&(2==++N?_=T+24:3==N?(x=P+24,_=T):4==N&&(_=T+24,x=P+24),_+=97,t.style.display="block",t.style.left=_+"px",t.style.top=x+"px")}))}}})),e.stencilInitialized||(KISBPM.eventBus.addListener(KISBPM.eventBus.EVENT_TYPE_HIDE_SHAPE_BUTTONS,(function(e){jQuery(".Oryx_button").each((function(e,t){t.style.display="none"}))})),KISBPM.eventBus.addListener(KISBPM.eventBus.EVENT_TYPE_PROPERTY_VALUE_CHANGED,(function(e){e.property&&e.property.key&&("oryx-name"===e.property.key&&void 0!==t.selectedItem&&null!==t.selectedItem&&(t.selectedItem.title=e.newValue),e.property.noValue=void 0===e.property.value||null===e.property.value||0==e.property.value.length)})),e.stencilInitialized=!0),t.morphShape=function(){t.safeApply((function(){var t=e.editor.getSelection();if(t&&1==t.length){e.currentSelectedShape=t.first();var i=e.currentSelectedShape,n=i.resourceId,a=i.getStencil().id(),r=i.properties["oryx-name"],o="";if(a)if(a.indexOf("StartNoneEvent")>=0)o="start-state";else if(a.indexOf("ExclusiveGateway")>=0)o="decision";else if(a.indexOf("UserTask")>=0)o="state";else if(a.indexOf("EndNoneEvent")>=0)o="end-state";else if(a.indexOf("SequenceFlow")>=0){var s=i.incoming.first().getStencil().id(),d=i.outgoing.first().getStencil().id();o=s.indexOf("ExclusiveGateway")>=0?"forking":d.indexOf("DeriveEvent")>=0?"derive":d.indexOf("CountSignEvent")>=0?"countSign":"common"}jQuery.ajax({cache:!0,type:"POST",url:"/instance/getNodeOrTranById",data:{id:n,objectType:jQuery("#objectType").val(),workflowId:jQuery("#workflowId").val(),nodeOrTranType:o,name:r},async:!1,success:function(e){if(jQuery("#nodeOrTranType").val(o),jQuery("#nodeOrTranId").val(e.id),e)if("state"==o||"end-state"==o){var t=jQuery("#curNode");t.attr("curId",e.id),t.find(".header .title").text(e.name);var i=t.find('input[name="emailRole"]');i.attr("checked",!1),e.emailRole&&i.each((function(){e.emailRole.indexOf(jQuery(this).val())>=0&&jQuery(this).click()}));var n=t.find('input[name="notifyRole"]');n.attr("checked",!1),e.notifyRole&&n.each((function(){e.notifyRole.indexOf(jQuery(this).val())>=0&&jQuery(this).click()}));var a=t.find('input[name="rejectRole"]');a.attr("checked",!1),"end-state"==o?(t.find('.field-li[field="canUpdateFile"]').addClass("first"),t.find('.field-li[field="rejectRole"]').hide(),t.find('.field-li[field="pageSet"]').css("width","33.333%"),t.find('.field-li[field="exeCls"]').css("width","100%")):(t.find('.field-li[field="canUpdateFile"]').removeClass("first"),t.find('.field-li[field="rejectRole"]').show(),t.find('.field-li[field="pageSet"]').css("width","33.333%"),t.find('.field-li[field="exeCls"]').css("width","66.667%"),e.rejectRole&&a.each((function(){e.rejectRole.indexOf(jQuery(this).val())>=0&&jQuery(this).click()})));var r=t.find('.lcs_check[name="canUpdateFile"]');r.lcs_off(),e.canUpdateFile&&"Y"==e.canUpdateFile&&r.lcs_on();var s=t.find('.lcs_check[name="canUpdateRelate"]');s.lcs_off(),e.canUpdateRelate&&"Y"==e.canUpdateRelate&&s.lcs_on(),(f=t.find(".pageTitle")).attr("id","").text(""),e.workflowPageId?f.attr("id",e.workflowPageId).text(e.name+"页面"):f.text(e.name+"页面"),t.find('input[name="orderNum"]').val(e.orderNum),t.find('input[name="exeCls"]').val(e.exeCls),t.show()}else if("start-state"==o)openPageWindow(e.workflowPageId,e.name+"页面");else if("common"==o||"countSign"==o||"derive"==o){var d=jQuery("#curTran");d.attr("curId",e.id),d.find(".header .title").text(e.name);var l=d.find('input[name="operateRole"]');l.attr("checked",!1),e.operateRole&&l.each((function(){e.operateRole.indexOf(jQuery(this).val())>=0&&jQuery(this).click()})),d.find('input[name="synCondition"][value="'+e.synCondition+'"]').click(),d.find('input[name="pageTo"][value="'+e.pageTo+'"]').click();var c=d.find('.lcs_check[name="isSaveNodeUser"]');if(c.lcs_off(),"common"==o)d.find('.field-li[field="isSaveNodeUser"]').show(),d.find('.field-li[field="exeCls"]').css("width","66.667%"),e.isSaveNodeUser&&"Y"==e.isSaveNodeUser&&c.lcs_on(),d.find('.field-li[field="isOnlyOnce"]').hide(),d.find('.field-li[field="synCondition"]').show(),d.find('.field-li[field="hasSave"]').show(),d.find('.field-li[field="deriveObject"]').hide(),d.find('.field-li[field="dataMapping"]').hide();else if("countSign"==o)d.find('.field-li[field="isSaveNodeUser"]').hide(),d.find('.field-li[field="exeCls"]').css("width","33.333%"),d.find('.field-li[field="isOnlyOnce"]').show(),d.find('.field-li[field="synCondition"]').hide(),d.find('.field-li[field="hasSave"]').hide(),d.find('.field-li[field="deriveObject"]').hide(),d.find('.field-li[field="dataMapping"]').hide();else if("derive"==o){d.find('.field-li[field="isSaveNodeUser"]').hide(),d.find('.field-li[field="exeCls"]').css("width","66.667%"),d.find('.field-li[field="isOnlyOnce"]').show(),d.find('.field-li[field="synCondition"]').hide(),d.find('.field-li[field="hasSave"]').hide(),d.find('.field-li[field="dataMapping"]').show();var h=d.find('.field-li[field="deriveObject"]');h.show(),h.find('input[attrsign="_levelValue"]').val(e.deriveLevelValue),h.find(".form-control-select").val(e.deriveLevelText),jQuery.ajax({cache:!0,type:"POST",url:"/instance/getEntityOrWorkflowObject",data:{id:jQuery("#workflowId").val(),objectType:jQuery("#objectType").val()},async:!1,success:function(e){e&&h.find('input[attrsign="casCadeData"]').val(e)}})}var p=d.find('.lcs_check[name="isOnlyOnce"]');p.lcs_off(),e.isOnlyOnce&&"Y"==e.isOnlyOnce&&p.lcs_on();var f,u=d.find('.lcs_check[name="hasSave"]');u.lcs_off(),e.hasSave&&"Y"==e.hasSave&&u.lcs_on(),(f=d.find(".pageTitle")).attr("id","").text(""),e.workflowPageId?f.attr("id",e.workflowPageId).text(e.name+"页面"):f.text(e.name+"页面"),d.find('input[name="orderNum"]').val(e.orderNum),d.find('input[name="exeCls"]').val(e.exeCls),d.show()}else if("forking"==o){var g=jQuery("#curForking");g.attr("curId",e.id),g.find(".header .title").text(e.name),fieldList=e.fieldList,loadFilterFieldSelect(fieldList);var v=g.find('.field-li[field="filterCondition"]');v.css("width","66.667%").attr("value",e.conditions),v.find(".filter-from .row-condition").remove(),e.conditions&&initFilterCondition(e.conditions,v.find(".add-btns"));var S=g.find('.lcs_check[name="isDefaultForking"]');S.lcs_off(),e.isDefaultForking&&"Y"==e.isDefaultForking&&S.lcs_on(),g.show()}}})}}))},t.deleteShape=function(){KISBPM.TOOLBAR.ACTIONS.deleteItem({$scope:t})},t.quickAddItem=function(i){t.safeApply((function(){var n=e.editor.getSelection();if(n&&1==n.length){e.currentSelectedShape=n.first();for(var a=void 0,r=t.editor.getStencilSets().values(),o=0;o<r.length;o++)for(var s=r[o].nodes(),d=0;d<s.length;d++)if(s[d].idWithoutNs()===i){a=s[d];break}if(!a)return;var l={type:t.currentSelectedShape.getStencil().namespace()+i,namespace:t.currentSelectedShape.getStencil().namespace()};l.connectedShape=e.currentSelectedShape,l.parent=e.currentSelectedShape.parent,l.containedStencil=a;var c={sourceShape:e.currentSelectedShape,targetStencil:a},h=t.editor.getRules().connectMorph(c);if(!h)return;l.connectingType=h.id();var p=new KISBPM.CreateCommand(l,void 0,void 0,t.editor);t.editor.executeCommands([p])}}))}})),t.propertyClicked=function(e){t.selectedItem.properties[e].hidden||(t.selectedItem.properties[e].mode="write")},t.getPropertyTemplateUrl=function(e){return t.selectedItem.properties[e].templateUrl},t.getPropertyReadModeTemplateUrl=function(e){return t.selectedItem.properties[e].readModeTemplateUrl},t.getPropertyWriteModeTemplateUrl=function(e){return t.selectedItem.properties[e].writeModeTemplateUrl},t.updatePropertyInModel=function(e,i){var n=t.selectedShape;if(i&&(n=n.id!=i&&t.previousSelectedShape&&t.previousSelectedShape.id==i?t.previousSelectedShape:null),n){var a=e.key,r=e.value,o=n.properties[a];if(r!=o){var s=new(ORYX.Core.Command.extend({construct:function(){this.key=a,this.oldValue=o,this.newValue=r,this.shape=n,this.facade=t.editor},execute:function(){this.shape.setProperty(this.key,this.newValue),this.facade.getCanvas().update(),this.facade.updateSelection()},rollback:function(){this.shape.setProperty(this.key,this.oldValue),this.facade.getCanvas().update(),this.facade.updateSelection()}}));t.editor.executeCommands([s]),t.editor.handleEvents({type:ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,elements:[n],key:a}),e.mode="read";var d={type:KISBPM.eventBus.EVENT_TYPE_PROPERTY_VALUE_CHANGED,property:e,oldValue:o,newValue:r};KISBPM.eventBus.dispatch(d.type,d)}else e.mode="read"}},t.findStencilItemInGroup=function(e,i){for(var n,a=0;a<i.items.length;a++)if((n=i.items[a]).id===e)return n;if(i.groups&&i.groups.length>0)for(var r=0;r<i.groups.length;r++)if(n=t.findStencilItemInGroup(e,i.groups[r]))return n},t.getStencilItemById=function(e){for(var i=0;i<t.stencilItemGroups.length;i++){var n=t.stencilItemGroups[i];if(null!==n.items&&void 0!==n.items){var a=t.findStencilItemInGroup(e,n);if(a)return a}else if(n.id===e)return n}},t.dropCallback=function(e,i){if(t.editor.handleEvents({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeRepo.attached"}),t.editor.handleEvents({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeRepo.added"}),t.editor.handleEvents({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeMenu"}),KISBPM.eventBus.dispatch(KISBPM.eventBus.EVENT_TYPE_HIDE_SHAPE_BUTTONS),t.dragCanContain){var n=t.getStencilItemById(i.draggable[0].id),a={x:e.pageX,y:e.pageY},r=1;if(!isNaN(screen.logicalXDPI)&&!isNaN(screen.systemXDPI))if(navigator.userAgent.indexOf("MSIE")>=0){var o=Math.round(screen.deviceXDPI/screen.logicalXDPI*100);100!==o&&(r=o/100)}var s=t.editor.getCanvas().node.getScreenCTM();a.x-=s.e/r,a.y-=s.f/r,a.x/=s.a,a.y/=s.d,a.x-=document.documentElement.scrollLeft,a.y-=document.documentElement.scrollTop;var d=t.dragCurrentParent.absoluteXY();a.x-=d.x,a.y-=d.y;for(var l=void 0,c=t.editor.getStencilSets().values(),h=0;h<c.length;h++){for(var p=c[h],f=p.nodes(),u=0;u<f.length;u++)if(f[u].idWithoutNs()===i.draggable[0].id){l=f[u];break}if(!l){var g=p.edges();for(u=0;u<g.length;u++)if(g[u].idWithoutNs()===i.draggable[0].id){l=g[u];break}}}if(!l)return;if(t.quickMenu){var v=t.editor.getSelection();if(v&&1==v.length){var S=v.first();if((I={}).type=S.getStencil().namespace()+i.draggable[0].id,I.namespace=S.getStencil().namespace(),I.connectedShape=S,I.parent=t.dragCurrentParent,I.containedStencil=l,!e.ctrlKey){var y=S.bounds.center();20>Math.abs(y.x-a.x)&&(a.x=y.x),20>Math.abs(y.y-a.y)&&(a.y=y.y)}if(I.position=a,"SequenceFlow"!==l.idWithoutNs()&&"Association"!==l.idWithoutNs()&&"MessageFlow"!==l.idWithoutNs()&&"DataAssociation"!==l.idWithoutNs()){var C={sourceShape:S,targetStencil:l},m=t.editor.getRules().connectMorph(C);if(!m)return;I.connectingType=m.id()}var E=new KISBPM.CreateCommand(I,t.dropTargetElement,a,t.editor);t.editor.executeCommands([E])}}else{var I,O=!1;"BoundaryErrorEvent"!==l.idWithoutNs()&&"BoundaryTimerEvent"!==l.idWithoutNs()&&"BoundarySignalEvent"!==l.idWithoutNs()&&"BoundaryMessageEvent"!==l.idWithoutNs()&&"BoundaryCancelEvent"!==l.idWithoutNs()&&"BoundaryCompensationEvent"!==l.idWithoutNs()||(a=t.editor.eventCoordinates(e),O=!0),(I={}).type=t.modelData.model.stencilset.namespace+n.id,I.namespace=t.modelData.model.stencilset.namespace,I.position=a,I.parent=t.dragCurrentParent;var R=ORYX.Core.Command.extend({construct:function(e,t,i,n,a){this.option=e,this.docker=null,this.dockedShape=t,this.dockedShapeParent=t.parent||a.getCanvas(),this.position=n,this.facade=a,this.selection=this.facade.getSelection(),this.shape=null,this.parent=null,this.canAttach=i},execute:function(){this.shape?this.parent&&this.parent.add(this.shape):(this.shape=this.facade.createShape(I),this.parent=this.shape.parent),this.canAttach&&this.shape.dockers&&this.shape.dockers.length&&(this.docker=this.shape.dockers[0],this.dockedShapeParent.add(this.docker.parent),this.docker.setDockedShape(void 0),this.docker.bounds.centerMoveTo(this.position),this.dockedShape!==this.facade.getCanvas()&&this.docker.setDockedShape(this.dockedShape),this.facade.setSelection([this.docker.parent])),this.facade.getCanvas().update(),this.facade.updateSelection()},rollback:function(){this.shape&&(this.facade.setSelection(this.selection.without(this.shape)),this.facade.deleteShape(this.shape)),this.canAttach&&this.docker&&this.docker.setDockedShape(void 0),this.facade.getCanvas().update(),this.facade.updateSelection()}});E=new R(I,t.dragCurrentParent,O,a,t.editor);t.editor.executeCommands([E]);var N={type:KISBPM.eventBus.EVENT_TYPE_ITEM_DROPPED,droppedItem:n,position:a};KISBPM.eventBus.dispatch(N.type,N)}}t.dragCurrentParent=void 0,t.dragCurrentParentId=void 0,t.dragCurrentParentStencil=void 0,t.dragCanContain=void 0,t.quickMenu=void 0,t.dropTargetElement=void 0},t.overCallback=function(e,i){t.dragModeOver=!0},t.outCallback=function(e,i){t.dragModeOver=!1},t.startDragCallback=function(e,i){t.dragModeOver=!1,t.quickMenu=!1,i.helper.hasClass("stencil-item-dragged")||i.helper.addClass("stencil-item-dragged")},t.startDragCallbackQuickMenu=function(e,i){t.dragModeOver=!1,t.quickMenu=!0},t.dragCallback=function(e,i){if(0!=t.dragModeOver){var n=t.editor.eventCoordinatesXY(e.pageX,e.pageY),a=1;if(!isNaN(screen.logicalXDPI)&&!isNaN(screen.systemXDPI))if(navigator.userAgent.indexOf("MSIE")>=0){var r=Math.round(screen.deviceXDPI/screen.logicalXDPI*100);100!==r&&(a=r/100)}1!==a&&(n.x=n.x/a,n.y=n.y/a);var o=t.editor.getCanvas().getAbstractShapesAtPosition(n);if(o.length<=0&&e.helper)return t.dragCanContain=!1,!1;if(o[0]instanceof ORYX.Core.Canvas&&t.editor.getCanvas().setHightlightStateBasedOnX(n.x),1==o.length&&o[0]instanceof ORYX.Core.Canvas){var s=o[0];return t.dragCanContain=!0,t.dragCurrentParent=s,t.dragCurrentParentId=s.id,t.editor.handleEvents({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeRepo.attached"}),t.editor.handleEvents({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeRepo.added"}),!1}var d=t.getStencilItemById(e.target.id);if(!(s=o.reverse().find((function(e){return e instanceof ORYX.Core.Canvas||e instanceof ORYX.Core.Node||e instanceof ORYX.Core.Edge}))))return t.dragCanContain=!1,!1;if("node"===d.type){var l=!1,c=s.getStencil().id();if(t.dragCurrentParentId&&t.dragCurrentParentId===s.id)return!1;var h=t.getStencilItemById(s.getStencil().idWithoutNs());if(h.roles.indexOf("Activity")>-1?d.roles.indexOf("IntermediateEventOnActivityBoundary")>-1&&(l=!0):"Pool"===s.getStencil().idWithoutNs()&&"Lane"===d.id&&(l=!0),l)t.editor.handleEvents({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"shapeRepo.attached",elements:[s],style:ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_RECTANGLE,color:ORYX.CONFIG.SELECTION_VALID_COLOR}),t.editor.handleEvents({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeRepo.added"});else{for(var p=0;p<t.containmentRules.length;p++){var f=t.containmentRules[p];if(f.role===h.id){for(var u=0;u<f.contains.length;u++)if(d.roles.indexOf(f.contains[u])>-1){l=!0;break}if(l)break}}t.editor.handleEvents({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"shapeRepo.added",elements:[s],color:l?ORYX.CONFIG.SELECTION_VALID_COLOR:ORYX.CONFIG.SELECTION_INVALID_COLOR}),t.editor.handleEvents({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeRepo.attached"})}t.dragCurrentParent=s,t.dragCurrentParentId=s.id,t.dragCurrentParentStencil=c,t.dragCanContain=l}else{var g=t.editor.getCanvas(),v=!1,S=t.getStencilItemById(s.getStencil().idWithoutNs());if(S){var y=!1;"Association"!==stencil.idWithoutNs()||"TextAnnotation"!==curCan.getStencil().idWithoutNs()&&"BoundaryCompensationEvent"!==curCan.getStencil().idWithoutNs()?"DataAssociation"===stencil.idWithoutNs()&&"DataStore"===curCan.getStencil().idWithoutNs()&&(y=!0):y=!0,(S.canConnectTo||y)&&(v=!0)}t.dragCurrentParent=g,t.dragCurrentParentId=g.id,t.dragCurrentParentStencil=g.getStencil().id(),t.dragCanContain=v,t.editor.handleEvents({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"shapeRepo.added",elements:[g],color:ORYX.CONFIG.SELECTION_VALID_COLOR}),t.editor.handleEvents({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeRepo.attached"})}}},t.dragCallbackQuickMenu=function(e,i){if(0!=t.dragModeOver){var n=t.editor.eventCoordinatesXY(e.pageX,e.pageY),a=1;if(!isNaN(screen.logicalXDPI)&&!isNaN(screen.systemXDPI))if(navigator.userAgent.indexOf("MSIE")>=0){var r=Math.round(screen.deviceXDPI/screen.logicalXDPI*100);100!==r&&(a=r/100)}1!==a&&(n.x=n.x/a,n.y=n.y/a);var o=t.editor.getCanvas().getAbstractShapesAtPosition(n);if(o.length<=0&&e.helper)return t.dragCanContain=!1,!1;o[0]instanceof ORYX.Core.Canvas&&t.editor.getCanvas().setHightlightStateBasedOnX(n.x);for(var s=void 0,d=t.editor.getStencilSets().values(),l=0;l<d.length;l++){for(var c=d[l],h=c.nodes(),p=0;p<h.length;p++)if(h[p].idWithoutNs()===e.target.id){s=h[p];break}if(!s){var f=c.edges();for(p=0;p<f.length;p++)if(f[p].idWithoutNs()===e.target.id){s=f[p];break}}}var u=o.last(),g=!1;if("node"===s.type()){var v=t.editor.getRules().canContain({containingShape:u,containedStencil:s}),S=o.reverse().find((function(e){return e instanceof ORYX.Core.Canvas||e instanceof ORYX.Core.Node||e instanceof ORYX.Core.Edge}));if(!S)return t.dragCanContain=!1,!1;t.dragCurrentParent=S,t.dragCurrentParentId=S.id,t.dragCurrentParentStencil=S.getStencil().id(),t.dragCanContain=v,t.dropTargetElement=S,g=v}else{var y=t.editor.getSelection();if(y&&1==y.length){var C=y.first(),m=u,E=!1,I=t.getStencilItemById(m.getStencil().idWithoutNs());if(I){var O=!1;if("Association"!==s.idWithoutNs()||"TextAnnotation"!==m.getStencil().idWithoutNs()&&"BoundaryCompensationEvent"!==m.getStencil().idWithoutNs()?"DataAssociation"===s.idWithoutNs()&&"DataStore"===m.getStencil().idWithoutNs()&&(O=!0):O=!0,I.canConnectTo||O)for(;!E&&m&&!(m instanceof ORYX.Core.Canvas);)u=m,E=t.editor.getRules().canConnect({sourceShape:C,edgeStencil:s,targetShape:m}),m=m.parent}S=t.editor.getCanvas();g=E,t.dragCurrentParent=S,t.dragCurrentParentId=S.id,t.dragCurrentParentStencil=S.getStencil().id(),t.dragCanContain=E,t.dropTargetElement=u}}t.editor.handleEvents({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"shapeMenu",elements:[u],color:g?ORYX.CONFIG.SELECTION_VALID_COLOR:ORYX.CONFIG.SELECTION_INVALID_COLOR})}}}]);var KISBPM=KISBPM||{};function loadFilterFieldSelect(e){if(e){for(var t='<select class="selectpicker" name="selectField" data-live-search="true" data-live-search-style="begins" title="请选择" onchange="selectCondition(jQuery(this))">',i="",n="",a="",r="",o="",s="",d="",l=0;l<e.length;l++)d='\t<option type="'+e[l].htmlType+'" data-content="'+e[l].showName+'" value="'+e[l].id+'"></option>',"USER"==e[l].htmlType?i+=d:"DATE"==e[l].htmlType?n+=d:"SELECT"==e[l].htmlType||"RADIO"==e[l].htmlType||"CHECKBOX"==e[l].htmlType?a+=d:"NUMBER"==e[l].htmlType?r+=d:"TEXT"==e[l].htmlType||"AREA"==e[l].htmlType?o+=d:"PJT"!=e[l].htmlType&&"PRD"!=e[l].htmlType&&"DEPT"!=e[l].htmlType||(s+=d);t+='<optgroup label="用户">',t+=i,t+="</optgroup>",t+='<optgroup label="日期">',t+=n,t+="</optgroup>",t+='<optgroup label="选择框">',t+=a,t+="</optgroup>",t+='<optgroup label="数字">',t+=r,t+="</optgroup>",t+='<optgroup label="文本">',t+=o,t+="</optgroup>",t+='<optgroup label="其他">',t+=s,t+="</optgroup>",t+="</select>";var c=jQuery(".filter-btn .hide-select");c.html(t),c.find('select[name="selectField"]').selectpicker("refresh").show()}}KISBPM.CreateCommand=ORYX.Core.Command.extend({construct:function(e,t,i,n){this.option=e,this.currentReference=t,this.position=i,this.facade=n,this.shape,this.edge,this.targetRefPos,this.sourceRefPos,this.connectedShape=e.connectedShape,this.connectingType=e.connectingType,this.namespace=e.namespace,this.type=e.type,this.containedStencil=e.containedStencil,this.parent=e.parent,this.currentReference=t,this.shapeOptions=e.shapeOptions},execute:function(){if(this.shape?this.shape instanceof ORYX.Core.Node?(this.parent.add(this.shape),this.edge&&(this.facade.getCanvas().add(this.edge),this.edge.dockers.first().setDockedShape(this.connectedShape),this.edge.dockers.first().setReferencePoint(this.sourceRefPos),this.edge.dockers.last().setDockedShape(this.shape),this.edge.dockers.last().setReferencePoint(this.targetRefPos)),this.facade.setSelection([this.shape])):this.shape instanceof ORYX.Core.Edge&&(this.facade.getCanvas().add(this.shape),this.shape.dockers.first().setDockedShape(this.connectedShape),this.shape.dockers.first().setReferencePoint(this.sourceRefPos)):(this.shape=this.facade.createShape(this.option),this.edge=this.shape instanceof ORYX.Core.Edge?void 0:this.shape.getIncomingShapes().first()),this.currentReference&&this.position)if(this.shape instanceof ORYX.Core.Edge){if(this.currentReference instanceof ORYX.Core.Canvas)this.shape.dockers.last().bounds.centerMoveTo(this.position);else if(this.shape.dockers.last().setDockedShape(this.currentReference),"TextAnnotation"===this.currentReference.getStencil().idWithoutNs()){var e={x:0};e.y=this.currentReference.bounds.height()/2,this.shape.dockers.last().setReferencePoint(e)}else this.shape.dockers.last().setReferencePoint(this.currentReference.bounds.midPoint());this.sourceRefPos=this.shape.dockers.first().referencePoint,this.targetRefPos=this.shape.dockers.last().referencePoint}else this.edge&&(this.sourceRefPos=this.edge.dockers.first().referencePoint,this.targetRefPos=this.edge.dockers.last().referencePoint);else{var t=this.containedStencil,i=this.connectedShape.bounds,n=this.shape.bounds,a=i.center();"north"===t.defaultAlign()?a.y-=i.height()/2+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET+n.height()/2:"northeast"===t.defaultAlign()?(a.x+=i.width()/2+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+n.width()/2,a.y-=i.height()/2+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+n.height()/2):"southeast"===t.defaultAlign()?(a.x+=i.width()/2+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+n.width()/2,a.y+=i.height()/2+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+n.height()/2):"south"===t.defaultAlign()?a.y+=i.height()/2+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET+n.height()/2:"southwest"===t.defaultAlign()?(a.x-=i.width()/2+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+n.width()/2,a.y+=i.height()/2+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+n.height()/2):"west"===t.defaultAlign()?a.x-=i.width()/2+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET+n.width()/2:"northwest"===t.defaultAlign()?(a.x-=i.width()/2+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+n.width()/2,a.y-=i.height()/2+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+n.height()/2):a.x+=i.width()/2+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET+n.width()/2,this.shape.bounds.centerMoveTo(a),this.shape instanceof ORYX.Core.Node&&(this.shape.dockers||[]).each((function(e){e.bounds.centerMoveTo(a)})),this.position=a,this.edge&&(this.sourceRefPos=this.edge.dockers.first().referencePoint,this.targetRefPos=this.edge.dockers.last().referencePoint)}this.facade.getCanvas().update(),this.facade.updateSelection()},rollback:function(){this.facade.deleteShape(this.shape),this.edge&&this.facade.deleteShape(this.edge),this.facade.setSelection(this.facade.getSelection().without(this.shape,this.edge))}});