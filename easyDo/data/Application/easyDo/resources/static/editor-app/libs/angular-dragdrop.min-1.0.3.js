var jqyoui=angular.module("ngDragDrop",[]).service("ngDragDropService",["$timeout","$parse",function($timeout,$parse){this.callEventCallback=function(scope,callbackName,event,ui){if(callbackName){var args=[event,ui],match=callbackName.match(/^(.+)\((.+)\)$/);null!==match&&(callbackName=match[1],values=eval("["+match[0].replace(/^(.+)\(/,"").replace(/\)/,"")+"]"),args.push.apply(args,values)),scope[callbackName].apply(scope,args)}},this.invokeDrop=function(a,e,t,l){var i,n,r,o,s,u,c={},p={},d={},g=null,v=e.scope(),b=a.scope();i=a.attr("ng-model"),n=e.attr("ng-model"),s=b.$eval(i),u=v.$eval(n),g=e.find("[jqyoui-draggable]:last"),p=v.$eval(e.attr("jqyoui-droppable"))||[],(c=b.$eval(a.attr("jqyoui-draggable"))||[]).index=this.fixIndex(b,c,s),p.index=this.fixIndex(v,p,u),r=angular.isArray(s)?c.index:null,o=angular.isArray(s)?s[r]:s,d=angular.isArray(u)&&p&&void 0!==p.index?u[p.index]:angular.isArray(u)?{}:u,!0===c.animate?(this.move(a,g.length>0?g:e,null,"fast",p,null),this.move(g.length>0&&!p.multiple?g:[],a.parent("[jqyoui-droppable]"),jqyoui.startXY,"fast",p,function(){$timeout(function(){a.css({position:"relative",left:"",top:""}),g.css({position:"relative",left:"",top:""}),this.mutateDraggable(b,p,c,i,n,d,a),this.mutateDroppable(v,p,c,n,o,r),this.callEventCallback(v,p.onDrop,t,l)}.bind(this))}.bind(this))):$timeout(function(){this.mutateDraggable(b,p,c,i,n,d,a),this.mutateDroppable(v,p,c,n,o,r),this.callEventCallback(v,p.onDrop,t,l)}.bind(this))},this.move=function(a,e,t,l,i,n){if(0===a.length)return n&&window.setTimeout((function(){n()}),300),!1;var r=a.offset(),o=e&&e.is(":visible");null===t&&e.length>0&&(void 0!==e.attr("jqyoui-draggable")&&void 0!==e.attr("ng-model")&&e.is(":visible")&&i&&i.multiple?(t=e.offset(),!1===i.stack?t.left+=e.outerWidth(!0):t.top+=e.outerHeight(!0)):(t=e.css({visibility:"hidden",display:"block"}).offset(),e.css({visibility:"",display:o?"":"none"}))),a.css({position:"absolute","z-index":9999}).css(r).animate(t,l,(function(){n&&n()}))},this.mutateDroppable=function(a,e,t,l,i,n){var r=a.$eval(l);a.__dragItem=i,angular.isArray(r)?(e&&e.index>=0?r[e.index]=i:r.push(i),t&&!0===t.placeholder&&(r[r.length-1].jqyoui_pos=n)):($parse(l+" = __dragItem")(a),t&&!0===t.placeholder&&(r.jqyoui_pos=n))},this.mutateDraggable=function(a,e,t,l,i,n,r){var o=angular.equals(angular.copy(n),{}),s=a.$eval(l);a.__dropItem=n,t&&t.placeholder?"keep"!=t.placeholder&&(angular.isArray(s)&&void 0!==t.index?s[t.index]=n:$parse(l+" = __dropItem")(a)):angular.isArray(s)?o?t&&!0!==t.placeholder&&"keep"!==t.placeholder&&s.splice(t.index,1):s[t.index]=n:($parse(l+" = __dropItem")(a),a.$parent&&$parse(l+" = __dropItem")(a.$parent)),r.css({"z-index":"",left:"",top:""})},this.fixIndex=function(a,e,t){if(e.applyFilter&&angular.isArray(t)&&t.length>0){var l=a[e.applyFilter]()[e.index],i=void 0;return t.forEach((function(a,e){angular.equals(a,l)&&(i=e)})),i}return e.index}}]).directive("jqyouiDraggable",["ngDragDropService",function(a){return{require:"?jqyouiDroppable",restrict:"A",link:function(e,t,l){var i,n,r=function(r,o){r?(i=e.$eval(t.attr("jqyoui-draggable"))||[],t.draggable({disabled:!1}).draggable(e.$eval(l.jqyouiOptions)||{}).draggable({start:function(t,l){n=angular.element(this).css("z-index"),angular.element(this).css("z-index",99999),jqyoui.startXY=angular.element(this).offset(),a.callEventCallback(e,i.onStart,t,l)},stop:function(t,l){angular.element(this).css("z-index",n),a.callEventCallback(e,i.onStop,t,l)},drag:function(t,l){a.callEventCallback(e,i.onDrag,t,l)}})):t.draggable({disabled:!0})};e.$watch((function(){return e.$eval(l.drag)}),r),r()}}}]).directive("jqyouiDroppable",["ngDragDropService",function(a){return{restrict:"A",priority:1,link:function(e,t,l){var i=function(i,n){i?t.droppable({disabled:!1}).droppable(e.$eval(l.jqyouiOptions)||{}).droppable({over:function(t,l){var i=e.$eval(angular.element(this).attr("jqyoui-droppable"))||[];a.callEventCallback(e,i.onOver,t,l)},out:function(t,l){var i=e.$eval(angular.element(this).attr("jqyoui-droppable"))||[];a.callEventCallback(e,i.onOut,t,l)},drop:function(e,t){a.invokeDrop(angular.element(t.draggable),angular.element(this),e,t)}}):t.droppable({disabled:!0})};e.$watch((function(){return e.$eval(l.drop)}),i),i()}}}]);