"use strict";var KISBPM=KISBPM||{};function saveModelChange(e,o){showLoading();var n=e.$scope;n.status={loading:!0};var t=n.editor.getModelMetaData(),r=n.editor.getJSON();r.properties.process_id=t.signKey,r.properties.name=t.name,r=JSON.stringify(r);var i=n.editor.getSelection();n.editor.setSelection([]);var a=n.editor.getCanvas().getSVGRepresentation(!0);if(n.editor.setSelection(i),!1===n.editor.getCanvas().properties["oryx-showstripableelements"])for(var s=(c=jQuery(a).find(".stripable-element")).length-1;s>=0;s--)c[s].remove();var c;for(s=(c=jQuery(a).find(".stripable-element-force")).length-1;s>=0;s--)c[s].remove();var l={json_xml:r,svg_xml:DataManager.serialize(a),name:t.name,description:t.description,isChangeStatus:o};e.$http({method:"PUT",data:l,ignoreErrors:!0,headers:{Accept:"application/json","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},transformRequest:function(e){var o=[];for(var n in e)o.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return o.join("&")},url:KISBPM.URL.putModel(t.modelId)}).success((function(o,r,i,a){n.editor.handleEvents({type:ORYX.CONFIG.EVENT_SAVED}),n.modelData.name=t.name,n.modelData.lastUpdated=o.lastUpdated,n.status.loading=!1;var s={type:KISBPM.eventBus.EVENT_TYPE_MODEL_SAVED,model:l,modelId:t.modelId,eventType:"update-model"};KISBPM.eventBus.dispatch(KISBPM.eventBus.EVENT_TYPE_MODEL_SAVED,s),n.error=void 0,n.status.loading=!1,disabledSaveBtn(e),"function"==typeof successSave&&successSave(o)})).error((function(e,o,t,r){n.error={},console.log("Something went wrong when updating the process model:"+JSON.stringify(e)),n.status.loading=!1}))}function disabledSaveBtn(e){for(var o=0;o<e.$scope.items.length;o++){var n=e.$scope.items[o];"KISBPM.TOOLBAR.ACTIONS.saveModel"===n.action&&e.$scope.safeApply((function(){n.enabled=!1,jQuery("#isFlowChanged").val("N")}))}}KISBPM.TOOLBAR={ACTIONS:{saveModel:function(e){var o=jQuery("#status").val(),n=jQuery("#isEditNodeOrTran").val(),t=jQuery("#isPublish").val();if(!o||"RN"!=o||!n||"Y"!=n||t&&"N"!=t)saveModelChange(e,"N");else{hideLoading();var r=top.layer.confirm("本次修改内容保存后，需要重新发布才能正常使用，确定保存吗？",{btn:["确定","取消"]},(function(){saveModelChange(e,"Y"),jQuery("#status").val("SP"),top.layer.close(r)}),(function(){}))}},undo:function(e){var o=e.$scope.undoStack.pop();if(o){e.$scope.redoStack.push(o),e.$rootScope&&e.$rootScope.forceSelectionRefresh&&(e.$rootScope.forceSelectionRefresh=!0);for(var n=o.length-1;n>=0;--n)o[n].rollback();e.$scope.editor.handleEvents({type:ORYX.CONFIG.EVENT_UNDO_ROLLBACK,commands:o}),e.$scope.editor.getCanvas().update(),e.$scope.editor.updateSelection()}var t=!1;0==e.$scope.undoStack.length&&(t=!0);var r=!1;if(e.$scope.redoStack.length>0&&(r=!0),t||r)for(n=0;n<e.$scope.items.length;n++){var i=e.$scope.items[n];t&&"KISBPM.TOOLBAR.ACTIONS.undo"===i.action?e.$scope.safeApply((function(){i.enabled=!1,disabledSaveBtn(e)})):r&&"KISBPM.TOOLBAR.ACTIONS.redo"===i.action&&e.$scope.safeApply((function(){i.enabled=!0}))}},redo:function(e){var o=e.$scope.redoStack.pop();o&&(e.$scope.undoStack.push(o),e.$rootScope&&e.$rootScope.forceSelectionRefresh&&(e.$rootScope.forceSelectionRefresh=!0),o.each((function(e){e.execute()})),e.$scope.editor.handleEvents({type:ORYX.CONFIG.EVENT_UNDO_EXECUTE,commands:o}),e.$scope.editor.getCanvas().update(),e.$scope.editor.updateSelection());var n=!1;e.$scope.undoStack.length>0&&(n=!0);var t=!1;if(0==e.$scope.redoStack.length&&(t=!0),n||t)for(var r=0;r<e.$scope.items.length;r++){var i=e.$scope.items[r];n&&"KISBPM.TOOLBAR.ACTIONS.undo"===i.action?e.$scope.safeApply((function(){i.enabled=!0})):t&&"KISBPM.TOOLBAR.ACTIONS.redo"===i.action&&e.$scope.safeApply((function(){i.enabled=!1}))}},cut:function(e){KISBPM.TOOLBAR.ACTIONS._getOryxEditPlugin(e.$scope).editCut();for(var o=0;o<e.$scope.items.length;o++){var n=e.$scope.items[o];"KISBPM.TOOLBAR.ACTIONS.paste"===n.action&&e.$scope.safeApply((function(){n.enabled=!0}))}},copy:function(e){KISBPM.TOOLBAR.ACTIONS._getOryxEditPlugin(e.$scope).editCopy();for(var o=0;o<e.$scope.items.length;o++){var n=e.$scope.items[o];"KISBPM.TOOLBAR.ACTIONS.paste"===n.action&&e.$scope.safeApply((function(){n.enabled=!0}))}},paste:function(e){KISBPM.TOOLBAR.ACTIONS._getOryxEditPlugin(e.$scope).editPaste()},deleteItem:function(e){KISBPM.TOOLBAR.ACTIONS._getOryxEditPlugin(e.$scope).editDelete()},addBendPoint:function(e){var o=KISBPM.TOOLBAR.ACTIONS._getOryxDockerPlugin(e.$scope),n=!o.enabledAdd();o.setEnableAdd(n),n?(o.setEnableRemove(!1),document.body.style.cursor="pointer"):document.body.style.cursor="default"},removeBendPoint:function(e){var o=KISBPM.TOOLBAR.ACTIONS._getOryxDockerPlugin(e.$scope),n=!o.enabledRemove();o.setEnableRemove(n),n?(o.setEnableAdd(!1),document.body.style.cursor="pointer"):document.body.style.cursor="default"},_getOryxEditPlugin:function(e){return void 0!==e.oryxEditPlugin&&null!==e.oryxEditPlugin||(e.oryxEditPlugin=new ORYX.Plugins.Edit(e.editor)),e.oryxEditPlugin},zoomIn:function(e){KISBPM.TOOLBAR.ACTIONS._getOryxViewPlugin(e.$scope).zoom([1+ORYX.CONFIG.ZOOM_OFFSET])},zoomOut:function(e){KISBPM.TOOLBAR.ACTIONS._getOryxViewPlugin(e.$scope).zoom([1-ORYX.CONFIG.ZOOM_OFFSET])},zoomActual:function(e){KISBPM.TOOLBAR.ACTIONS._getOryxViewPlugin(e.$scope).setAFixZoomLevel(1)},zoomFit:function(e){KISBPM.TOOLBAR.ACTIONS._getOryxViewPlugin(e.$scope).zoomFitToModel()},alignVertical:function(e){KISBPM.TOOLBAR.ACTIONS._getOryxArrangmentPlugin(e.$scope).alignShapes([ORYX.CONFIG.EDITOR_ALIGN_MIDDLE])},alignHorizontal:function(e){KISBPM.TOOLBAR.ACTIONS._getOryxArrangmentPlugin(e.$scope).alignShapes([ORYX.CONFIG.EDITOR_ALIGN_CENTER])},sameSize:function(e){KISBPM.TOOLBAR.ACTIONS._getOryxArrangmentPlugin(e.$scope).alignShapes([ORYX.CONFIG.EDITOR_ALIGN_SIZE])},closeEditor:function(e){var o=parent.layer.getFrameIndex(window.name);parent.layer.close(o),parent.reLoad()},_getOryxViewPlugin:function(e){return void 0!==e.oryxViewPlugin&&null!==e.oryxViewPlugin||(e.oryxViewPlugin=new ORYX.Plugins.View(e.editor)),e.oryxViewPlugin},_getOryxArrangmentPlugin:function(e){return void 0!==e.oryxArrangmentPlugin&&null!==e.oryxArrangmentPlugin||(e.oryxArrangmentPlugin=new ORYX.Plugins.Arrangement(e.editor)),e.oryxArrangmentPlugin},_getOryxDockerPlugin:function(e){return void 0!==e.oryxDockerPlugin&&null!==e.oryxDockerPlugin||(e.oryxDockerPlugin=new ORYX.Plugins.AddDocker(e.editor)),e.oryxDockerPlugin}}};